<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã“ã¨ã°äº‹å…¸</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #0f0a04; --paper: #f5f0e8; --paper2: #ede7d9;
    --accent: #7a2008; --accent2: #c4763a; --muted: #3a2e26;
    --border: #d4c9b0; --weak: #a8ccc0; --mid: #5a9e88;
    --strong: #2a6a50; --extreme: #0a2a1c; --tag-bg: #e8e0d0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--paper); color: var(--ink); font-family: 'Noto Sans JP', sans-serif; font-weight: 300; min-height: 100vh; }
  body::before { content: ''; position: fixed; inset: 0; background-image: radial-gradient(ellipse at 20% 50%, rgba(139,46,15,0.04) 0%, transparent 60%), radial-gradient(ellipse at 80% 20%, rgba(196,118,58,0.04) 0%, transparent 50%); pointer-events: none; }

  /* ã‚¿ãƒ–ãƒŠãƒ“ */
  .tab-nav { display: flex; border-bottom: 1px solid var(--border); background: rgba(245,240,232,0.97); backdrop-filter: blur(8px); position: sticky; top: 0; z-index: 99; padding: 0 28px; gap: 0; }
  .tab-btn { font-family: 'Noto Serif JP', serif; font-size: 13px; letter-spacing: 0.15em; padding: 14px 24px; border: none; background: transparent; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; margin-bottom: -1px; }
  .tab-btn:hover { color: var(--accent2); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-page { display: none !important; }
  .tab-page.active { display: block !important; }

  /* æ›¸ãå‡ºã—ãƒãƒ¼ãƒˆ */
  .note-page { max-width: 1000px; margin: 0 auto; padding: 28px 20px; min-height: 200px; }
  .note-add-section { background: var(--paper2); border: 1px solid var(--border); border-radius: 2px; padding: 22px 26px; margin-bottom: 24px; position: relative; }
  .note-add-section::before { content: 'æ–°ã—ãè¿½åŠ ã™ã‚‹'; position: absolute; top: -10px; left: 20px; background: var(--paper2); padding: 0 8px; font-size: 11px; letter-spacing: 0.2em; color: var(--muted); }
  .note-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .note-form-full { margin-bottom: 12px; }
  .note-type-row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
  .note-type-label { font-size: 11px; letter-spacing: 0.15em; color: var(--muted); }
  .type-track { display: flex; border: 1px solid var(--border); border-radius: 2px; overflow: hidden; }
  .type-btn { padding: 5px 14px; font-size: 11px; font-family: 'Noto Sans JP', sans-serif; letter-spacing: 0.1em; border: none; background: var(--paper); color: var(--muted); cursor: pointer; transition: all 0.15s; border-right: 1px solid var(--border); }
  .type-btn:last-child { border-right: none; }
  .type-btn.active { background: var(--accent); color: #fff; }
  textarea.note-text-input { min-height: 90px; resize: vertical; font-size: 13px; line-height: 1.8; letter-spacing: 0.02em; }
  textarea.note-memo-input { min-height: 50px; resize: vertical; font-size: 12px; }

  /* ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
  .note-filters { display: flex; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
  .notes-grid { display: flex; flex-direction: column; gap: 14px; }
  .note-card { background: var(--paper); border: 1px solid var(--border); border-radius: 2px; padding: 20px 22px; transition: box-shadow 0.2s; position: relative; }
  .note-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.07); }
  .note-card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
  .note-card-left { display: flex; flex-direction: column; gap: 5px; }
  .note-work { font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 400; color: var(--ink); }
  .note-card-tags { display: flex; gap: 4px; flex-wrap: wrap; }
  .note-type-badge { font-size: 10px; padding: 2px 8px; border-radius: 1px; }
  .type-open { background: #e0eef8; color: #2a5a7a; }
  .type-close { background: #f0e8f8; color: #5a2a7a; }
  .type-both { background: #e8f0e0; color: #3a5a2a; }
  .note-genre-tag { font-size: 10px; padding: 2px 7px; border-radius: 1px; background: var(--tag-bg); color: var(--muted); }
  .note-user-tag { font-size: 10px; padding: 2px 7px; border-radius: 10px; background: #f0ece0; color: #6a5030; }
  .note-card-actions { display: flex; gap: 4px; flex-shrink: 0; }
  .note-text-display { font-size: 13px; line-height: 1.9; letter-spacing: 0.03em; color: var(--ink); background: var(--paper2); border-left: 3px solid var(--accent2); padding: 12px 16px; margin-bottom: 10px; border-radius: 0 2px 2px 0; white-space: pre-wrap; font-family: 'Noto Serif JP', serif; }
  .note-pattern { font-size: 12px; color: var(--accent); line-height: 1.7; margin-bottom: 6px; }
  .note-pattern::before { content: 'ğŸ“Œ '; }
  .note-self-memo { font-size: 11px; color: var(--muted); font-style: italic; line-height: 1.6; }
  .note-self-memo::before { content: 'âœ '; }
  .note-date { font-size: 10px; color: var(--border); margin-top: 8px; letter-spacing: 0.05em; }

  /* ã‚«ãƒ¼ãƒ‰ç©ºçŠ¶æ…‹ */
  .note-empty { text-align: center; padding: 50px; color: var(--muted); }
  .note-empty .icon { font-size: 36px; margin-bottom: 14px; opacity: 0.4; }
  .note-empty p { font-size: 13px; letter-spacing: 0.1em; line-height: 2.2; }

  header { border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(245,240,232,0.97); backdrop-filter: blur(8px); position: sticky; top: 0; z-index: 100; gap: 10px; flex-wrap: nowrap; overflow-x: auto; }
  .logo { font-family: 'Noto Serif JP', serif; font-size: 20px; font-weight: 600; letter-spacing: 0.15em; color: var(--accent); }
  .logo span { font-size: 9px; font-weight: 300; color: var(--muted); display: block; letter-spacing: 0.15em; margin-top: 1px; white-space: nowrap; }
  .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .header-stats { font-size: 12px; color: var(--muted); letter-spacing: 0.1em; }
  .btn-fav-filter { font-size: 11px; padding: 4px 12px; border: 1px solid var(--border); border-radius: 1px; background: transparent; color: var(--muted); cursor: pointer; letter-spacing: 0.1em; transition: all 0.15s; }
  .btn-fav-filter.active { background: #f5d04a; border-color: #c4a020; color: #6a4a10; }

  .main { max-width: 1400px; margin: 0 auto; padding: 24px 20px; }

  /* APIã‚­ãƒ¼ */
  .api-key-notice { background: #fdf8ee; border: 1px solid #e8d8a0; border-radius: 2px; padding: 14px 18px; font-size: 12px; color: #6a5a2a; margin-bottom: 18px; letter-spacing: 0.05em; line-height: 1.8; }
  .api-key-notice strong { color: var(--accent); }
  .api-key-row { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
  .api-key-row input { flex: 1; font-family: monospace; font-size: 12px; }

  /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
  .input-section { background: var(--paper2); border: 1px solid var(--border); border-radius: 2px; padding: 20px 24px; margin-bottom: 20px; position: relative; }
  .input-section::before { content: 'èªã‚’è¿½åŠ ã™ã‚‹'; position: absolute; top: -10px; left: 20px; background: var(--paper2); padding: 0 8px; font-size: 11px; letter-spacing: 0.2em; color: var(--muted); }

  .mode-row { display: flex; align-items: center; margin-bottom: 14px; gap: 12px; }
  .mode-track { display: flex; border: 1px solid var(--border); border-radius: 2px; overflow: hidden; }
  .mode-btn { padding: 6px 16px; font-size: 12px; font-family: 'Noto Sans JP', sans-serif; letter-spacing: 0.15em; border: none; background: var(--paper); color: var(--muted); cursor: pointer; transition: all 0.15s; border-right: 1px solid var(--border); }
  .mode-btn:last-child { border-right: none; }
  .mode-btn.active { background: var(--ink); color: var(--paper); }
  .mode-desc { font-size: 11px; color: var(--muted); font-style: italic; }

  .input-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
  .input-group { display: flex; flex-direction: column; gap: 5px; }
  .input-group.grow { flex: 1; min-width: 200px; }
  .input-group label { font-size: 11px; letter-spacing: 0.15em; color: var(--muted); }

  input[type="text"], select, textarea { background: var(--paper); border: 1px solid var(--border); border-radius: 1px; padding: 8px 12px; font-family: 'Noto Sans JP', sans-serif; font-size: 14px; font-weight: 300; color: var(--ink); outline: none; transition: border-color 0.2s; width: 100%; }
  input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--accent2); }

  /* æ¿ƒã•ç”Ÿæˆ */
  .density-row { display: flex; align-items: center; gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); flex-wrap: wrap; }
  .density-label { font-size: 11px; letter-spacing: 0.15em; color: var(--muted); white-space: nowrap; }
  .density-track { display: flex; border: 1px solid var(--border); border-radius: 2px; overflow: hidden; }
  .density-btn { padding: 5px 13px; font-size: 11px; font-family: 'Noto Sans JP', sans-serif; letter-spacing: 0.1em; border: none; background: var(--paper); color: var(--muted); cursor: pointer; transition: all 0.15s; border-right: 1px solid var(--border); }
  .density-btn:last-child { border-right: none; }
  .density-btn.active { background: var(--accent2); color: #fff; }
  .density-hint { font-size: 11px; color: var(--muted); font-style: italic; }

  /* ãƒãƒƒãƒ— */
  .chip-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
  .chip-label { font-size: 11px; color: var(--muted); letter-spacing: 0.1em; white-space: nowrap; }
  .chip { font-size: 11px; padding: 3px 10px; border: 1px solid var(--border); border-radius: 10px; color: var(--muted); cursor: pointer; transition: all 0.15s; background: var(--paper); }
  .chip:hover { border-color: var(--accent2); color: var(--accent2); }
  .chip.history { border-style: dashed; }

  /* å±¥æ­´ */
  .history-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; align-items: center; }

  .btn { padding: 8px 20px; border: none; border-radius: 1px; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; font-size: 13px; font-weight: 400; letter-spacing: 0.1em; transition: all 0.2s; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: #f5f0e8; }
  .btn-primary:hover { background: #a03510; }
  .btn-primary:disabled { background: var(--muted); cursor: not-allowed; }
  .btn-secondary { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent2); color: var(--accent2); }

  /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  .filter-section { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; row-gap: 6px; }
  .filter-panel { background:var(--bg); padding: 8px 0 10px; margin-bottom: 8px; border-bottom: 1px solid var(--border); }
  .filter-panel.collapsed { display: none; }
  .search-wrap { position: relative; flex: 1; min-width: 160px; }
  .search-wrap input { padding-left: 28px; }
  .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 13px; pointer-events: none; }
  .filter-select { min-width: 80px; font-size: 12px; padding: 5px 8px; }
  .count-badge { font-size: 11px; color: var(--muted); letter-spacing: 0.1em; white-space: nowrap; }

  /* æ¿ƒã•ãƒã‚§ãƒƒã‚¯ */
  .density-check-group { display: flex; border: 1px solid var(--border); border-radius: 1px; overflow: hidden; }
  .dcheck { display: flex; align-items: center; cursor: pointer; }
  .dcheck input { display: none; }
  .dcheck span { padding: 5px 8px; font-size: 11px; font-family: 'Noto Sans JP', sans-serif; letter-spacing: 0.05em; color: var(--muted); background: var(--paper); border-right: 1px solid var(--border); transition: all 0.15s; white-space: nowrap; }
  .dcheck:last-child span { border-right: none; }
  .dcheck input:checked + span { background: var(--accent2); color: #fff; }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { font-family: 'Noto Serif JP', serif; font-weight: 400; font-size: 11px; letter-spacing: 0.2em; color: var(--muted); text-align: left; padding: 7px 9px; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
  td:first-child { width: 32px; }
  td:nth-child(2) { min-width: 80px; width: 100px; }
  td:nth-child(3) { width: 60px; }
  td:nth-child(4) { width: 55px; }
  thead th:hover { color: var(--accent2); }
  tbody tr { border-bottom: 1px solid rgba(212,201,176,0.4); transition: background 0.15s; }
  tbody tr:hover { background: rgba(237,231,217,0.5); }
  tbody td { padding: 8px 6px; vertical-align: middle; line-height: 1.6; }
  tbody td:first-child { padding: 8px 2px 8px 6px; width: 24px; }
  tbody td:nth-child(2) { padding-left: 4px; min-width: 80px; width: 100px; }

  .word-main { font-family: 'Noto Serif JP', serif; font-size: 16px; font-weight: 400; }
  .word-reading { font-size: 10px; color: var(--ink); opacity:0.65; letter-spacing: 0.05em; margin-top: 1px; }

  .strength-bar { display: flex; flex-direction: column; align-items: center; gap: 2px; justify-content: center; }
  .strength-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); }
  .strength-dot.active.lv1 { background: var(--weak); }
  .strength-dot.active.lv2 { background: var(--mid); }
  .strength-dot.active.lv3 { background: var(--strong); }
  .strength-dot.active.lv4 { background: var(--extreme); }
  .strength-label { font-size: 9px; color: var(--muted); margin-top: 1px; }

  .density-badge { display: inline-block; font-size: 9px; padding: 3px 4px; border-radius: 1px; writing-mode: vertical-rl; text-orientation: mixed; letter-spacing: 0.1em; min-height: 38px; text-align: center; }
  .density-light { background: #e4f2ec; color: #2a6a50; font-weight:400; letter-spacing:0.05em; }
  .density-middle { background: #b8d8cc; color: #0a3a28; font-weight:600; letter-spacing:0.05em; }
  .density-deep { background: #3a7a60; color: #ffffff; font-weight:700; letter-spacing:0.05em; }

  .tags { display: flex; flex-wrap: wrap; gap: 3px; }
  .tag { padding: 2px 6px; border-radius: 1px; font-size: 10px; letter-spacing: 0.05em; white-space: nowrap; }
  .tag-hinshi { background: #dde8f0; color: #2a5a7a; }
  .tag-gokan { background: #e8e0f0; color: #5a3a7a; }
  .tag-buntai { background: #e8f0e0; color: #3a5a2a; }
  .tag-joyoudo-3 { background: #3a7a60; color: #ffffff; font-weight:700; }
  .tag-joyoudo-2 { background: #b8d8cc; color: #0a3a28; font-weight:600; }
  .tag-joyoudo-1 { background: #e4f2ec; color: #2a6a50; font-weight:400; }
  .joyoudo-cell { font-size: 10px; display: inline-block; padding: 3px 4px; border-radius: 2px; writing-mode: vertical-rl; text-orientation: mixed; letter-spacing: 0.1em; min-height: 36px; text-align: center; }
  .tag-scene { background: var(--tag-bg); color: var(--muted); }

  .example-text { color: var(--ink); line-height: 1.7; font-size: 12px; }
  .note-text { color: var(--accent); font-size: 11px; line-height: 1.6; margin-bottom: 3px; }
  .famous-text { color: #5a5a3a; font-size: 11px; line-height: 1.6; margin-bottom: 4px; font-style: italic; }

  /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ãƒ¡ãƒ¢ */
  .memo-cell { position: relative; }
  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚° */
  .user-tags-wrap { margin-top: 5px; display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
  .user-tag { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; background: #e8f0e0; color: #3a5a2a; border: 1px solid #c0d8b0; border-radius: 10px; padding: 2px 8px 2px 8px; cursor: default; white-space: nowrap; }
  .user-tag .tag-del { font-size: 9px; cursor: pointer; opacity: 0.6; margin-left: 2px; line-height: 1; }
  .user-tag .tag-del:hover { opacity: 1; }
  .user-tag-input { font-size: 10px; border: 1px dashed var(--border); border-radius: 10px; padding: 2px 8px; background: transparent; color: var(--ink); width: 80px; font-family: 'Noto Sans JP', sans-serif; }
  .user-tag-input:focus { border-color: #6a9a5a; outline: none; background: var(--paper); }
  .user-tag-input::placeholder { color: var(--border); font-size: 9px; }
  /* ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  .tag-filter-wrap { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .tag-filter-chip { font-size: 10px; background: var(--paper); border: 1px solid var(--border); border-radius: 10px; padding: 2px 10px; cursor: pointer; color: var(--muted); transition: all 0.15s; white-space: nowrap; }
  .tag-filter-chip.active { background: #3a5a2a; color: #fff; border-color: #3a5a2a; }
  .user-example-wrap { margin-top: 6px; }
  .user-example-input { width: 100%; font-size: 11px; font-family: 'Noto Serif JP', serif; color: var(--ink); border: 1px dashed var(--border); border-radius: 1px; padding: 4px 6px; resize: none; background: transparent; line-height: 1.7; transition: border-color 0.2s; }
  .user-example-input:focus { border-color: var(--accent2); outline: none; background: var(--paper); }
  .user-example-input::placeholder { color: var(--border); font-style: italic; font-size: 10px; font-family: 'Noto Sans JP', sans-serif; }
  .note-inline { font-size: 10px; color: var(--ink); margin: 3px 0 4px; line-height: 1.6; opacity: 0.85; }
  .memo-display { color: var(--muted); font-size: 11px; line-height: 1.6; font-style: italic; min-height: 18px; cursor: text; padding: 2px 4px; border-radius: 1px; border: 1px solid transparent; transition: border-color 0.15s; }
  .memo-display:hover { border-color: var(--border); }
  .memo-display.empty::before { content: 'ï¼‹ ãƒ¡ãƒ¢ã‚’è¿½åŠ '; color: var(--border); font-style: normal; font-size: 10px; }
  .memo-input { font-size: 11px; color: var(--muted); font-style: italic; border-color: var(--accent2) !important; min-height: 40px; resize: none; padding: 4px 6px; }

  /* ãŠæ°—ã«å…¥ã‚Š */
  .btn-fav { background: none; border: none; cursor: pointer; font-size: 15px; padding: 2px 1px; transition: transform 0.15s; line-height: 1; opacity: 0.3; display: block; margin: 0 auto; }
  .btn-fav.active { opacity: 1; }
  .btn-fav:hover { transform: scale(1.2); }
  .btn-delete { background: none; border: none; color: var(--border); cursor: pointer; font-size: 15px; padding: 2px 4px; transition: color 0.2s; line-height: 1; }
  .btn-delete:hover { color: var(--accent); }

  /* å¤–éƒ¨ãƒªãƒ³ã‚¯ */
  .ext-links { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
  .ext-link { font-size: 10px; color: var(--accent2); border: 1px solid var(--border); border-radius: 1px; padding: 1px 6px; text-decoration: none; letter-spacing: 0.05em; transition: all 0.15s; white-space: nowrap; }
  .ext-link:hover { background: var(--accent2); color: #fff; border-color: var(--accent2); }

  /* ãƒªãƒ³ã‚¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
  .link-popup-wrap { position: relative; display: inline-block; }
  .link-icon { background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 4px; opacity: 0.5; transition: opacity 0.15s; line-height: 1; }
  .link-icon:hover { opacity: 1; }
  .link-popup { display: none; position: absolute; left: 0; top: 22px; z-index: 200; background: var(--paper); border: 1px solid var(--border); border-radius: 2px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); min-width: 140px; overflow: hidden; }
  .link-popup.open { display: block; }
  .link-popup a { display: block; padding: 7px 14px; font-size: 11px; color: var(--ink); text-decoration: none; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); transition: background 0.1s; white-space: nowrap; }
  .link-popup a:last-child { border-bottom: none; }
  .link-popup a:hover { background: var(--paper2); color: var(--accent2); }
  .link-popup a span { font-size: 10px; color: var(--muted); margin-right: 6px; }

  .loading-row td { text-align: center; padding: 20px; color: var(--muted); font-size: 13px; letter-spacing: 0.1em; }
  .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { text-align: center; padding: 50px 24px; color: var(--muted); }
  .empty-state .empty-icon { font-size: 36px; margin-bottom: 14px; opacity: 0.4; }
  .empty-state p { font-size: 13px; letter-spacing: 0.1em; line-height: 2.2; }
  .empty-hint { font-size: 11px; color: var(--border); margin-top: 10px; }

  .error-msg { background: #fdf0ee; border: 1px solid #e8c0b8; border-radius: 2px; padding: 9px 13px; font-size: 12px; color: var(--accent); margin-top: 8px; }
  .footer-actions { margin-top: 18px; display: flex; gap: 8px; justify-content: flex-end; }
  .divider { height: 1px; background: var(--border); margin: 18px 0; opacity: 0.5; }

  @keyframes fadeInRow { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  .new-row { animation: fadeInRow 0.3s ease; }

  /* ãŠæ°—ã«å…¥ã‚Šè¡Œ */
  tr.fav-row { background: rgba(245,208,74,0.06); }
  /* å¼•ãå‡ºã—ãƒ‘ãƒãƒ« - fixed floating */
  .search-drawer {
    display: none;
    position: fixed;
    top: 96px;
    left: 0; right: 0;
    z-index: 400;
    background: #f5f0e8;
    border-bottom: 2px solid var(--accent2);
    padding: 16px 28px 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    max-height: 60vh;
    overflow-y: auto;
  }
  .search-drawer.open { display: block; }
  .drawer-tab { display: none; } /* æ—§ã‚¿ãƒ–ã¯éè¡¨ç¤º */
  /* å›ºå®šãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
  #drawerFloatBtn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 500;
    background: var(--accent2);
    color: #fff;
    border: none;
    border-radius: 24px;
    padding: 10px 20px;
    font-family: 'Noto Serif JP', serif;
    font-size: 13px;
    letter-spacing: 0.1em;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    transition: background 0.15s, transform 0.15s;
    white-space: nowrap;
  }
  #drawerFloatBtn:hover { transform: translateY(-2px); }
  .group-badge { font-size: 9px; color: var(--muted); letter-spacing: 0.05em; margin-top: 3px; opacity: 0.7; }
  .fav-folder-select { font-size: 10px; padding: 2px 4px; width: 90px; border: 1px solid var(--border); background: var(--paper); color: var(--ink); border-radius: 1px; margin-top: 3px; display: block; font-family: 'Noto Sans JP', sans-serif; cursor: pointer; }
</style>
</head>
<body>

<!-- ã‚¿ãƒ–ãƒŠãƒ“ -->
<nav class="tab-nav" style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;">
    <button class="tab-btn active" onclick="switchTab('dict-tab', this)">ã“ã¨ã°äº‹å…¸</button>
    <button class="tab-btn" onclick="switchTab('note-tab', this)">æ›¸ãå‡ºã—ãƒ»ç· ã‚æ–¹ãƒãƒ¼ãƒˆ</button>
  </div>
  <div style="position:relative;padding-right:12px;">
    <button class="btn btn-secondary" onclick="toggleLinkPanel()" style="font-size:11px;padding:4px 12px;white-space:nowrap;">ğŸ”— ãƒªãƒ³ã‚¯é›†</button>
    <div id="linkPanel" style="display:none;position:fixed;right:12px;top:96px;background:var(--paper);border:1px solid var(--border);border-radius:2px;padding:14px 16px;min-width:260px;z-index:500;box-shadow:0 4px 16px rgba(0,0,0,0.15);">
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;letter-spacing:0.1em;">ãƒ„ãƒ¼ãƒ«ãƒªãƒ³ã‚¯é›†</div>
      <div id="linkList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;"></div>
      <div style="border-top:1px solid var(--border);padding-top:10px;">
        <div style="font-size:10px;color:var(--muted);margin-bottom:6px;">ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </div>
        <div style="display:flex;gap:4px;margin-bottom:4px;">
          <input id="linkNewLabel" type="text" placeholder="åå‰" style="font-size:11px;width:80px;padding:4px 6px;border:1px solid var(--border);background:var(--paper);" />
          <input id="linkNewUrl" type="text" placeholder="URL" style="font-size:11px;flex:1;padding:4px 6px;border:1px solid var(--border);background:var(--paper);" />
          <button class="btn btn-primary" onclick="addToolLink()" style="font-size:11px;padding:4px 8px;">ï¼‹</button>
        </div>
      </div>
    </div>
  </div>
</nav>

<header>
  <div style="display:flex;align-items:center;gap:16px;flex:1;flex-wrap:nowrap;">
    <div class="logo">ã“ã¨ã°äº‹å…¸<span>è‡ªåˆ†ã§è‚²ã¦ã‚‹èªå½™ã®è¾å…¸</span></div>
    <div class="header-stats" id="headerStats" style="white-space:nowrap;">0 èªåéŒ²</div>
  </div>
  <div class="header-right" style="flex-wrap:nowrap;">
    <button class="btn-fav-filter" id="favFilterBtn" onclick="toggleFavFilter()" style="white-space:nowrap;">â˜… ãŠæ°—ã«å…¥ã‚Š</button>
    <select id="favFolderFilter" class="filter-select" onchange="filterTable()" style="font-size:11px;padding:4px 6px;min-width:80px;">
      <option value="">å…¨ãƒ•ã‚©ãƒ«ãƒ€</option>
    </select>
    <button class="btn-secondary btn" onclick="createFavFolder()" style="font-size:10px;padding:3px 7px;white-space:nowrap;" title="ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ">ğŸ“ï¼‹</button>
    <button class="btn-secondary btn" onclick="renameFavFolder()" style="font-size:10px;padding:3px 7px;white-space:nowrap;" title="ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´">ğŸ“âœ</button>
    <button class="btn-secondary btn" onclick="deleteFavFolder()" style="font-size:10px;padding:3px 7px;white-space:nowrap;" title="ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤">ğŸ“ï¼</button>
    <button class="btn-secondary btn" onclick="showApiSetting()" style="font-size:11px;padding:4px 10px;white-space:nowrap;">ğŸ”‘ APIè¨­å®š</button>
    <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--muted);white-space:nowrap;">
      <label style="display:flex;align-items:center;gap:3px;cursor:pointer;"><input type="radio" name="apiProvider" value="gemini" id="hdrGemini" onchange="switchProvider('gemini')"><span>Gemini</span></label>
      <label style="display:flex;align-items:center;gap:3px;cursor:pointer;"><input type="radio" name="apiProvider" value="anthropic" id="hdrClaude" onchange="switchProvider('anthropic')"><span>Claude</span></label>
    </div>
    <div id="providerBadge" style="display:none;"></div>
  </div>
</header>
<div id="dict-tab" class="tab-page active">
<div class="main">

  <div class="api-key-notice" id="apiKeyNotice">
    <strong>APIè¨­å®š</strong>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px;">
      <!-- Gemini -->
      <div style="background:var(--paper);border:1px solid var(--border);border-radius:2px;padding:14px 16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <input type="radio" name="apiProvider" value="gemini" id="radioGemini" onchange="switchProvider('gemini')" style="cursor:pointer;">
          <label for="radioGemini" style="font-size:13px;font-weight:500;cursor:pointer;color:var(--ink);">Gemini <span style="font-size:10px;color:var(--weak);border:1px solid var(--weak);border-radius:1px;padding:1px 5px;margin-left:4px;">ç„¡æ–™</span></label>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">
          <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent)">aistudio.google.com</a> ã§å–å¾—
        </div>
        <div style="display:flex;gap:6px;">
          <input type="text" id="geminiKeyInput" placeholder="AIza..." style="font-family:monospace;font-size:11px;flex:1;" />
          <button class="btn btn-primary" onclick="saveKey('gemini')" style="padding:6px 12px;font-size:11px;">ä¿å­˜</button>
        </div>
        <div id="geminiStatus" style="font-size:10px;margin-top:6px;color:var(--muted);"></div>
      </div>
      <!-- Claude -->
      <div style="background:var(--paper);border:1px solid var(--border);border-radius:2px;padding:14px 16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <input type="radio" name="apiProvider" value="anthropic" id="radioClaude" onchange="switchProvider('anthropic')" style="cursor:pointer;">
          <label for="radioClaude" style="font-size:13px;font-weight:500;cursor:pointer;color:var(--ink);">Claude <span style="font-size:10px;color:var(--accent2);border:1px solid var(--accent2);border-radius:1px;padding:1px 5px;margin-left:4px;">æœ‰æ–™</span></label>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">
          <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent)">console.anthropic.com</a> ã§å–å¾—
        </div>
        <div style="display:flex;gap:6px;">
          <input type="text" id="claudeKeyInput" placeholder="sk-ant-..." style="font-family:monospace;font-size:11px;flex:1;" />
          <button class="btn btn-primary" onclick="saveKey('anthropic')" style="padding:6px 12px;font-size:11px;">ä¿å­˜</button>
        </div>
        <div id="claudeStatus" style="font-size:10px;margin-top:6px;color:var(--muted);"></div>
      </div>
    </div>
    <div style="text-align:right;margin-top:12px;">
      <button class="btn btn-secondary" onclick="document.getElementById('apiKeyNotice').style.display='none'" style="font-size:11px;padding:5px 14px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="input-section">
    
<div id="searchDrawer" class="search-drawer">
  <div class="mode-row">
      <div class="mode-track">
        <button class="mode-btn" data-mode="dict" onclick="setMode(this)">è¾æ›¸ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="mode-btn active" data-mode="expand" onclick="setMode(this)">å±•é–‹ãƒ¢ãƒ¼ãƒ‰</button>
      </div>
      <span class="mode-desc" id="modeDesc">ã‚«ãƒ†ã‚´ãƒªãƒ»æ„Ÿæƒ…ãƒ»æƒ…æ™¯ã‹ã‚‰é¡èªã‚’ä¸€è¦§å±•é–‹</span>
    </div>

    <div class="input-row">
      <div class="input-group grow">
        <label id="inputLabel">ã‚«ãƒ†ã‚´ãƒªãƒ»æ„Ÿæƒ…ãƒ»èªãƒ»æƒ…æ™¯ã‚’å…¥åŠ›</label>
        <input type="text" id="queryInput" placeholder="ä¾‹ï¼šå–œã³ã€æ€’ã‚Šã€å¦‚æœˆã€é›¨ã®æå†™ã€æ­»æµ·æ–‡æ›¸â€¦" />
      </div>
      <div class="input-group" style="flex:0 0 95px" id="countWrap">
        <label>ä»¶æ•°</label>
        <select id="countSelect">
          <option value="5">5èª</option>
          <option value="8">8èª</option>
          <option value="8" selected>8èª</option>
          <option value="12">12èª</option>
          <option value="20">20èª</option>
        </select>
      </div>
      <button class="btn btn-primary" id="generateBtn" onclick="generate()">é¡èªã‚’å±•é–‹</button>
    </div>

    <div class="density-row" id="densityRow">
      <span class="density-label">æ–‡ä½“ã®æ¿ƒã•</span>
      <div class="density-track">
        <button class="density-btn" data-density="ãƒ©ã‚¤ãƒˆ" onclick="setDensity(this)">ãƒ©ã‚¤ãƒˆ</button>
        <button class="density-btn active" data-density="ãƒŸãƒ‰ãƒ«" onclick="setDensity(this)">ãƒŸãƒ‰ãƒ«</button>
        <button class="density-btn" data-density="ãƒ‡ã‚£ãƒ¼ãƒ—" onclick="setDensity(this)">ãƒ‡ã‚£ãƒ¼ãƒ—</button>
        <button class="density-btn" data-density="ã™ã¹ã¦" onclick="setDensity(this)">ã™ã¹ã¦</button>
      </div>
      <span class="density-hint" id="densityHint">ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå¹…åºƒã</span>
    </div>

    <div class="chip-row" id="chipRow">
      <span class="chip-label">ã‚ˆãä½¿ã†ï¼š</span>
      <span class="chip" onclick="quickInput('å–œã³')">å–œã³</span>
      <span class="chip" onclick="quickInput('æ€’ã‚Š')">æ€’ã‚Š</span>
      <span class="chip" onclick="quickInput('æ‚²ã—ã¿')">æ‚²ã—ã¿</span>
      <span class="chip" onclick="quickInput('æã‚Œ')">æã‚Œ</span>
      <span class="chip" onclick="quickInput('åˆ‡ãªã•')">åˆ‡ãªã•</span>
      <span class="chip" onclick="quickInput('é›¨ã®æå†™')">é›¨ã®æå†™</span>
      <span class="chip" onclick="quickInput('å¤œæ˜ã‘')">å¤œæ˜ã‘</span>
      <span class="chip" onclick="quickInput('å¦‚æœˆ')">å¦‚æœˆ</span>
      <span class="chip" onclick="quickInput('é¢¨ã®è¡¨ç¾')">é¢¨ã®è¡¨ç¾</span>
      <span class="chip" onclick="quickInput('æ²ˆé»™')">æ²ˆé»™</span>
    </div>

    <div class="history-row" id="historyRow" style="display:none">
      <span class="chip-label">å±¥æ­´ï¼š</span>
    </div>

    <div id="errorMsg"></div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div style="position:relative;background:var(--bg);padding:4px 0 2px;display:flex;gap:6px;align-items:center;">
    <button class="btn btn-secondary" onclick="toggleFilterPanel()" id="filterToggleBtn" style="font-size:11px;padding:4px 12px;white-space:nowrap;">ğŸ” çµã‚Šè¾¼ã¿</button>
    <button class="btn btn-secondary" onclick="clearFilters()" style="font-size:11px;padding:4px 8px;white-space:nowrap;opacity:0.7;">âœ•</button>
    <span class="count-badge" id="countBadge" style="font-size:11px;"></span>
  </div>
  <div id="filterPanel" class="filter-panel">
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
      <div class="search-wrap" style="flex:2;min-width:100px;">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="æ¤œç´¢â€¦" oninput="filterTable()" />
      </div>
      <select class="filter-select" id="filterCategory" onchange="filterTable()" style="flex:1;min-width:80px;">
        <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
      </select>
      <select class="filter-select" id="filterGroup" onchange="filterTable()" style="flex:1;min-width:90px;">
        <option value="">æ¤œç´¢ã‚°ãƒ«ãƒ¼ãƒ—</option>
      </select>
    </div>
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
      <select class="filter-select" id="filterStrength" onchange="filterTable()" style="width:54px;min-width:0;padding:5px 3px;">
        <option value="">å¼·åº¦</option>
        <option value="å¼±">å¼±</option><option value="ä¸­">ä¸­</option><option value="å¼·">å¼·</option><option value="æ¥µ">æ¥µ</option>
      </select>
      <select class="filter-select" id="filterAtmos" onchange="filterTable()" style="min-width:64px;max-width:130px;">
        <option value="">ç©ºæ°—æ„Ÿ</option>
        <option value="å–œ">å–œ ã‚ˆã‚ã“ã³ãƒ»é«˜æš</option>
        <option value="å“€">å“€ ã‹ãªã—ã¿ãƒ»åˆ‡ãªã•</option>
        <option value="æ€’">æ€’ ã„ã‹ã‚Šãƒ»æ†¤ã‚Š</option>
        <option value="æ">æ ãŠãã‚Œãƒ»ä¸å®‰</option>
        <option value="å­¤">å­¤ ã“ã©ããƒ»ç–å¤–</option>
        <option value="æ‡">æ‡ ãªã¤ã‹ã—ã•ãƒ»éƒ·æ„</option>
        <option value="è‰¶">è‰¶ è‰²æ°—ãƒ»ãªã¾ã‚ã‹ã—ã•</option>
        <option value="æ¸‹">æ¸‹ æ¯ã‚ŒãŸå‘³ã‚ã„ãƒ»ä¾˜ã³</option>
        <option value="å¹½">å¹½ ç¥ç§˜ãƒ»æ·±ã¿ãƒ»å¹½ç„</option>
        <option value="é™½">é™½ æ˜ã‚‹ã•ãƒ»è»½ã‚„ã‹ã•</option>
        <option value="é™">é™ ã—ãšã‘ã•ãƒ»ç©ã‚„ã‹</option>
        <option value="å³">å³ ãŠã”ãã‹ãƒ»è˜å³</option>
        <option value="ç‹‚">ç‹‚ æ··ä¹±ãƒ»ç‹‚æ°—ãƒ»é€¸è„±</option>
        <option value="å„š">å„š ã¯ã‹ãªã•ãƒ»ç„¡å¸¸</option>
        <option value="çƒˆ">çƒˆ æ¿€ã—ã•ãƒ»å³»çƒˆ</option>
      </select>
      <div class="density-check-group" id="filterDensity">
        <label class="dcheck"><input type="checkbox" value="ãƒ©ã‚¤ãƒˆ" onchange="filterTable()"><span>ãƒ©ã‚¤ãƒˆ</span></label>
        <label class="dcheck"><input type="checkbox" value="ãƒŸãƒ‰ãƒ«" onchange="filterTable()"><span>ãƒŸãƒ‰ãƒ«</span></label>
        <label class="dcheck"><input type="checkbox" value="ãƒ‡ã‚£ãƒ¼ãƒ—" onchange="filterTable()"><span>ãƒ‡ã‚£ãƒ¼ãƒ—</span></label>
      </div>
      <div class="density-check-group" id="filterCoreWide">
        <label class="dcheck"><input type="checkbox" value="ã‚³ã‚¢" onchange="filterTable()"><span>ã‚³ã‚¢</span></label>
        <label class="dcheck"><input type="checkbox" value="å¹…åºƒ" onchange="filterTable()"><span>å¹…åºƒ</span></label>
      </div>
    </div>
    <div style="margin-top:5px;">
      <div id="tagFilterWrap" class="tag-filter-wrap"></div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:28px"></th>
          <th onclick="sortBy('word')">èª</th>
          <th onclick="sortBy('strength')" style="width:36px;">å¼·åº¦</th>
          <th onclick="sortBy('density')" style="width:36px;">æ¿ƒã•</th>
          <th style="width:32px;">å¸¸ç”¨</th>
          <th>å“è©ãƒ»èªæ„Ÿãƒ»æ–‡ä½“</th>
          <th>ãƒªãƒ³ã‚¯</th>
          <th>ãƒ¡ãƒ¢ / è‡ªåˆ†ã®ä¾‹æ–‡</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="emptyState" class="empty-state">
    <div class="empty-icon">ğŸ“–</div>
    <p>æ„Ÿæƒ…ã€æƒ…æ™¯ã€èªã€æ¦‚å¿µã€ãªã‚“ã§ã‚‚å…¥åŠ›ã—ã¦<br>ã€Œé¡èªã‚’å±•é–‹ã€ã‚’æŠ¼ã™ã¨<br>ClaudeãŒè‡ªå‹•ã§ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™</p>
    <p class="empty-hint">ã€Œæ­»æµ·æ–‡æ›¸ã€â†’ç¥ç§˜ãƒ»å¤ä»£ãƒ»æ™‚é–“ã®èªå½™ã€€ï¼ã€€ã€Œå¦‚æœˆã€â†’å’Œæœˆãƒ»å­£ç¯€èªã€€ã«ã‚‚å¯¾å¿œ</p>
  </div>

  <div class="divider"></div>
  <div class="footer-actions">
    <button class="btn btn-secondary" onclick="clearAll()">ã™ã¹ã¦æ¶ˆå»</button>
    <button class="btn btn-secondary" onclick="exportCSV()">CSVæ›¸ãå‡ºã—</button>
  </div>
</div>

<script>
// â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let words = [];
let apiKey = '';
let sortKey = '';
let sortAsc = true;
let currentDensity = 'ãƒŸãƒ‰ãƒ«';
let currentMode = 'expand';
let showFavOnly = false;
let searchHistory = [];

const STRENGTH_ORDER = {'å¼±':1,'ä¸­':2,'å¼·':3,'æ¥µ':4};
const DENSITY_ORDER  = {'ãƒ©ã‚¤ãƒˆ':1,'ãƒŸãƒ‰ãƒ«':2,'ãƒ‡ã‚£ãƒ¼ãƒ—':3};
const DENSITY_HINTS  = {
  'ãƒ©ã‚¤ãƒˆ': 'å£èªãƒ»å’Œèªãƒ»å¹³æ˜“ãªè¡¨ç¾ã‚’å„ªå…ˆ',
  'ãƒŸãƒ‰ãƒ«': 'ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå¹…åºƒã',
  'ãƒ‡ã‚£ãƒ¼ãƒ—': 'æ–‡èªãƒ»æ¼¢èªãƒ»æ ¼èª¿ã‚ã‚‹è¡¨ç¾ã‚’å„ªå…ˆ',
  'ã™ã¹ã¦': 'æ¿ƒã•ã‚’å•ã‚ãšã™ã¹ã¦ã®è¡¨ç¾ã‚’åéŒ²'
};
const MODE_CONFIG = {
  dict: {
    desc: 'èªã‚’1ã¤æ·±æ˜ã‚Šã€‚èª­ã¿ãƒ»æ„å‘³ãƒ»é¡èªãƒ»æ³¨æ„ã‚’è©³ã—ãè¡¨ç¤º',
    label: 'èªã‚’å…¥åŠ›ï¼ˆ1èªï¼‰',
    placeholder: 'ä¾‹ï¼šç€Ÿæ´’ã€é€¡å·¡ã€æœ¨æ¼ã‚Œæ—¥ã€æ­»æµ·æ–‡æ›¸â€¦',
    btnText: 'èª¿ã¹ã‚‹'
  },
  expand: {
    desc: 'ã‚«ãƒ†ã‚´ãƒªãƒ»æ„Ÿæƒ…ãƒ»æƒ…æ™¯ãƒ»æ¦‚å¿µã‹ã‚‰é¡èªã‚’ä¸€è¦§å±•é–‹',
    label: 'ã‚«ãƒ†ã‚´ãƒªãƒ»æ„Ÿæƒ…ãƒ»èªãƒ»æƒ…æ™¯ã‚’å…¥åŠ›',
    placeholder: 'ä¾‹ï¼šå–œã³ã€æ€’ã‚Šã€å¦‚æœˆã€é›¨ã®æå†™ã€æ­»æµ·æ–‡æ›¸â€¦',
    btnText: 'é¡èªã‚’å±•é–‹'
  }
};

// â”€â”€ åˆæœŸåŒ–ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadStorage() {
  try {
    const saved = localStorage.getItem('kotoba_jiten_v2');
    if (saved) {
      const data = JSON.parse(saved);
      words = (data.words || []).map(w => ({ userTags: [], atmos: '', ...w }));
      searchHistory = data.history || [];
      notes = data.notes || [];
      geminiKey = data.geminiKey || data.apiKey || '';
      claudeKey = data.claudeKey || '';
      apiProvider = data.apiProvider || 'gemini';
      apiKey = apiProvider === 'gemini' ? geminiKey : claudeKey;
      favFolders = data.favFolders || [];
      toolLinks = data.toolLinks || toolLinks;
      if (apiKey) document.getElementById('apiKeyNotice').style.display = 'none';
    }
  } catch(e) {}
  updateFilterOptions();
  renderTable();
  updateStats();
  renderHistory();
  renderNotes();
  updateFavFolderOptions();
  updateProviderBadge();
  // ã‚­ãƒ¼ãŒ1ã¤ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°è¨­å®šç”»é¢ã‚’è¡¨ç¤º
  if (!geminiKey && !claudeKey) {
    document.getElementById('apiKeyNotice').style.display = 'block';
  } else {
    document.getElementById('apiKeyNotice').style.display = 'none';
  }
}

function saveStorage() {
  try {
    localStorage.setItem('kotoba_jiten_v2', JSON.stringify({
      words, history: searchHistory, notes, apiKey, apiProvider, geminiKey, claudeKey, favFolders, toolLinks
    }));
  } catch(e) {}
}

// â”€â”€ APIã‚­ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apiProvider = 'gemini';
let geminiKey = '';
let claudeKey = '';

function switchProvider(provider) {
  apiProvider = provider;
  updateProviderBadge();
  saveStorage();
}

function saveKey(provider) {
  if (provider === 'gemini') {
    const key = document.getElementById('geminiKeyInput').value.trim();
    if (!key.startsWith('AIza')) { alert('Geminiã®APIã‚­ãƒ¼ã¯ AIza ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™'); return; }
    geminiKey = key;
    apiKey = geminiKey;
    document.getElementById('geminiStatus').textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸ';
    document.getElementById('geminiStatus').style.color = 'var(--weak)';
  } else {
    const key = document.getElementById('claudeKeyInput').value.trim();
    if (!key.startsWith('sk-ant-')) { alert('Claudeã®APIã‚­ãƒ¼ã¯ sk-ant- ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™'); return; }
    claudeKey = key;
    apiKey = claudeKey;
    document.getElementById('claudeStatus').textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸ';
    document.getElementById('claudeStatus').style.color = 'var(--weak)';
  }
  // ä¿å­˜ã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
  apiProvider = provider;
  const radio = document.querySelector(`input[name="apiProvider"][value="${provider}"]`);
  if (radio) radio.checked = true;
  updateProviderBadge();
  saveStorage();
}

function updateProviderBadge() {
  apiKey = apiProvider === 'gemini' ? geminiKey : claudeKey;
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’åŒæœŸ
  const r = document.querySelector(`input[name="apiProvider"][value="${apiProvider}"]`);
  if (r) r.checked = true;
}

function showApiSetting() {
  const notice = document.getElementById('apiKeyNotice');
  notice.style.display = 'block';
  if (geminiKey) {
    document.getElementById('geminiKeyInput').value = geminiKey;
    document.getElementById('geminiStatus').textContent = 'âœ“ è¨­å®šæ¸ˆã¿';
    document.getElementById('geminiStatus').style.color = 'var(--weak)';
  }
  if (claudeKey) {
    document.getElementById('claudeKeyInput').value = claudeKey;
    document.getElementById('claudeStatus').textContent = 'âœ“ è¨­å®šæ¸ˆã¿';
    document.getElementById('claudeStatus').style.color = 'var(--weak)';
  }
  const radio = document.querySelector(`input[name="apiProvider"][value="${apiProvider}"]`);
  if (radio) radio.checked = true;
  notice.scrollIntoView({ behavior: 'smooth' });
}

// æ—§saveApiKeyäº’æ›ï¼ˆå¿µã®ãŸã‚æ®‹ã™ï¼‰
function saveApiKey() { saveKey(apiProvider); }
function updateApiUi() {}

// â”€â”€ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(btn) {
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentMode = btn.dataset.mode;
  const cfg = MODE_CONFIG[currentMode];
  document.getElementById('modeDesc').textContent = cfg.desc;
  document.getElementById('inputLabel').textContent = cfg.label;
  document.getElementById('queryInput').placeholder = cfg.placeholder;
  document.getElementById('generateBtn').textContent = cfg.btnText;
  const isDct = currentMode === 'dict';
  document.getElementById('countWrap').style.display = isDct ? 'none' : '';
  document.getElementById('densityRow').style.display = isDct ? 'none' : '';
  document.getElementById('chipRow').style.display = isDct ? 'none' : '';
}

function setDensity(btn) {
  document.querySelectorAll('.density-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentDensity = btn.dataset.density;
  document.getElementById('densityHint').textContent = DENSITY_HINTS[currentDensity];
}

function quickInput(text) {
  document.getElementById('queryInput').value = text;
  document.getElementById('queryInput').focus();
}

// â”€â”€ å±¥æ­´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addHistory(query) {
  searchHistory = [query, ...searchHistory.filter(h => h !== query)].slice(0, 12);
  renderHistory();
  saveStorage();
}

function renderHistory() {
  const row = document.getElementById('historyRow');
  if (searchHistory.length === 0) { row.style.display = 'none'; return; }
  row.style.display = 'flex';
  row.innerHTML = '<span class="chip-label">å±¥æ­´ï¼š</span>' +
    searchHistory.map(h =>
      `<span class="chip history" onclick="quickInput('${h.replace(/'/g,"\\'")}')">â†© ${h}</span>`
    ).join('');
}

// â”€â”€ ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generate() {
  const query = document.getElementById('queryInput').value.trim();
  if (!query) return;
  if (!apiKey) {
    document.getElementById('errorMsg').innerHTML = '<div class="error-msg">APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';
    return;
  }

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  btn.textContent = 'ç”Ÿæˆä¸­â€¦';
  document.getElementById('errorMsg').innerHTML = '';
  document.getElementById('emptyState').style.display = 'none';

  const tbody = document.getElementById('tableBody');
  const loadingRow = document.createElement('tr');
  loadingRow.className = 'loading-row';
  loadingRow.id = 'loadingRow';
  loadingRow.innerHTML = `<td colspan="11"><span class="spinner"></span>ClaudeãŒèªã‚’é›†ã‚ã¦ã„ã¾ã™â€¦</td>`;
  tbody.insertBefore(loadingRow, tbody.firstChild);

  const count = currentMode === 'dict' ? '5' : document.getElementById('countSelect').value;

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
  let prompt;
  if (currentMode === 'dict') {
    prompt = `Japanese vocabulary expert. Deep-diveã€Œ${query}ã€: entry 1=detailed analysis of the word itself, entries 2-5=near synonyms with varying intensity/nuance.
Focus on strength differences between synonyms. memoâ‰¤20chars. noteâ‰¤30chars(different from memo).
[{"word":"","reading":"","hinshi":"","category":"","subcategory":"ã‚³ã‚¢|å¹…åºƒ","strength":"å¼±|ä¸­|å¼·|æ¥µ","density":"ãƒ©ã‚¤ãƒˆ|ãƒŸãƒ‰ãƒ«|ãƒ‡ã‚£ãƒ¼ãƒ—","gokan":"","buntai":"","joyoudo":"â˜…â˜†â˜†|â˜…â˜…â˜†|â˜…â˜…â˜…","atmos":"","memo":"","note":""}]
atmos: pick 1-3 from[å–œ,å“€,æ€’,æ,å­¤,æ‡,è‰¶,æ¸‹,å¹½,é™½,é™,å³,ç‹‚,å„š,çƒˆ] or leave empty. JSON only.`;
  } else {
    const densityInstruction = {
      'ãƒ©ã‚¤ãƒˆ': 'Style=light: prefer colloquial/native Japanese, avoid kango/literary.',
      'ãƒŸãƒ‰ãƒ«': 'Style=middle: balance colloquial and literary.',
      'ãƒ‡ã‚£ãƒ¼ãƒ—': 'Style=deep: prefer literary/kango/classical expressions.',
      'ã™ã¹ã¦': 'Style=mixed: include light/middle/deep equally.'
    }[currentDensity];

    const half = Math.ceil(count / 2);
    prompt = `Japanese vocabulary expert. Output ${count} words related toã€Œ${query}ã€as JSON array.
Group: core(${half}) = central/representative words; wide(${count-half}) = peripheral/variants by intensity/nuance.
Words/compounds only, no phrases. ${densityInstruction}
subcategory="ã‚³ã‚¢"or"å¹…åºƒ". memoâ‰¤20chars. noteâ‰¤40chars(different from memo).
[{"word":"","reading":"","hinshi":"","category":"","subcategory":"ã‚³ã‚¢|å¹…åºƒ","strength":"å¼±|ä¸­|å¼·|æ¥µ","density":"ãƒ©ã‚¤ãƒˆ|ãƒŸãƒ‰ãƒ«|ãƒ‡ã‚£ãƒ¼ãƒ—","gokan":"","buntai":"","joyoudo":"â˜…â˜†â˜†|â˜…â˜…â˜†|â˜…â˜…â˜…","atmos":"","memo":"","note":""}]
atmos: pick 1-3 from[å–œ,å“€,æ€’,æ,å­¤,æ‡,è‰¶,æ¸‹,å¹½,é™½,é™,å³,ç‹‚,å„š,çƒˆ] or leave empty. JSON only.`;
  }

  try {
    let responseText = '';

    if (apiProvider === 'gemini') {
      // Gemini API
      const geminiRes = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { maxOutputTokens: 8192, temperature: 0.7, responseMimeType: 'application/json' }
          })
        }
      );
      if (!geminiRes.ok) { const err = await geminiRes.json(); throw new Error(err.error?.message || `Gemini APIã‚¨ãƒ©ãƒ¼: ${geminiRes.status}`); }
      const geminiData = await geminiRes.json();
      responseText = geminiData.candidates?.[0]?.content?.parts?.[0]?.text || '';
    } else {
      // Anthropic Claude API
      const claudeRes = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-5',
          max_tokens: 4000,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      if (!claudeRes.ok) { const err = await claudeRes.json(); throw new Error(err.error?.message || `Claude APIã‚¨ãƒ©ãƒ¼: ${claudeRes.status}`); }
      const claudeData = await claudeRes.json();
      responseText = claudeData.content?.[0]?.text || '';
    }

    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»ã—ã¦ã‹ã‚‰JSONã‚’æŠ½å‡º
    const cleaned = responseText.trim().replace(/```json/g, '').replace(/```/g, '');
    const jsonMatch = cleaned.match(/\[[\s\S]*\]/);
    if (!jsonMatch) throw new Error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
    let newWords;
    try {
      newWords = JSON.parse(jsonMatch[0]);
    } catch(parseErr) {
      // JSONä¿®å¾©ã‚’è©¦ã¿ã‚‹ï¼ˆæœ«å°¾ãŒé€”åˆ‡ã‚ŒãŸå ´åˆï¼‰
      const truncated = jsonMatch[0].replace(/,\s*{[^}]*$/, '') + ']';
      newWords = JSON.parse(truncated);
    }
    const existingWordSet = new Set(words.map(w => w.word));
    const skipped = [];
    const similar = [];
    newWords = newWords.filter(w => {
      if (existingWordSet.has(w.word)) { skipped.push(w.word); return false; }
      // éƒ¨åˆ†ä¸€è‡´ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜èªãŒæ–°èªã«å«ã¾ã‚Œã‚‹oré€†ï¼‰
      for (const ex of existingWordSet) {
        if (ex !== w.word && (ex.includes(w.word) || w.word.includes(ex))) {
          similar.push({ newWord: w.word, existing: ex });
        }
      }
      return true;
    });
    newWords.forEach(w => { w.id = Date.now() + Math.random(); w.isNew = true; w.fav = false; w.favFolder = ''; w.userTags = []; w.searchGroup = query; });
    words = [...newWords, ...words];
    // ã‚¹ã‚­ãƒƒãƒ—ãƒ»é¡ä¼¼ã®é€šçŸ¥
    if (skipped.length > 0 || similar.length > 0) {
      let msg = '';
      if (skipped.length) msg += `âœ“ é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼š${skipped.join('ã€')}\n`;
      if (similar.length) msg += `âš  ä¼¼ãŸèªãŒæ—¢ã«ã‚ã‚Šã¾ã™ï¼š${similar.map(s=>s.newWord+'ï¼ˆæ—¢å­˜:'+s.existing+'ï¼‰').join('ã€')}`;
      document.getElementById('errorMsg').innerHTML = `<div class="warn-msg">${msg.replace(/\n/g,'<br>')}</div>`;
      setTimeout(()=>{ document.getElementById('errorMsg').innerHTML=''; }, 6000);
    }
    addHistory(query);
    updateFilterOptions();
    renderTable();
    saveStorage();

  } catch(e) {
    document.getElementById('errorMsg').innerHTML = `<div class="error-msg">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    if (words.length === 0) document.getElementById('emptyState').style.display = 'block';
  } finally {
    const lr = document.getElementById('loadingRow'); if (lr) lr.remove();
    btn.disabled = false;
    btn.textContent = MODE_CONFIG[currentMode].btnText;
    document.getElementById('queryInput').value = '';
    updateStats();
  }
}

// â”€â”€ ãŠæ°—ã«å…¥ã‚Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let favFolders = []; // å…¨ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§

function getFavFolderOptions(current) {
  return favFolders.map(f =>
    `<option value="${f}" ${f === current ? 'selected' : ''}>${f}</option>`
  ).join('');
}

function syncFavFolders() {
  const fromWords = [...new Set(words.filter(w => w.fav && w.favFolder).map(w => w.favFolder))];
  fromWords.forEach(f => { if (!favFolders.includes(f)) favFolders.push(f); });
}

function createFavFolder() {
  const name = prompt('æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if (!name || !name.trim()) return;
  const f = name.trim();
  if (!favFolders.includes(f)) { favFolders.push(f); updateFavFolderOptions(); renderTable(); }
}

function renameFavFolder() {
  if (!favFolders.length) { alert('ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const oldName = prompt('åå‰ã‚’å¤‰æ›´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n' + favFolders.join('ã€'));
  if (!oldName || !favFolders.includes(oldName.trim())) return;
  const newName = prompt('æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', oldName.trim());
  if (!newName || !newName.trim() || newName.trim() === oldName.trim()) return;
  const n = newName.trim(), o = oldName.trim();
  favFolders = favFolders.map(f => f === o ? n : f);
  words.forEach(w => { if (w.favFolder === o) w.favFolder = n; });
  saveStorage(); updateFavFolderOptions(); renderTable();
}

function deleteFavFolder() {
  if (!favFolders.length) { alert('ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const name = prompt('å‰Šé™¤ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n' + favFolders.join('ã€'));
  if (!name || !favFolders.includes(name.trim())) return;
  favFolders = favFolders.filter(f => f !== name.trim());
  words.forEach(w => { if (w.favFolder === name.trim()) w.favFolder = ''; });
  saveStorage(); updateFavFolderOptions(); renderTable();
}

function setFavFolder(id, folder) {
  const w = words.find(w => String(w.id) === String(id));
  if (w) { w.favFolder = folder; saveStorage(); updateFavFolderOptions(); }
}

function updateFavFolderOptions() {
  syncFavFolders();
  const sel = document.getElementById('favFolderFilter');
  const cur = sel.value;
  sel.innerHTML = '<option value="">å…¨ãƒ•ã‚©ãƒ«ãƒ€</option>' + favFolders.map(f=>`<option value="${f}">ğŸ“ ${f}</option>`).join('');
  if (favFolders.includes(cur)) sel.value = cur;
}

function toggleFav(id) {
  const w = words.find(w => String(w.id) === String(id));
  if (w) { w.fav = !w.fav; saveStorage(); renderTable(); }
}

function showApiSetting() {
  const notice = document.getElementById('apiKeyNotice');
  notice.style.display = 'block';
  // ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
  if (apiKey) document.getElementById('apiKeyInput').value = apiKey;
  if (apiProvider === 'anthropic') {
    const radio = document.querySelector('input[name="apiProvider"][value="anthropic"]');
    if (radio) { radio.checked = true; updateApiUi(); }
  }
  notice.scrollIntoView({ behavior: 'smooth' });
}

function toggleSearchDrawer() {
  const drawer = document.getElementById('searchDrawer');
  const btn = document.getElementById('drawerFloatBtn');
  const isOpen = drawer.classList.contains('open');
  drawer.classList.toggle('open', !isOpen);
  btn.textContent = isOpen ? 'ï¼‹ èªã‚’è¿½åŠ ãƒ»çµã‚Šè¾¼ã¿' : 'âœ• é–‰ã˜ã‚‹';
  btn.style.background = isOpen ? 'var(--accent2)' : 'var(--accent)';
}

function toggleFilterPanel() {
  const panel = document.getElementById('filterPanel');
  const btn = document.getElementById('filterToggleBtn');
  const isOpen = !panel.classList.contains('collapsed');
  panel.classList.toggle('collapsed', isOpen);
  btn.textContent = isOpen ? 'ğŸ” çµã‚Šè¾¼ã¿ â–¼' : 'ğŸ” çµã‚Šè¾¼ã¿ â–²';
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('filterCategory').value = '';
  document.getElementById('filterGroup').value = '';
  document.getElementById('filterAtmos').value = '';
  document.getElementById('filterStrength').value = '';
  document.querySelectorAll('#filterDensity input, #filterCoreWide input').forEach(el => el.checked = false);
  activeTagFilters.clear();
  updateTagFilterOptions();
  renderTable();
}

function toggleFavFilter() {
  showFavOnly = !showFavOnly;
  document.getElementById('favFilterBtn').classList.toggle('active', showFavOnly);
  renderTable();
}

// â”€â”€ ãƒ¡ãƒ¢ç·¨é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startMemoEdit(id) {
  const w = words.find(w => String(w.id) === String(id));
  if (!w) return;
  const display = document.querySelector(`.memo-display[data-id="${id}"]`);
  if (!display) return;
  const ta = document.createElement('textarea');
  ta.className = 'memo-input';
  ta.value = w.memo || '';
  ta.placeholder = 'è‡ªç”±ã«ãƒ¡ãƒ¢ã‚’æ›¸ãâ€¦';
  ta.style.width = '100%';
  display.replaceWith(ta);
  ta.focus();
  ta.addEventListener('blur', () => {
    w.memo = ta.value;
    saveStorage();
    const newDisplay = document.createElement('div');
    newDisplay.className = `memo-display${w.memo ? '' : ' empty'}`;
    newDisplay.dataset.id = id;
    newDisplay.textContent = w.memo || '';
    newDisplay.addEventListener('click', () => startMemoEdit(id));
    ta.replaceWith(newDisplay);
  });
  ta.addEventListener('keydown', e => { if (e.key === 'Escape') ta.blur(); });
}

// â”€â”€ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function strengthDots(s) {
  const lv = STRENGTH_ORDER[s] || 0;
  return [1,2,3,4].map(i => `<div class="strength-dot${i<=lv?` active lv${lv}`:''}"></div>`).join('') + `<span class="strength-label">${s||''}</span>`;
}
function densityBadge(d) {
  if (!d) return '';
  const cls = d==='ãƒ©ã‚¤ãƒˆ'?'density-light':d==='ãƒŸãƒ‰ãƒ«'?'density-middle':'density-deep';
  return `<span class="density-badge ${cls}">${d}</span>`;
}
function joyoudoClass(j) { return j==='â˜…â˜…â˜…'?'tag-joyoudo-3':j==='â˜…â˜…â˜†'?'tag-joyoudo-2':'tag-joyoudo-1'; }

function renderTable() {
  const tbody = document.getElementById('tableBody');
  const search = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('filterCategory').value;
  const str = document.getElementById('filterStrength').value;
  const denChecked = [...document.querySelectorAll('#filterDensity input:checked')].map(i => i.value);
  const cwChecked = [...document.querySelectorAll('#filterCoreWide input:checked')].map(i => i.value);
  const groupFilter = document.getElementById('filterGroup').value;
  const atmosFilter = document.getElementById('filterAtmos').value;
  let filtered = words.filter(w => {
    if (activeTagFilters.size > 0) {
      const wTags = w.userTags || [];
      if (![...activeTagFilters].every(t => wTags.includes(t))) return false;
    }
    const folderFilter = document.getElementById('favFolderFilter').value;
  if (showFavOnly && !w.fav) return false;
  if (folderFilter && w.favFolder !== folderFilter) return false;
    if (cat && w.category !== cat) return false;
    if (str && w.strength !== str) return false;
    if (denChecked.length > 0 && !denChecked.includes(w.density)) return false;
    if (cwChecked.length > 0 && !cwChecked.includes(w.subcategory)) return false;
    if (groupFilter && w.searchGroup !== groupFilter) return false;
    if (atmosFilter && !(w.atmos||'').split(',').map(a=>a.trim()).includes(atmosFilter)) return false;
    if (search) {
      const hay = [w.word,w.reading,w.example,w.note,w.memo,w.scene,w.famous_phrase,w.category].join(' ').toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  if (sortKey) {
    filtered.sort((a,b) => {
      let av=a[sortKey]||'', bv=b[sortKey]||'';
      if (sortKey==='strength') { av=STRENGTH_ORDER[av]||0; bv=STRENGTH_ORDER[bv]||0; }
      if (sortKey==='density')  { av=DENSITY_ORDER[av]||0;  bv=DENSITY_ORDER[bv]||0; }
      if (sortKey==='joyoudo')  { av=av.length; bv=bv.length; }
      return sortAsc?(av>bv?1:-1):(av<bv?1:-1);
    });
  }

  document.getElementById('countBadge').textContent = `${filtered.length} èª`;
  document.getElementById('emptyState').style.display = words.length===0?'block':'none';

  tbody.innerHTML = filtered.map(w => {
    const gokanTags = (w.gokan||'').split(',').filter(Boolean).map(g=>`<span class="tag tag-gokan">${g.trim()}</span>`).join('');
    const buntaiTags = (w.buntai||'').split(',').filter(Boolean).map(b=>`<span class="tag tag-buntai">${b.trim()}</span>`).join('');
    const atmosTags = (w.atmos||'').split(',').filter(Boolean).map(a=>`<span class="tag tag-atmos">${a.trim()}</span>`).join('');
    const encoded = encodeURIComponent(w.word);
    const pid = 'popup_' + String(w.id).replace('.','_');
    const extLinks = `<div class="link-popup-wrap">
      <button class="link-icon" onclick="togglePopup('${pid}')" title="è¾æ›¸ãƒªãƒ³ã‚¯">ğŸ”—</button>
      <button class="link-icon" onclick="openAllLinks('${w.word}')" title="å…¨ãƒªãƒ³ã‚¯ã‚’é–‹ãï¼ˆèªã‚’ã‚³ãƒ”ãƒ¼ï¼‰" style="font-size:11px;opacity:0.5;">âŠ</button>
      <div class="link-popup" id="${pid}">
        <a href="https://kotobank.jp/search?q=${encoded}" target="_blank"><span>ğŸ“š</span>ã‚³ãƒˆãƒãƒ³ã‚¯</a>
        <a href="https://www.weblio.jp/content/${encoded}" target="_blank"><span>ğŸ“–</span>Weblio</a>
        <a href="javascript:void(0)" onclick="openExtSite('${w.word}','https://tsukubawebcorpus.jp/search/')"><span>ğŸŒ</span>ã¤ãã°</a>
        <a href="javascript:void(0)" onclick="openExtSite('${w.word}','https://renso-ruigo.com/')"><span>ğŸ”</span>é¡èª</a>
        <a href="javascript:void(0)" onclick="openExtSite('${w.word}','https://hyogen.info/')"><span>ğŸ’¡</span>è¡¨ç¾</a>
      </div>
    </div>`;
    const id = w.id;

    return `
    <tr class="${w.isNew?'new-row':''} ${w.fav?'fav-row':''}" data-id="${id}">
      <td>
        <button class="btn-fav ${w.fav?'active':''}" onclick="toggleFav('${id}')" title="ãŠæ°—ã«å…¥ã‚Š">â˜…</button>
        ${w.fav ? `<select class="fav-folder-select" onchange="setFavFolder('${id}', this.value)" title="ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ">
          <option value="">ãƒ•ã‚©ãƒ«ãƒ€ãªã—</option>
          ${getFavFolderOptions(w.favFolder||'')}
        </select>` : ''}
      </td>
      <td>
        <div class="word-main" style="cursor:pointer;" onclick="filterByGroup('${w.searchGroup||''}')" title="ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã§çµã‚Šè¾¼ã‚€">${w.word}</div>
        <div class="word-reading">${w.reading||''}</div>
        ${w.searchGroup ? `<div class="group-badge" style="cursor:pointer;" onclick="filterByGroup('${w.searchGroup||''}')" title="ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã§çµã‚Šè¾¼ã‚€">ğŸ” ${w.searchGroup}</div>` : ''}
      </td>
      <td style="width:36px;vertical-align:middle;text-align:center;padding:6px 3px;">
        <div class="strength-bar" title="å¼·åº¦:${w.strength||''}">${strengthDots(w.strength)}</div>
      </td>
      <td style="width:36px;vertical-align:middle;text-align:center;padding:6px 2px;">
        ${densityBadge(w.density)}
      </td>
      <td style="width:32px;vertical-align:middle;text-align:center;padding:6px 2px;">
        <span class="joyoudo-cell ${joyoudoClass(w.joyoudo)}">${w.joyoudo||''}</span>
      </td>
      <td><div class="tags"><span class="tag tag-hinshi">${w.hinshi||''}</span>${atmosTags}${gokanTags}${buntaiTags}</div></td>
      <td>${extLinks}</td>
      <td class="memo-cell" style="min-width:160px;">
        <div class="memo-display ${w.memo?'':'empty'}" data-id="${id}">${w.memo||''}</div>
        ${w.note?`<div class="note-inline">âš  ${w.note}</div>`:''}
        <textarea class="user-example-input" data-id="${id}" placeholder="è‡ªåˆ†ã®ä¾‹æ–‡â€¦" rows="2">${w.userExample||''}</textarea>
        <div class="user-tags-wrap" data-id="${id}">
          ${(w.userTags||[]).map(t=>`<span class="user-tag">#${t}<span class="tag-del" onclick="removeUserTag('${id}','${t.replace(/'/g,'\\&apos;')}')">Ã—</span></span>`).join('')}
          <input class="user-tag-input" placeholder="# ã‚¿ã‚°è¿½åŠ " data-id="${id}"
            onkeydown="if(event.key==='Enter'||event.key===','){addUserTag('${id}',this);event.preventDefault();}"
            onblur="if(this.value.trim())addUserTag('${id}',this)" />
        </div>
      </td>
      <td style="white-space:nowrap;">
        ${words.filter(x=>x.word===w.word).length>1?`<button class="btn-merge" onclick="mergeWord('${id}')" title="é‡è¤‡ã‚’çµ±åˆ">âŠ•</button>`:''}
        <button class="btn-delete" onclick="deleteWord('${id}')" title="å‰Šé™¤">Ã—</button>
      </td>
    </tr>`;
  }).join('');

  // ãƒ¡ãƒ¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰
  filtered.forEach(w => {
    const el = document.querySelector(`.memo-display[data-id="${w.id}"]`);
    if (el) el.addEventListener('click', () => startMemoEdit(w.id));
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾‹æ–‡ã®ä¿å­˜
    const ta = document.querySelector(`.user-example-input[data-id="${w.id}"]`);
    if (ta) {
      ta.addEventListener('change', () => {
        const word = words.find(x => String(x.id) === String(w.id));
        if (word) { word.userExample = ta.value; saveStorage(); }
      });
    }
  });

  setTimeout(()=>{ words.forEach(w=>w.isNew=false); }, 500);
  updateTagFilterOptions();
}

// â”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeTagFilters = new Set();

function addUserTag(id, input) {
  const val = input.value.trim().replace(/^#/, '');
  if (!val) return;
  const w = words.find(w => String(w.id) === String(id));
  if (!w) return;
  if (!w.userTags) w.userTags = [];
  if (!w.userTags.includes(val)) {
    w.userTags.push(val);
    saveStorage();
    renderTable();
    updateTagFilterOptions();
  }
  input.value = '';
}

function removeUserTag(id, tag) {
  const w = words.find(w => String(w.id) === String(id));
  if (!w || !w.userTags) return;
  w.userTags = w.userTags.filter(t => t !== tag);
  activeTagFilters.delete(tag);
  saveStorage();
  renderTable();
  updateTagFilterOptions();
}

function updateTagFilterOptions() {
  const allTags = [...new Set(words.flatMap(w => w.userTags || []))].sort();
  const wrap = document.getElementById('tagFilterWrap');
  if (!wrap) return;
  if (allTags.length === 0) { wrap.innerHTML = ''; return; }
  wrap.innerHTML = '<span style="font-size:10px;color:var(--muted);margin-right:4px;">ã‚¿ã‚°çµè¾¼ï¼š</span>' +
    allTags.map(t => `<span class="tag-filter-chip ${activeTagFilters.has(t)?'active':''}" onclick="toggleTagFilter('${t.replace(/'/g,"\\'")}')"> #${t}</span>`).join('');
}

function toggleTagFilter(tag) {
  if (activeTagFilters.has(tag)) activeTagFilters.delete(tag);
  else activeTagFilters.add(tag);
  updateTagFilterOptions();
  renderTable();
}

function filterTable() { renderTable(); }
function sortBy(key) {
  if (sortKey===key) sortAsc=!sortAsc; else { sortKey=key; sortAsc=true; }
  renderTable();
}
// â”€â”€ è¾æ›¸çµ±åˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mergeWord(id) {
  const src = words.find(w => String(w.id) === String(id));
  if (!src) return;

  // åŒã˜wordã®æ—¢å­˜ã‚¨ãƒ³ãƒˆãƒªã‚’æ¢ã™ï¼ˆè‡ªåˆ†ä»¥å¤–ï¼‰
  const duplicates = words.filter(w => w.word === src.word && String(w.id) !== String(id));
  if (duplicates.length === 0) {
    showToast('ã€Œ' + src.word + 'ã€ã®é‡è¤‡ã‚¨ãƒ³ãƒˆãƒªã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const target = duplicates[0]; // æœ€åˆã®é‡è¤‡ã‚’çµ±åˆå…ˆã«
  // ã‚ˆã‚Šæƒ…å ±ãŒå……å®Ÿã—ã¦ã„ã‚‹æ–¹ã‚’ãƒ™ãƒ¼ã‚¹ã«çµ±åˆ
  if (!target.note && src.note) target.note = src.note;
  if (!target.memo && src.memo) target.memo = src.memo;
  if (!target.userExample && src.userExample) target.userExample = src.userExample;
  // ã‚¿ã‚°ã‚’ãƒãƒ¼ã‚¸
  const mergedTags = [...new Set([...(target.userTags||[]), ...(src.userTags||[])])];
  target.userTags = mergedTags;
  // å¼·åº¦ãƒ»æ¿ƒã•ã¯è¾æ›¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ·±æ˜ã‚Šï¼‰ã®å€¤ã‚’å„ªå…ˆ
  if (src.subcategory === 'ã‚³ã‚¢') {
    target.strength = src.strength;
    target.density = src.density;
    target.gokan = src.gokan || target.gokan;
    target.buntai = src.buntai || target.buntai;
    target.note = src.note || target.note;
  }
  // srcã‚’å‰Šé™¤
  words = words.filter(w => String(w.id) !== String(id));
  saveStorage(); updateFilterOptions(); updateStats(); renderTable();
  showToast('ã€Œ' + src.word + 'ã€ã‚’çµ±åˆã—ã¾ã—ãŸ');
}

function deleteWord(id) {
  words = words.filter(w=>String(w.id)!==String(id));
  updateFilterOptions(); updateStats(); renderTable(); saveStorage();
}
function clearAll() {
  if (!words.length) return;
  if (confirm(`${words.length} èªã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
    words=[]; updateFilterOptions(); updateStats(); renderTable(); saveStorage();
  }
}
function updateStats() { document.getElementById('headerStats').textContent = `${words.length} èªåéŒ²`; }
function updateFilterOptions() {
  const cats = [...new Set(words.map(w=>w.category).filter(Boolean))];
  const sel = document.getElementById('filterCategory');
  const cur = sel.value;
  sel.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  if (cats.includes(cur)) sel.value = cur;

  const groups = [...new Set(words.map(w=>w.searchGroup).filter(Boolean))];
  const gsel = document.getElementById('filterGroup');
  const gcur = gsel.value;
  gsel.innerHTML = '<option value="">ã™ã¹ã¦ã®æ¤œç´¢ã‚°ãƒ«ãƒ¼ãƒ—</option>'+groups.map(g=>`<option value="${g}">ğŸ” ${g}</option>`).join('');
  if (groups.includes(gcur)) gsel.value = gcur;
}
function togglePopup(id) {
  // ä»–ã‚’é–‰ã˜ã‚‹
  document.querySelectorAll('.link-popup.open').forEach(p => { if (p.id !== id) p.classList.remove('open'); });
  const popup = document.getElementById(id);
  if (popup) popup.classList.toggle('open');
}
// ã‚¯ãƒªãƒƒã‚¯å¤–ã§é–‰ã˜ã‚‹
document.addEventListener('click', e => {
  if (!e.target.closest('.link-popup-wrap')) {
    document.querySelectorAll('.link-popup.open').forEach(p => p.classList.remove('open'));
  }
});

function openTsukuba(word) { openExtSite(word, 'https://tsukubawebcorpus.jp/search/'); }

function openAllLinks(word) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(word).catch(()=>{});
  }
  const encoded = encodeURIComponent(word);
  const urls = [
    `https://kotobank.jp/search?q=${encoded}`,
    `https://www.weblio.jp/content/${encoded}`,
    'https://tsukubawebcorpus.jp/search/',
    'https://renso-ruigo.com/',
    'https://hyogen.info/'
  ];
  // aã‚¿ã‚°ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’å›é¿
  urls.forEach((url, i) => {
    const a = document.createElement('a');
    a.href = url; a.target = '_blank'; a.rel = 'noopener';
    document.body.appendChild(a);
    setTimeout(() => { a.click(); document.body.removeChild(a); }, i * 200);
  });
  showToast('ã€Œ' + word + 'ã€ã‚’ã‚³ãƒ”ãƒ¼ï¼‹5ã‚µã‚¤ãƒˆã‚’é–‹ãã¾ã™');
}

function openExtSite(word, url) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(word).then(() => {
      showToast('ã€Œ' + word + 'ã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ â†’ æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
    }).catch(() => {});
  }
  window.open(url, '_blank');
}

function showToast(msg) {
  let toast = document.getElementById('copyToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'copyToast';
    toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1a1208;color:#f5f0e8;padding:10px 20px;border-radius:2px;font-size:12px;z-index:9999;letter-spacing:0.05em;opacity:0;transition:opacity 0.2s;pointer-events:none;white-space:nowrap;';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  clearTimeout(toast._t);
  toast._t = setTimeout(() => { toast.style.opacity = '0'; }, 2500);
}

// â”€â”€ ãƒªãƒ³ã‚¯é›† â”€â”€
let toolLinks = [
  { label: 'æ ¡æ­£æ”¯æ´', url: 'https://so-zou.jp/web-app/text/proofreading/' },
  { label: 'åå‰ç”Ÿæˆ', url: 'http://tinyangel.jog.client.jp/Name/NameGenerator.html' },
  { label: 'ä¸–ç•Œåœ°å', url: 'https://www.worldsys.org/europe/' },
  { label: 'åå‰gen', url: 'https://namegen.jp/' },
];

function toggleLinkPanel() {
  const p = document.getElementById('linkPanel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
  if (p.style.display === 'block') renderLinkList();
  // å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  setTimeout(() => {
    document.addEventListener('click', closeLinkPanel, { once: true });
  }, 0);
}
function closeLinkPanel(e) {
  const p = document.getElementById('linkPanel');
  if (p && !p.contains(e.target) && !e.target.closest('[onclick="toggleLinkPanel()"]')) {
    p.style.display = 'none';
  }
}
function renderLinkList() {
  const el = document.getElementById('linkList');
  if (!el) return;
  el.innerHTML = toolLinks.map((l, i) => `
    <div style="display:flex;align-items:center;gap:6px;">
      <a href="${l.url}" target="_blank" style="font-size:12px;color:var(--accent);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none;">${l.label}</a>
      <button onclick="deleteToolLink(${i})" style="font-size:10px;background:none;border:none;cursor:pointer;color:var(--muted);padding:0 2px;" title="å‰Šé™¤">âœ•</button>
    </div>`).join('');
}
function addToolLink() {
  const label = document.getElementById('linkNewLabel').value.trim();
  const url = document.getElementById('linkNewUrl').value.trim();
  if (!label || !url) return;
  toolLinks.push({ label, url });
  document.getElementById('linkNewLabel').value = '';
  document.getElementById('linkNewUrl').value = '';
  saveStorage();
  renderLinkList();
}
function deleteToolLink(i) {
  toolLinks.splice(i, 1);
  saveStorage();
  renderLinkList();
}

function exportCSV() {
  if (!words.length) return;
  const headers = ['èª','èª­ã¿','å“è©','ã‚«ãƒ†ã‚´ãƒª','ç´°åˆ†é¡','å¼·åº¦','æ¿ƒã•','èªæ„Ÿ','æ–‡ä½“','å¸¸ç”¨åº¦','ãƒ¡ãƒ¢','è‡ªåˆ†ã®ä¾‹æ–‡','ãŠæ°—ã«å…¥ã‚Š','ãƒ•ã‚©ãƒ«ãƒ€'];
  const rows = words.map(w=>[w.word,w.reading,w.hinshi,w.category,w.subcategory,w.strength,w.density,w.gokan,w.buntai,w.joyoudo,w.memo,w.userExample,w.fav?'â˜…':'',w.favFolder].map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(','));
  const csv = '\uFEFF'+[headers.join(','),...rows].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
  a.download = `ã“ã¨ã°äº‹å…¸_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tabId, btn) {
  document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
  // è¾æ›¸ã‚¿ãƒ–ä»¥å¤–ã§ã¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
  const isDict = tabId === 'dict-tab';
  const floatBtn = document.getElementById('drawerFloatBtn');
  const topBtn = document.getElementById('scrollTopBtn');
  if (floatBtn) floatBtn.style.display = isDict ? '' : 'none';
  if (topBtn) topBtn.style.display = isDict ? '' : 'none';
  // searchDrawerã‚’é–‰ã˜ã‚‹
  const drawer = document.getElementById('searchDrawer');
  if (drawer && !isDict) drawer.classList.remove('open');
}

// â”€â”€ æ›¸ãå‡ºã—ãƒãƒ¼ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notes = [];
let currentNoteType = 'æ›¸ãå‡ºã—';

function setNoteType(btn) {
  document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentNoteType = btn.dataset.type;
}

function addNote() {
  const work = document.getElementById('noteWork').value.trim();
  const text = document.getElementById('noteText').value.trim();
  if (!work || !text) {
    document.getElementById('noteError').innerHTML = '<div class="error-msg">ä½œå“åã¨ãƒ†ã‚­ã‚¹ãƒˆã¯å¿…é ˆã§ã™</div>';
    return;
  }
  document.getElementById('noteError').innerHTML = '';
  const note = {
    id: Date.now(),
    work,
    genre: document.getElementById('noteGenre').value.trim(),
    type: currentNoteType,
    text,
    pattern: document.getElementById('notePattern').value.trim(),
    tags: document.getElementById('noteTags').value.trim().split(/\s+/).filter(Boolean),
    date: new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'})
  };
  notes = [note, ...notes];
  saveStorage();
  renderNotes();
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  ['noteWork','noteGenre','noteText','notePattern','noteTags'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
}

function deleteNote(id) {
  if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  notes = notes.filter(n => n.id !== id);
  saveStorage();
  renderNotes();
}

function renderNotes() {
  const search = document.getElementById('noteSearch').value.toLowerCase();
  const typeFilter = document.getElementById('noteFilterType').value;
  const grid = document.getElementById('notesGrid');
  const empty = document.getElementById('noteEmpty');

  let filtered = notes.filter(n => {
    if (typeFilter && n.type !== typeFilter) return false;
    if (search) {
      const hay = [n.work, n.text, n.pattern, n.genre, ...(n.tags||[])].join(' ').toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  document.getElementById('noteCountBadge').textContent = `${filtered.length} ä»¶`;
  empty.style.display = filtered.length === 0 ? 'block' : 'none';
  grid.style.display = filtered.length === 0 ? 'none' : 'flex';

  const typeCls = { 'æ›¸ãå‡ºã—': 'type-open', 'ç· ã‚': 'type-close', 'ä¸¡æ–¹': 'type-both' };
  grid.innerHTML = filtered.map(n => {
    const tags = (n.tags||[]).map(t => `<span class="note-user-tag">${t}</span>`).join('');
    return `
    <div class="note-card">
      <div class="note-card-header">
        <div class="note-card-left">
          <div class="note-work">${n.work}</div>
          <div class="note-card-tags">
            <span class="note-type-badge ${typeCls[n.type]||''}">${n.type}</span>
            ${n.genre ? `<span class="note-genre-tag">${n.genre}</span>` : ''}
            ${tags}
          </div>
        </div>
        <div class="note-card-actions">
          <button class="btn-delete" onclick="deleteNote(${n.id})" title="å‰Šé™¤">Ã—</button>
        </div>
      </div>
      <div class="note-text-display">${n.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      ${n.pattern ? `<div class="note-pattern">${n.pattern}</div>` : ''}
      <div class="note-date">${n.date}</div>
    </div>`;
  }).join('');
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('queryInput').addEventListener('keydown', e => { if(e.key==='Enter') generate(); });
  loadStorage();
});
</script>
</div><!-- /main -->
</div><!-- /dict-tab -->

<!-- æ›¸ãå‡ºã—ãƒ»ç· ã‚æ–¹ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ -->
<div id="note-tab" class="tab-page">
<div class="note-page">

  <div class="note-add-section">
    <div class="note-form-grid">
      <div class="input-group">
        <label>ä½œå“å</label>
        <input type="text" id="noteWork" placeholder="ä¾‹ï¼šç¶™æ¯ã®å¿ƒå¾— ã‚³ãƒŸã‚«ãƒ©ã‚¤ã‚º1å·»" />
      </div>
      <div class="input-group">
        <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
        <input type="text" id="noteGenre" placeholder="ä¾‹ï¼šç•°ä¸–ç•Œãƒ»è»¢ç”Ÿãƒ»ä»¤å¬¢" />
      </div>
    </div>

    <div class="note-type-row">
      <span class="note-type-label">ç¨®åˆ¥</span>
      <div class="type-track">
        <button class="type-btn active" data-type="æ›¸ãå‡ºã—" onclick="setNoteType(this)">æ›¸ãå‡ºã—</button>
        <button class="type-btn" data-type="ç· ã‚" onclick="setNoteType(this)">ç· ã‚</button>
        <button class="type-btn" data-type="ä¸¡æ–¹" onclick="setNoteType(this)">ä¸¡æ–¹</button>
      </div>
    </div>

    <div class="note-form-full">
      <label class="input-group" style="gap:5px">
        <span style="font-size:11px;letter-spacing:0.15em;color:var(--muted)">ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå†’é ­æ•°è¡Œï¼‰</span>
        <textarea class="note-text-input" id="noteText" placeholder="ã€ŒäºŒäººã¨ã‚‚ã€ãŠèŒ¶ãŒå…¥ã‚Šã¾ã—ãŸã‚ã‚ˆã€&#10;&#10;ç§ã¯å¿˜ã‚Œãªã„ã€‚ã‹ã¤ã¦ã®ç§ãŒçŠ¯ã—ãŸç½ªã‚’ã€‚â€•â€•ãã—ã¦â€¦â€¦ã“ã®ç‰©èªã«é–¢ã‚ã‚‹ã€å…¨ã¦ã®æ„›ã—ã„è€…ãŸã¡ã®ã“ã¨ã‚’ã€‚"></textarea>
      </label>
    </div>

    <div class="note-form-grid">
      <div class="input-group">
        <label>ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ¡ãƒ¢ï¼ˆæŠ€æ³•åˆ†æï¼‰</label>
        <textarea class="note-memo-input" id="notePattern" placeholder="ä¾‹ï¼šå°è©ã‹ã‚‰å…¥ã‚Šã€ç‹¬ç™½ã§éå»ã‚’å¼•ãå‡ºã™æ§‹æˆ"></textarea>
      </div>
      <div class="input-group">
        <label>ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label>
        <input type="text" id="noteTags" placeholder="ä¾‹ï¼šå°è©å§‹ã¾ã‚Š ç‹¬ç™½ å›æƒ³ ä½™éŸ»" />
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-primary" onclick="addNote()">è¿½åŠ ã™ã‚‹</button>
    </div>
    <div id="noteError"></div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="note-filters">
    <div class="search-wrap" style="flex:1;min-width:160px;">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="noteSearch" placeholder="ä½œå“åãƒ»ãƒ†ã‚­ã‚¹ãƒˆãƒ»ã‚¿ã‚°ã‚’æ¤œç´¢â€¦" oninput="renderNotes()" />
    </div>
    <select class="filter-select" id="noteFilterType" onchange="renderNotes()">
      <option value="">ã™ã¹ã¦ã®ç¨®åˆ¥</option>
      <option value="æ›¸ãå‡ºã—">æ›¸ãå‡ºã—</option>
      <option value="ç· ã‚">ç· ã‚</option>
      <option value="ä¸¡æ–¹">ä¸¡æ–¹</option>
    </select>
    <span class="count-badge" id="noteCountBadge"></span>
  </div>

  <div class="notes-grid" id="notesGrid"></div>
  <div id="noteEmpty" class="note-empty" style="display:none">
    <div class="icon">ğŸ“</div>
    <p>å¥½ããªæ›¸ãå‡ºã—ãƒ»ç· ã‚æ–¹ã‚’<br>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ãã¾ã—ã‚‡ã†</p>
  </div>

</div>
</div><!-- /note-tab -->

<!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–‹é–‰ãƒœã‚¿ãƒ³ -->
<button id="drawerFloatBtn" onclick="toggleSearchDrawer()">ï¼‹ èªã‚’è¿½åŠ ãƒ»çµã‚Šè¾¼ã¿</button>
<button id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹" style="position:fixed;bottom:70px;right:24px;z-index:500;background:var(--paper);color:var(--muted);border:1px solid var(--border);border-radius:50%;width:38px;height:38px;font-size:16px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;line-height:1;">â†‘</button>

</body>
</html>
