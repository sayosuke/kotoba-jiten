<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‰µä½œãƒãƒ¼ãƒˆ</title>
<style>
:root {
  --ink: #0f0a04; --paper: #f5f0e8; --paper2: #ede7d9; --paper3: #e5dece;
  --accent: #7a2008; --accent2: #c4763a; --muted: #5a4a3a;
  --border: #d4c9b0; --hover: #e8e2d4; --active-bg: #ddd5c0;
  --sidebar-w: 260px; --header-h: 48px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Serif JP', serif; background: var(--paper); color: var(--ink); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
.header { height: var(--header-h); background: var(--ink); color: var(--paper); display: flex; align-items: center; padding: 0 16px; gap: 12px; flex-shrink: 0; }
.header-logo { font-size: 13px; letter-spacing: 0.2em; white-space: nowrap; }
.header-search { flex: 1; max-width: 280px; display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 2px; padding: 4px 10px; }
.header-search input { background: none; border: none; outline: none; color: var(--paper); font-size: 12px; flex: 1; font-family: sans-serif; }
.header-search input::placeholder { color: rgba(255,255,255,0.35); }
.header-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; }
.api-badge { font-size: 9px; letter-spacing: 0.1em; padding: 3px 8px; border: 1px solid rgba(255,255,255,0.25); color: rgba(255,255,255,0.6); cursor: pointer; }
.api-badge:hover { background: rgba(255,255,255,0.1); }
.hdr-link { color: rgba(255,255,255,0.5); font-size: 10px; text-decoration: none; letter-spacing: 0.1em; }
.hdr-link:hover { color: rgba(255,255,255,0.8); }
.dual-toggle { font-size: 10px; padding: 3px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); cursor: pointer; }
.dual-toggle.on { background: var(--accent2); border-color: var(--accent2); color: #fff; }
.save-all-btn { font-size: 10px; padding: 3px 10px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.85); cursor: pointer; transition: all 0.15s; }
.save-all-btn:hover { background: rgba(255,255,255,0.22); color: #fff; }
.save-all-btn.done { background: #3a6a2a; border-color: #4a8a3a; color: #fff; }
.app-body { flex: 1; display: flex; overflow: hidden; min-height: 0; }
.sidebar { width: var(--sidebar-w); background: var(--paper2); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; min-height: 0; }
.sidebar-toolbar { padding: 0 10px; border-bottom: 1px solid var(--border); display: flex; gap: 6px; align-items: center; flex-shrink: 0; height: 42px; }
.cat-filter { flex: 1; font-size: 11px; padding: 4px 6px; border: 1px solid var(--border); background: var(--paper); color: var(--ink); }
.sidebar-add-btn { background: var(--accent); color: #fff; border: none; width: 26px; height: 26px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.sidebar-add-btn:hover { background: var(--accent2); }
.tag-bar { padding: 4px 10px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: nowrap; gap: 3px; height: 28px; flex-shrink: 0; overflow-x: auto; overflow-y: hidden; align-items: center; }
.tag-bar::-webkit-scrollbar { height: 0; }
.tag-chip { font-size: 9px; padding: 1px 6px; border-radius: 10px; background: var(--paper); border: 1px solid var(--border); cursor: pointer; color: var(--muted);  white-space:nowrap; }
.tag-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.note-list { flex: 1; overflow-y: auto; }
.note-item { padding: 8px 10px 8px 6px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: flex-start; gap: 4px; transition: background 0.1s; }
.note-item:hover { background: var(--hover); }
.note-item.active { background: var(--active-bg); border-left: 3px solid var(--accent); padding-left: 3px; }
.note-item-drag { color: var(--border); font-size: 11px; padding-top: 2px; cursor: grab; flex-shrink: 0; }
.note-item-body { flex: 1; min-width: 0; }
.note-item-title { font-size: 12px; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px; }
.note-item-expand { font-size: 9px; color: var(--muted); cursor: pointer; width: 12px; text-align: center; flex-shrink: 0; }
.note-item-meta { font-size: 9px; color: var(--muted); margin-top: 2px; display: flex; gap: 4px; flex-wrap: wrap; }
.note-item-type { font-size: 8px; padding: 1px 4px; }
.note-item-del { opacity: 0; font-size: 10px; color: var(--muted); cursor: pointer; padding: 2px; flex-shrink: 0; align-self: center; }
.note-item:hover .note-item-del { opacity: 0.5; }
.note-item.drag-over { border-top: 2px solid var(--accent2); }
.note-item.drag-over-child { background: #e8f0e4; border: 1px dashed #4a7a40; border-radius: 2px; }
.editor-pane.drag-over-pane { outline: 2px dashed var(--accent2); outline-offset: -3px; background: rgba(196,118,58,0.04); }
.children-list { background: rgba(0,0,0,0.02); }
.main-pane { flex: 1; display: flex; overflow: hidden; min-width: 0; min-height: 0; align-items: stretch; }
.editor-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid var(--border); min-width: 0; min-height: 0; }
.editor-pane:last-child { border-right: none; }
.editor-pane-header { padding: 0 10px; background: var(--paper2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-shrink: 0; height: 42px; }
.editor-pane-label { font-size: 10px; color: var(--muted); letter-spacing: 0.1em; flex-shrink: 0; }
.pane-note-select { flex: 1; font-size: 11px; padding: 3px 6px; border: 1px solid var(--border); background: var(--paper); color: var(--ink); min-width: 0; }
.editor-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
.editor-meta-bar { padding: 3px 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-shrink: 0; background: var(--paper); }
.editor-title-input { flex: 1; background: none; border: none; outline: none; font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 600; color: var(--ink); }
.editor-title-input::placeholder { color: var(--border); }
.type-select { font-size: 10px; padding: 3px 5px; border: 1px solid var(--border); background: var(--paper2); color: var(--ink); }
.editor-tag-input { font-size: 10px; padding: 3px 8px; border: 1px solid var(--border); background: var(--paper2); color: var(--ink); font-family: sans-serif; width: 120px; }
.editor-tag-input::placeholder { color: var(--border); }
.editor-save-btn { background: var(--accent2); color: #fff; border: none; padding: 4px 10px; font-size: 10px; cursor: pointer; }
.editor-save-btn:hover { background: var(--accent); }
.editor-save-btn.saved { background: #4a7a40; }
.editor-clear-btn { background: none; color: var(--muted); border: 1px solid var(--border); padding: 3px 8px; font-size: 10px; cursor: pointer; }
.editor-clear-btn:hover { border-color: var(--accent); color: var(--accent); }
.toolbar { display: flex; align-items: center; gap: 2px; padding: 3px 8px; border-bottom: 1px solid var(--border); background: var(--paper2); flex-wrap: wrap; flex-shrink: 0; }
.tb-sep { width: 1px; background: var(--border); height: 16px; margin: 0 3px; flex-shrink: 0; }
.tb-label { font-size: 9px; color: var(--muted); letter-spacing: 0.05em; margin-right: 1px; }
.tb-btn { background: none; border: 1px solid transparent; border-radius: 2px; padding: 2px 5px; font-size: 12px; cursor: pointer; color: var(--ink); line-height: 1.2; white-space: nowrap; transition: all 0.1s; font-family: serif; }
.tb-btn:hover { background: var(--hover); border-color: var(--border); }
.tb-btn.wide { font-size: 10px; padding: 2px 7px; letter-spacing: 0.03em; }
.snippet-panel { display: none; position: fixed; background: var(--paper); border: 1px solid var(--border); border-radius: 2px; padding: 10px 12px 8px; z-index: 500; box-shadow: 0 4px 16px rgba(0,0,0,0.12); min-width: 260px; max-width: 340px; max-height: 70vh; overflow: hidden; flex-direction: column; }
.snippet-panel.show { display: flex; }
.snippet-panel h4 { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px; flex-shrink: 0; }
.snippet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; overflow-y: auto; flex: 1; min-height: 0; }
.snippet-item { font-size: 11px; padding: 4px 8px; background: var(--paper2); border: 1px solid var(--border); cursor: pointer; text-align: left; font-family: serif; color: var(--ink); line-height: 1.4; display: flex; justify-content: space-between; align-items: flex-start; }
.snippet-item:hover { background: var(--hover); }
.snippet-del { font-size: 9px; color: var(--muted); cursor: pointer; flex-shrink: 0; margin-left: 4px; }
.snippet-del:hover { color: var(--accent); }
.snippet-add { margin-top: 6px; border-top: 1px solid var(--border); padding-top: 7px; display: flex; gap: 4px; flex-shrink: 0; }
.snippet-add input { flex: 1; font-size: 11px; padding: 4px 6px; border: 1px solid var(--border); background: var(--paper); font-family: serif; }
.snippet-add-btn { font-size: 11px; padding: 4px 10px; background: var(--accent); color: #fff; border: none; cursor: pointer; }
.editor-body { flex: 1; padding: 20px 24px; resize: none; border: none; outline: none; font-family: 'Noto Serif JP', serif; font-size: 13px; line-height: 2.1; color: var(--ink); background: var(--paper); overflow-y: auto; min-height: 0; }
.editor-body::placeholder { color: #c8bfb0; }
.child-notes-section { border-top: 2px dashed var(--border); padding: 5px 20px 5px; background: var(--paper2); flex-shrink: 0; max-height: 80px; overflow-y: auto; min-height: 36px; }
.child-notes-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.child-notes-title { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); }
.child-add-btn { font-size: 9px; padding: 2px 7px; background: none; border: 1px solid var(--border); color: var(--muted); cursor: pointer; }
.child-add-btn:hover { border-color: var(--accent2); color: var(--accent2); }
.child-list { display: flex; flex-wrap: wrap; gap: 4px; }
.child-chip { font-size: 11px; padding: 3px 8px; background: var(--paper); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--ink); }
.child-chip:hover { background: var(--hover); border-color: var(--accent2); }
.child-chip-del { font-size: 9px; color: var(--muted); cursor: pointer; }
.child-chip-del:hover { color: var(--accent); }
.empty-pane { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); gap: 10px; }
.empty-pane .icon { font-size: 34px; opacity: 0.3; }
.empty-pane p { font-size: 12px; text-align: center; opacity: 0.5; line-height: 1.8; }
.ai-pane { border-top: 1px solid var(--border); background: var(--paper2); flex-shrink: 0; }
.ai-toggle { padding: 6px 16px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; color: var(--muted); letter-spacing: 0.1em; user-select: none; }
.ai-toggle:hover { background: var(--hover); }
.ai-arrow { font-size: 8px; transition: transform 0.2s; }
.ai-pane.open .ai-arrow { transform: rotate(180deg); }
.ai-body { display: none; height: 165px; }
.ai-pane.open .ai-body { display: flex; }
.ai-input-wrap { flex: 1; display: flex; flex-direction: column; padding: 7px 12px; gap: 5px; }
.ai-question { flex: 1; resize: none; border: 1px solid var(--border); background: var(--paper); padding: 6px 10px; font-family: serif; font-size: 12px; line-height: 1.8; color: var(--ink); outline: none; }
.ai-question::placeholder { color: #c8bfb0; }
.ai-actions-row { display: flex; gap: 6px; align-items: center; }
.ai-prov-btn { font-size: 10px; padding: 3px 8px; border: 1px solid var(--border); background: var(--paper); cursor: pointer; color: var(--muted); }
.ai-prov-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.ai-ask-btn { background: var(--accent2); color: #fff; border: none; padding: 4px 12px; font-size: 11px; cursor: pointer; margin-left: auto; }
.ai-ask-btn:hover { background: var(--accent); }
.ai-ask-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.ai-answer-wrap { width: 43%; border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.ai-answer { flex: 1; padding: 7px 12px; font-size: 11px; line-height: 1.9; color: var(--ink); overflow-y: auto; white-space: pre-wrap; font-family: sans-serif; }
.ai-answer-btns { padding: 4px 8px; border-top: 1px solid var(--border); display: flex; gap: 5px; justify-content: flex-end; }
.ai-ans-btn { font-size: 10px; padding: 2px 8px; cursor: pointer; }
.ai-ans-btn.primary { background: var(--accent); color: #fff; border: none; }
.ai-ans-btn.secondary { background: none; color: var(--muted); border: 1px solid var(--border); }
.ai-spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid var(--border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 900; align-items: center; justify-content: center; }
.modal-overlay.show { display: flex; }
.modal { background: var(--paper); border: 1px solid var(--border); padding: 24px 28px; width: 500px; max-width: 96vw; max-height: 90vh; overflow-y: auto; }
.modal h2 { font-size: 13px; letter-spacing: 0.15em; margin-bottom: 16px; }
.modal-field { margin-bottom: 12px; }
.modal-field label { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); display: block; margin-bottom: 4px; }
.modal-field input, .modal-field textarea { width: 100%; padding: 6px 10px; border: 1px solid var(--border); background: var(--paper2); font-family: serif; font-size: 12px; color: var(--ink); }
.modal-field textarea { resize: vertical; min-height: 120px; line-height: 1.9; }
.modal-actions { display: flex; gap: 8px; margin-top: 16px; }
.btn-primary { background: var(--accent); color: #fff; border: none; padding: 7px 20px; cursor: pointer; font-family: serif; font-size: 12px; }
.btn-primary:hover { background: var(--accent2); }
.btn-secondary { background: none; color: var(--muted); border: 1px solid var(--border); padding: 7px 14px; cursor: pointer; font-size: 12px; }
.add-type-track { display: flex; border: 1px solid var(--border); overflow: hidden; margin-bottom: 12px; }
.add-type-btn { flex: 1; padding: 6px 2px; font-size: 11px; background: var(--paper); border: none; border-right: 1px solid var(--border); cursor: pointer; font-family: serif; color: var(--muted); }
.add-type-btn:last-child { border-right: none; }
.add-type-btn.active { background: var(--accent); color: #fff; }
#scrollTopBtn { position: fixed; bottom: 24px; right: 24px; z-index: 800; background: var(--paper2); color: var(--muted); border: 1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center; }
#scrollTopBtn.visible { display: flex; }
.type-rule { background: #e8f0e4; color: #2a4a1a; }
.type-concept { background: #e8eaf8; color: #1a2a5a; }
.type-quote { background: #f5ede0; color: #5a3010; }
.type-drill { background: #f8eae8; color: #5a1a1a; }
.type-other { background: #ede7d9; color: #5a4a3a; }
.toast { position: fixed; bottom: 66px; right: 24px; background: #1a2a1a; color: #e0f0d8; padding: 6px 14px; font-size: 11px; z-index: 900; display: none; }
.toast.show { display: block; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚¿ãƒ–ãƒãƒ¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-tab-bar {
  display:flex; gap:0; border-bottom:2px solid var(--border);
  background:var(--paper2); flex-shrink:0; padding:0 16px;
}
.main-tab-btn {
  font-family:'Noto Serif JP',serif; font-size:12px;
  padding:9px 20px; border:none; background:none; cursor:pointer;
  color:var(--muted); letter-spacing:0.08em;
  border-bottom:2px solid transparent; margin-bottom:-2px;
  transition:all 0.15s; white-space:nowrap;
}
.main-tab-btn:hover { color:var(--ink); }
.main-tab-btn.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:600; }
.main-tab-page { display:none; flex:1; overflow:hidden; flex-direction:column; min-height:0; }
.main-tab-page.active { display:flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ãƒã‚§ã‚­ãƒ¡ãƒ¢ãƒœãƒ¼ãƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.memo-filter-bar {
  padding:8px 20px; border-bottom:1px solid var(--border);
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  background:var(--paper2); flex-shrink:0;
}
.memo-filter-bar input {
  flex:1; min-width:120px; max-width:240px;
  padding:4px 10px; border:1px solid var(--border); background:var(--paper);
  font-family:serif; font-size:12px; color:var(--ink);
}
.memo-tag-chip {
  font-size:9px; padding:2px 8px; border-radius:10px;
  background:var(--paper); border:1px solid var(--border);
  cursor:pointer; color:var(--muted); white-space:nowrap;
}
.memo-tag-chip.active { background:var(--accent); color:#fff; border-color:var(--accent); }

.memo-board {
  flex:1; overflow:auto; position:relative;
}
/* ã‚«ãƒ¼ãƒ‰ã¯çµ¶å¯¾é…ç½® - position:absoluteã®ã¿ */
.cheki-wrap {
  position:absolute; width:184px; flex-shrink:0; cursor:grab;
}
.cheki-wrap:hover .cheki-card { box-shadow:0 4px 14px rgba(0,0,0,0.22),0 1px 3px rgba(0,0,0,0.1); }
.cheki-wrap.dragging { opacity:0.7; z-index:100; cursor:grabbing; box-shadow:0 8px 24px rgba(0,0,0,0.22); }

.cheki-card {
  width:100%; background:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,0.14),0 1px 3px rgba(0,0,0,0.08);
  border-radius:2px; cursor:default;
  height:276px; display:flex; flex-direction:column; overflow:hidden;
}
.cheki-front, .cheki-back { display:none; flex-direction:column; flex:1; overflow:hidden; }
.cheki-front.show, .cheki-back.show { display:flex; }

/* è¡¨é¢ */
.cheki-photo {
  padding:8px 12px 6px; flex:1;
  display:flex; flex-direction:column; gap:3px;
  overflow-y:auto; min-height:0; scrollbar-width:none;
}
.cheki-photo::-webkit-scrollbar { display:none; }
.cheki-emoji  { font-size:22px; line-height:1; flex-shrink:0; }
.cheki-title  { font-family:'Noto Serif JP',serif; font-size:12px; font-weight:600; line-height:1.5; word-break:break-all; white-space:pre-wrap; flex-shrink:0; }
.cheki-body-text { font-size:10px; line-height:1.7; opacity:0.85; word-break:break-all; white-space:pre-wrap; }
.cheki-bottom { padding:6px 10px 10px; border-top:1px solid #ece8e0; background:#fff;  flex-shrink:0; }
.cheki-tags   { display:flex; flex-wrap:wrap; gap:3px; margin-bottom:4px; }
.cheki-tag    { font-size:8px; padding:1px 5px; background:#f0ece4; color:#5a4a3a; border-radius:8px; }
.cheki-date   { font-size:8px; color:#9a8a7a; }

/* è£é¢ */
.cheki-back-inner { padding:10px 12px; flex:1; display:flex; flex-direction:column; overflow-y:auto; min-height:0; scrollbar-width:none; }
.cheki-back-inner::-webkit-scrollbar { display:none; }
.cheki-back-text  { flex:1; font-size:11px; line-height:1.9; white-space:pre-wrap; word-break:break-all; color:#1a1208; }
.cheki-back-empty { font-size:10px; color:#c0b8a8; font-style:italic; }
.cheki-back-foot  { padding:5px 10px 8px; border-top:1px solid #ece8e0; font-size:8px; color:#9a8a7a; }
.cheki-top-btn {
  background:none; border:none; cursor:pointer;
  font-size:10px; color:#b0a898; padding:0 2px; line-height:1;
}
.cheki-top-btn:hover { color:var(--accent2); }

/* ãƒ•ãƒªãƒƒãƒ—ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.cheki-flip-btn {
  display:block; width:100%; padding:4px 0;
  border:none; border-top:1px solid #ece8e0;
  background:#fafaf8; font-size:9px; color:#9a8a7a;
  cursor:pointer; letter-spacing:0.08em;
 flex-shrink:0; }
.cheki-flip-btn:hover { background:var(--hover); color:var(--ink); }
.cheki-actions {
  display:flex; justify-content:flex-end; gap:2px;
  padding:2px 4px; background:rgba(250,250,248,0.95);
  border-bottom:1px solid #ece8e0; flex-shrink:0;
  height:22px; overflow:visible;
}
.cheki-act-btn {
  background:none; border:none;
  font-size:11px; cursor:pointer; padding:1px 4px;
  color:#b0a898; line-height:1;
}
.cheki-act-btn:hover { color:var(--accent); background:var(--hover); border-radius:2px; }

/* ï¼‹ ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
.memo-fab {
  position:fixed; bottom:70px; right:20px; z-index:600;
  background:var(--accent); color:#fff; border:none; border-radius:50%;
  width:38px; height:38px; font-size:20px; cursor:pointer;
  box-shadow:0 2px 10px rgba(0,0,0,0.22);
  display:none; align-items:center; justify-content:center;
}
.memo-fab:hover { background:var(--accent2); }
.memo-fab.show { display:flex; }

/* â”€â”€ ãƒ¡ãƒ¢å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
.memo-modal-box {
  background:var(--paper); border:1px solid var(--border);
  width:760px; max-width:96vw;
  height:82vh; min-height:500px;
  display:flex; flex-direction:column; overflow:hidden;
}
.memo-modal-hdr {
  padding:12px 18px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
  background:var(--paper2); flex-shrink:0;
}
.memo-modal-hdr-title { font-size:13px; letter-spacing:0.1em; color:var(--muted); }
.memo-modal-body { flex:1; display:flex; overflow:hidden; }
.memo-side {
  flex:1; display:flex; flex-direction:column;
  border-right:1px solid var(--border); overflow:hidden;
}
.memo-side:last-child { border-right:none; }
.memo-side-lbl {
  font-size:10px; letter-spacing:0.1em; color:var(--muted);
  padding:6px 14px; border-bottom:1px solid var(--border);
  background:var(--paper2); flex-shrink:0;
}
.memo-front-form {
  flex:1; overflow-y:auto; padding:12px 14px;
  display:flex; flex-direction:column; gap:9px;
}
.memo-row-lbl { font-size:9px; color:var(--muted); letter-spacing:0.1em; margin-bottom:3px; }
.memo-color-row { display:flex; gap:6px; flex-wrap:wrap; }
.color-dot {
  width:18px; height:18px; border-radius:50%;
  cursor:pointer; box-shadow:0 0 0 1px rgba(0,0,0,0.12);
  flex-shrink:0; transition:transform 0.1s;
}
.color-dot:hover { transform:scale(1.15); }
.color-dot.sel { box-shadow:0 0 0 2px var(--accent2), 0 0 0 4px #fff inset; }
.memo-emoji-row { display:flex; flex-wrap:wrap; gap:3px; }
.em-btn {
  font-size:19px; background:none; border:1px solid transparent;
  border-radius:3px; cursor:pointer; padding:2px 3px; line-height:1;
}
.em-btn:hover { background:var(--hover); border-color:var(--border); }
.em-btn.sel { background:var(--active-bg); border-color:var(--accent2); }
.memo-sel-emoji { font-size:26px; min-width:34px; }
.memo-input { width:100%; padding:6px 10px; border:1px solid var(--border); background:var(--paper2); font-family:'Noto Serif JP',serif; font-size:12px; color:var(--ink); }
.memo-textarea { width:100%; padding:7px 10px; border:1px solid var(--border); background:var(--paper2); font-family:'Noto Serif JP',serif; font-size:12px; color:var(--ink); resize:none; line-height:1.9; }
.memo-editor-ta { width:100%; padding:10px 14px; border:1px solid var(--border); background:var(--paper); font-family:'Noto Serif JP',serif; font-size:13px; line-height:2.0; color:var(--ink); outline:none; box-sizing:border-box; }
.memo-editor-ta:focus { border-color:var(--accent2); background:#fffdf8; }
.memo-editor-ta::placeholder { color:#c8bfb0; }
.memo-back-ta { flex:1; padding:16px; border:none; outline:none; resize:none; font-family:'Noto Serif JP',serif; font-size:12px; line-height:2; color:var(--ink); background:var(--paper); width:100%; }
.memo-modal-foot {
  padding:10px 18px; border-top:1px solid var(--border);
  display:flex; gap:8px; justify-content:flex-end;
  background:var(--paper2); flex-shrink:0;
}
/* ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
.memo-tb {
  display:flex; align-items:center; gap:2px; padding:2px 6px;
  border-bottom:1px solid var(--border); background:var(--paper2);
  flex-wrap:wrap; flex-shrink:0;
}
.memo-tb .tb-btn { font-size:11px; padding:1px 4px; }
.memo-tb .tb-sep { width:1px; background:var(--border); height:14px; margin:0 2px; flex-shrink:0; }
.memo-tb .tb-label { font-size:8px; color:var(--muted); }
/* ãƒ¡ã‚¿ãƒãƒ¼ï¼ˆã‚«ãƒ©ãƒ¼ãƒ»ãƒãƒ¼ã‚¯ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¿ã‚° 1è¡Œï¼‰ */
.memo-meta-bar {
  display:flex; align-items:center; gap:6px; padding:6px 12px;
  border-bottom:1px solid var(--border); background:var(--paper2);
  flex-shrink:0; flex-wrap:wrap;
}
.memo-meta-emoji-preview {
  font-size:20px; min-width:24px; text-align:center; cursor:pointer;
  border:1px solid transparent; border-radius:3px; padding:1px 2px;
}
.memo-meta-emoji-preview:hover { border-color:var(--border); background:var(--hover); }
/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆã‚«ãƒ©ãƒ¼ãƒ»çµµæ–‡å­—ï¼‰ */
.memo-popup {
  display:none; position:fixed; z-index:1100;
  background:var(--paper); border:1px solid var(--border);
  border-radius:3px; padding:8px 10px; box-shadow:0 4px 16px rgba(0,0,0,0.15);
  max-width:260px;
}
.memo-popup.show { display:block; }
.memo-popup-title { font-size:9px; color:var(--muted); letter-spacing:0.1em; margin-bottom:6px; }
/* ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ */
.memo-title-input { flex:1; min-width:100px; padding:3px 8px; border:none; border-bottom:1px solid var(--border); background:transparent; font-family:'Noto Serif JP',serif; font-size:13px; font-weight:600; color:var(--ink); outline:none; }
.memo-title-input:focus { border-bottom-color:var(--accent2); }
.memo-title-input::placeholder { color:#c8bfb0; font-weight:400; }
/* ã‚¿ã‚°å…¥åŠ›ï¼ˆãƒ¡ã‚¿ãƒãƒ¼å†…ï¼‰ */
.memo-tag-input-sm { width:110px; padding:2px 6px; border:1px solid var(--border); background:var(--paper); font-family:sans-serif; font-size:10px; color:var(--ink); outline:none; border-radius:2px; }
.memo-tag-input-sm:focus { border-color:var(--accent2); }
/* æœ¬æ–‡textarea */
.memo-body-ta { flex:1; padding:12px 16px; border:none; outline:none; resize:none; font-family:'Noto Serif JP',serif; font-size:12px; line-height:2.0; color:var(--ink); background:var(--paper); width:100%; min-height:0; scrollbar-width:none; }
.memo-body-ta::-webkit-scrollbar { display:none; }
.empty-board { flex:1; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; color:var(--muted); }
.empty-board .eicon { font-size:40px; opacity:0.25; }
.empty-board p { font-size:12px; opacity:0.5; }

#memoScrollTopBtn {
  position:fixed; bottom:24px; right:20px; z-index:800;
  background:var(--paper2); color:var(--muted); border:1px solid var(--border);
  border-radius:50%; width:36px; height:36px; font-size:14px;
  cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.1);
  display:none; align-items:center; justify-content:center;
}
.cheki-link { color: var(--accent2); text-decoration: underline; word-break: break-all; font-size: inherit; }
.cheki-link:hover { color: var(--accent); }
#memoScrollTopBtn.visible { display:flex; }
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">ğŸ““ å‰µä½œãƒãƒ¼ãƒˆ</div>
  <div class="header-search">
    <span style="opacity:0.4;font-size:11px;">ğŸ”</span>
    <input type="text" id="searchInput" placeholder="æ¤œç´¢â€¦" oninput="renderList()" />
  </div>
  <div class="header-actions">
    <button class="dual-toggle" id="dualToggle" onclick="toggleDual()">è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰</button>
    <button class="save-all-btn" id="saveAllBtn" onclick="saveAll()" title="å‰µä½œãƒãƒ¼ãƒˆã¨ã“ã¨ã°è¾å…¸ã‚’ä¸¡æ–¹ä¿å­˜">ğŸ’¾ ä¸€æ‹¬ä¿å­˜</button>
    <span class="api-badge" onclick="showModal('apiModal')" id="apiBadge">APIæœªè¨­å®š</span>
    <a href="index.html" class="hdr-link">â† ã“ã¨ã°è¾å…¸</a>
  </div>
</div>

<div class="main-tab-bar">
  <button class="main-tab-btn active" id="mtbNote" onclick="switchMainTab('note')">ğŸ““ ãƒãƒ¼ãƒˆ</button>
  <button class="main-tab-btn" id="mtbMemo" onclick="switchMainTab('memo')">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ãƒ¡ãƒ¢</button>
</div>

<div class="main-tab-page active" id="mtpNote">
<div class="app-body">
  <div class="sidebar">
    <div class="sidebar-toolbar">
      <select class="cat-filter" id="catFilter" onchange="renderList()">
        <option value="">ã™ã¹ã¦</option>
        <option value="ãƒ«ãƒ¼ãƒ«">ãƒ«ãƒ¼ãƒ«</option>
        <option value="æ¦‚å¿µãƒ¡ãƒ¢">æ¦‚å¿µãƒ¡ãƒ¢</option>
        <option value="ã‚­ãƒ£ãƒ©èªéŒ²">ã‚­ãƒ£ãƒ©èªéŒ²</option>
        <option value="ç·´ç¿’èª²é¡Œ">ç·´ç¿’èª²é¡Œ</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <button class="sidebar-add-btn" onclick="showAddModal(null)">ï¼‹</button>
    </div>
    <div class="tag-bar" id="tagBar"></div>
    <div class="note-list" id="noteList"></div>
  </div>

  <div class="main-pane" id="mainPane">
    <div class="editor-pane" id="paneA"
      ondragover="onDragOverPane(event,'A')" ondragleave="onDragLeavePane(event,'A')" ondrop="onDropPane(event,'A')" ondragend="onDragEnd(event)">
      <div class="editor-pane-header" id="paneAHeader" style="display:none;">
        <span class="editor-pane-label" style="color:var(--accent2);">å·¦ / è¦ª</span>
        <select class="pane-note-select" id="paneASelect" onchange="loadNoteToPane('A',this.value)">
          <option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>
        </select>
        <button class="tb-btn wide" onclick="createChildFromParent()" id="addChildBtn" title="ã“ã®ãƒšãƒ¼ã‚¸ã®å­ãƒãƒ¼ãƒˆã‚’ä½œã‚‹" style="display:none;white-space:nowrap;font-size:10px;padding:3px 8px;background:var(--accent);color:#fff;border-color:var(--accent);">ï¼‹ å­ãƒšãƒ¼ã‚¸</button>
      </div>
      <div class="editor-wrap" id="editorWrapA" style="display:none;">
        <div class="editor-meta-bar">
          <input class="editor-title-input" id="titleA" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" oninput="markDirty('A')" />
          <select class="type-select" id="typeA" onchange="markDirty('A')">
            <option>ãƒ«ãƒ¼ãƒ«</option><option>æ¦‚å¿µãƒ¡ãƒ¢</option><option>ã‚­ãƒ£ãƒ©èªéŒ²</option><option>ç·´ç¿’èª²é¡Œ</option><option>ãã®ä»–</option>
          </select>
          <input class="editor-tag-input" id="tagsA" placeholder="ã‚¿ã‚°" oninput="markDirty('A')" />
          <button class="editor-clear-btn" onclick="clearPane('A')" title="å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢">âœ•ã‚¯ãƒªã‚¢</button>
          <button class="editor-save-btn" id="saveBtnA" onclick="savePane('A')">ä¿å­˜</button>
        </div>
        <div class="toolbar" id="toolbarA"></div>
        <textarea class="editor-body" id="bodyA" placeholder="ã“ã“ã«æ›¸ãâ€¦&#10;&#10;ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰ç½«ç·šãƒ»çµµæ–‡å­—ãƒ»å®šå‹æ–‡ã‚’æŒ¿å…¥ã§ãã¾ã™" oninput="markDirty('A');autoSave('A')"></textarea>
        <div class="child-notes-section" id="childSectionA"></div>
      </div>
      <div class="empty-pane" id="emptyA">
        <div class="icon">ğŸ“„</div>
        <p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ¼ãƒˆã‚’é¸ã¶<br>ã¾ãŸã¯ ï¼‹ ã§è¿½åŠ </p>
      </div>
    </div>
    <div class="editor-pane" id="paneB" style="display:none;"
      ondragover="onDragOverPane(event,'B')" ondragleave="onDragLeavePane(event,'B')" ondrop="onDropPane(event,'B')" ondragend="onDragEnd(event)">
      <div class="editor-pane-header" id="paneBHeader">
        <span class="editor-pane-label" id="paneBLabel">å³</span>
        <div id="paneBPageBtns" style="display:flex;gap:3px;flex-wrap:wrap;flex:1;overflow-x:auto;"></div>
        <select class="pane-note-select" id="paneBSelect" onchange="loadNoteToPane('B',this.value)" style="display:none;">
          <option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>
        </select>
      </div>
      <div class="editor-wrap" id="editorWrapB" style="display:none;">
        <div class="editor-meta-bar">
          <input class="editor-title-input" id="titleB" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" oninput="markDirty('B')" />
          <select class="type-select" id="typeB" onchange="markDirty('B')">
            <option>ãƒ«ãƒ¼ãƒ«</option><option>æ¦‚å¿µãƒ¡ãƒ¢</option><option>ã‚­ãƒ£ãƒ©èªéŒ²</option><option>ç·´ç¿’èª²é¡Œ</option><option>ãã®ä»–</option>
          </select>
          <input class="editor-tag-input" id="tagsB" placeholder="ã‚¿ã‚°" oninput="markDirty('B')" />
          <button class="editor-clear-btn" onclick="clearPane('B')" title="å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢">âœ•ã‚¯ãƒªã‚¢</button>
          <button class="editor-save-btn" id="saveBtnB" onclick="savePane('B')">ä¿å­˜</button>
        </div>
        <div class="toolbar" id="toolbarB"></div>
        <textarea class="editor-body" id="bodyB" placeholder="ã“ã“ã«æ›¸ãâ€¦" oninput="markDirty('B');autoSave('B')"></textarea>
        <div class="child-notes-section" id="childSectionB"></div>
      </div>
      <div class="empty-pane" id="emptyB">
        <div class="icon">ğŸ“„</div>
        <p>å³ãƒšã‚¤ãƒ³ã®ãƒãƒ¼ãƒˆã‚’é¸æŠ</p>
      </div>
    </div>
  </div>

</div><!-- /app-body -->
</div><!-- /mtpNote -->

<div class="main-tab-page" id="mtpMemo">
  <div class="memo-filter-bar">
    <input type="text" id="memoSearch" placeholder="ãƒ¡ãƒ¢ã‚’æ¤œç´¢â€¦" oninput="renderMemoBoard()" />
    <div id="memoTagWrap" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
    <span id="memoCount" style="font-size:10px;color:var(--muted);margin-left:auto;white-space:nowrap;"></span>
  </div>
  <div class="memo-board" id="memoBoard">
    <div class="empty-board">
      <div class="eicon">ğŸ’¡</div>
      <p>ï¼‹ ãƒœã‚¿ãƒ³ã§ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã‚’è¿½åŠ </p>
    </div>
  </div>
</div><!-- /mtpMemo -->
<div class="ai-pane" id="aiPane">
  <div class="ai-toggle" onclick="toggleAi()">
    <span>ğŸ¤– AIã«è³ªå•ã™ã‚‹</span>
    <span class="ai-arrow" id="aiArrow">â–¼</span>
    <span style="font-size:9px;margin-left:auto;" id="aiProvLabel"></span>
  </div>
  <div class="ai-body">
    <div class="ai-input-wrap">
      <textarea class="ai-question" id="aiQuestion" placeholder="ç–‘å•ãƒ»æ‚©ã¿ã‚’æ›¸ãâ€¦ ä¾‹ï¼šä¸‰äººç§°ã§å†…é¢ã‚’æ›¸ãã¨ãè¦–ç‚¹ãƒ–ãƒ¬ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ"></textarea>
      <div class="ai-actions-row">
        <button class="ai-prov-btn active" id="provGemini" onclick="setAiProv('gemini')">Gemini</button>
        <button class="ai-prov-btn" id="provClaude" onclick="setAiProv('claude')">Claude</button>
        <button class="ai-ask-btn" id="askBtn" onclick="askAI()">è³ªå•ã™ã‚‹ â†’</button>
      </div>
    </div>
    <div class="ai-answer-wrap">
      <div class="ai-answer" id="aiAnswer"><span style="color:#c8bfb0;font-size:11px;">å›ç­”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</span></div>
      <div class="ai-answer-btns" id="aiAnswerBtns" style="display:none;">
        <button class="ai-ans-btn secondary" onclick="copyAiAnswer()">ã‚³ãƒ”ãƒ¼</button>
        <button class="ai-ans-btn primary" onclick="saveAiAsNote()">ãƒãƒ¼ãƒˆã«ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h2>API ã‚­ãƒ¼è¨­å®š</h2>
    <div class="modal-field"><label>Gemini API Key</label><input type="password" id="geminiKeyInput" placeholder="AIzaSy..." /></div>
    <div class="modal-field"><label>Claude API Key</label><input type="password" id="claudeKeyInput" placeholder="sk-ant-..." /></div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="saveApiKeys()">ä¿å­˜</button>
      <button class="btn-secondary" onclick="closeModal('apiModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h2 id="addModalTitle">æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ </h2>
    <div class="add-type-track" id="addTypeTrack">
      <button class="add-type-btn active" data-type="ãƒ«ãƒ¼ãƒ«" onclick="setAddType(this)">ãƒ«ãƒ¼ãƒ«</button>
      <button class="add-type-btn" data-type="æ¦‚å¿µãƒ¡ãƒ¢" onclick="setAddType(this)">æ¦‚å¿µãƒ¡ãƒ¢</button>
      <button class="add-type-btn" data-type="ã‚­ãƒ£ãƒ©èªéŒ²" onclick="setAddType(this)">ã‚­ãƒ£ãƒ©èªéŒ²</button>
      <button class="add-type-btn" data-type="ç·´ç¿’èª²é¡Œ" onclick="setAddType(this)">ç·´ç¿’èª²é¡Œ</button>
      <button class="add-type-btn" data-type="ãã®ä»–" onclick="setAddType(this)">ãã®ä»–</button>
    </div>
    <div class="modal-field"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="addTitle" /></div>
    <div class="modal-field"><label>å†…å®¹</label><textarea id="addBody"></textarea></div>
    <div class="modal-field"><label>ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label><input type="text" id="addTags" placeholder="è¦–ç‚¹ ä¸‰äººç§° åŸºæœ¬" /></div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="addNote()">è¿½åŠ ã™ã‚‹</button>
      <button class="btn-secondary" onclick="closeModal('addModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div class="snippet-panel" id="snippetPanel">
  <h4>ğŸ“‹ å®šå‹æ–‡ãƒ»ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</h4>
  <div class="snippet-grid" id="snippetGrid"></div>
  <div class="snippet-add">
    <input type="text" id="snippetNewInput" placeholder="æ–°ã—ã„å®šå‹æ–‡ã‚’è¿½åŠ â€¦" />
    <button class="snippet-add-btn" onclick="addSnippet()">ï¼‹</button>
  </div>
</div>

<button id="scrollTopBtn" onclick="scrollToTop()" title="æœ€ä¸Šéƒ¨ã¸">â†‘</button>
<div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
// â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notes=[], currentNoteId={A:null,B:null}, dualMode=false;
let isDirty={A:false,B:false}, autoSaveTimers={A:null,B:null};
let geminiKey='', claudeKey='', aiProvider='gemini';
let currentAddType='ãƒ«ãƒ¼ãƒ«', addParentId=null, activeTagFilter='';
let snippets=[], snippetTargetPane='A', dragId=null;

const INIT = [
  {id:1,type:'ãƒ«ãƒ¼ãƒ«',title:'å°èª¬ç”¨ãƒ»è¶…ç°¡ç•¥ãƒ«ãƒ¼ãƒ«',body:'â‘  ã¾ãšæ±ºã‚ã‚‹ã®ã¯ã“ã‚Œã ã‘\nã“ã®ç« ã¯èª°ã®è¦–ç‚¹ã‹ï¼Ÿ\nâ†’ åå‰ã‚’æ›¸ã„ã¦ã‹ã‚‰æ›¸ãã€‚\n\nâ‘¡ ãã®ç« ã§ã‚„ã£ã¦ã„ã„ã“ã¨\nâœ” ãã®äººã®å†…é¢ã‚’æ›¸ã\nâœ” ãã®äººã®æ„Ÿæƒ…ã‚’æ›¸ã\nâœ” ãã®äººã®è§£é‡ˆã‚’æ›¸ã\n\nâ‘¢ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨\nâœ˜ ä»–äººã®æœ¬å¿ƒã‚’æ–­å®šã™ã‚‹\nâœ˜ æœªæ¥ã‚’èª¬æ˜ã™ã‚‹\nâœ˜ ç¥ã®ã‚ˆã†ã«å…¨ä½“ã‚’èªã‚‹\n\nâ‘£ ä¸‰äººç§°ã§è¿·ã£ãŸã‚‰\næ„Ÿæƒ…ã‚’ã€Œèº«ä½“ã€ã§æ›¸ãã€‚\nÃ— æ‚²ã—ã‹ã£ãŸã€€â—‹ å–‰ãŒè©°ã¾ã£ãŸ\nÃ— æ‹’çµ¶ã•ã‚ŒãŸã¨æ€ã£ãŸã€€â—‹ æ‰‹ãŒå®™ã«æ®‹ã£ãŸ\n\nâ‘¤ æœ€çŸ­ç·´ç¿’\n1ã¤ã®æ„Ÿæƒ…ã‚’3é€šã‚Šã§æ›¸ãã€‚\nä¾‹ï¼šæ‹’çµ¶\nãƒ»è¡€ã®æ°—ãŒå¼•ã ãƒ»è¶³å…ƒãŒæºã‚Œã‚‹ ãƒ»è¨€è‘‰ãŒå‡ºãªã„\n\nâ‘¥ æœ€é‡è¦ãƒ«ãƒ¼ãƒ«\nç« ï¼1äººã€€å†…é¢ï¼ãã®äººã ã‘',tags:['è¦–ç‚¹','ä¸‰äººç§°','åŸºæœ¬'],parentId:null,childIds:[3],order:0,date:'2026-02-22'},
  {id:2,type:'æ¦‚å¿µãƒ¡ãƒ¢',title:'äººç§°ã¨è¦–ç‚¹ã®é•ã„',body:'â–  çµè«–\näººç§°ï¼èª°ã®è¨€è‘‰ã§æ›¸ã„ã¦ã„ã‚‹ã‹ï¼ˆæ–‡æ³•ï¼‰\nè¦–ç‚¹ï¼èª°ã®é ­ã®ä¸­ã¾ã§å…¥ã£ã¦ã„ã‚‹ã‹ï¼ˆæƒ…å ±ã®ç¯„å›²ï¼‰\nåˆ¥ç‰©ã€‚\n\nâ–  äººç§°ã¨ã¯\nä¸€äººç§°ï¼šä¿ºã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚\nä¸‰äººç§°ï¼šå½¼ã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚\n\nâ–  è¦–ç‚¹ã¨ã¯ï¼ˆã‚«ãƒ¡ãƒ©ã®ä½ç½®ï¼‰\nä¸‰äººç§°ãƒ»ä¸»äººå…¬è¦–ç‚¹ï¼šå½¼ã®é ­ã ã‘ã«å…¥ã‚‹ã€‚\nä¸‰äººç§°ãƒ»ç¥è¦–ç‚¹ï¼šå…¨å“¡ã®å†…é¢ã«å…¥ã‚Œã‚‹ã€‚\n\nâ–  è¦šãˆæ–¹\näººç§°ï¼ãƒ©ãƒ™ãƒ«ã€€è¦–ç‚¹ï¼ã‚«ãƒ¡ãƒ©ä½ç½®\nãƒ©ãƒ™ãƒ«ã¨ã‚«ãƒ¡ãƒ©ã¯åˆ¥ã€‚',tags:['è¦–ç‚¹','äººç§°','æ¦‚å¿µæ•´ç†'],parentId:null,childIds:[],order:1,date:'2026-02-22'},
  {id:3,type:'ã‚­ãƒ£ãƒ©èªéŒ²',title:'ä¸‡ãƒ»è‘‰ã®è¨€è‘‰',body:'ä¸‡ã€Œè¤‡é›‘ã«è€ƒãˆã‚‹ãªã€‚ç®¡ç†ã™ã‚‹ã®ã¯è¦–ç‚¹äººç‰©ã ã‘ã ã€‚ã€\n\nè‘‰ã€Œè¾æ›¸ã£ã¦ã•ã€è¿·ã£ãŸã¨ãæˆ»ã‚‹å ´æ‰€ã§ã„ã„ã‚“ã ã‚ˆã€‚ã€\n\nè‘‰ã€Œä¸‰äººç§°ã£ã¦ã­ã€å¤–ã‹ã‚‰å‘¼ã‚“ã§ã‚‹ã‘ã©ã€ä¸­ã«ã¯å…¥ã£ã¦ã‚‹çŠ¶æ…‹ãªã‚“ã ã€‚ã€\n\nä¸‡ã€Œå®šç¾©ã‚’åˆ†è§£ã™ã‚‹ã€‚æ„Ÿè¦šã§ã¯ãªãæ§‹é€ ã§ç†è§£ã—ã‚ã€‚ã€',tags:['ä¸‡','è‘‰','èªéŒ²'],parentId:1,childIds:[],order:2,date:'2026-02-22'},
  {id:4,type:'ç·´ç¿’èª²é¡Œ',title:'1æ„Ÿæƒ…ã‚’3é€šã‚Šã§æ›¸ã',body:'ãƒ«ãƒ¼ãƒ«ï¼šæ„Ÿæƒ…èªã‚’ä½¿ã‚ãšã€èº«ä½“ãƒ»è¡Œå‹•ãƒ»æƒ…æ™¯ã§æ›¸ãã€‚\n\nä¾‹ï¼šæ‹’çµ¶\nãƒ»è¡€ã®æ°—ãŒå¼•ã\nãƒ»è¶³å…ƒãŒæºã‚Œã‚‹\nãƒ»è¨€è‘‰ãŒå‡ºãªã„\n\nç·´ç¿’ï¼šã€Œæ‚²ã—ã¿ã€ã€Œæ€’ã‚Šã€ã€Œææ€–ã€ã€Œå–œã³ã€ã€Œå­¤ç‹¬ã€',tags:['ç·´ç¿’','è¡¨ç¾','èº«ä½“æå†™'],parentId:null,childIds:[],order:3,date:'2026-02-22'}
];
const DEF_SNIPPETS=['â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»','ã€ã€€ã€‘','â–  ','â–¶ ','â—† ','â€» ','ğŸ“Œ ','ğŸ’¡ ','âš ï¸ ','â“ ','âœ¨ ','ğŸ”– ','ğŸ“ ','ğŸ’¬ ','ğŸ¯ ','ğŸŒ¿ ','ğŸŒ™ ','ğŸ”¥ ','â†’ ','â‡’ '];

// â”€â”€â”€ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save(){localStorage.setItem('craft_v2',JSON.stringify({notes,geminiKey,claudeKey,aiProvider,snippets,dualMode,dualSubMode}));}

function saveAll(){
  const date = new Date().toISOString().slice(0,10);
  // â‘  å‰µä½œãƒãƒ¼ãƒˆã‚’localStorageã«ä¿å­˜
  save();
  // â‘¡ å‰µä½œãƒãƒ¼ãƒˆJSONã‚’DL
  const craftData = JSON.parse(localStorage.getItem('craft_v2')||'{}');
  craftData.exportedAt = new Date().toISOString();
  _dlJson(JSON.stringify(craftData, null, 2), `å‰µä½œãƒãƒ¼ãƒˆ_${date}.json`);
  // â‘¢ ã“ã¨ã°è¾å…¸JSONã‚’localStorageã‹ã‚‰å–å¾—ã—ã¦DLï¼ˆå°‘ã—é…å»¶ã—ã¦é€£ç¶šDLã‚’é¿ã‘ã‚‹ï¼‰
  setTimeout(()=>{
    try {
      const idxRaw = localStorage.getItem('kotoba_jiten_v2');
      if(idxRaw){
        const idxData = JSON.parse(idxRaw);
        idxData.exportedAt = new Date().toISOString();
        _dlJson(JSON.stringify(idxData, null, 2), `ã“ã¨ã°äº‹å…¸_${date}.json`);
      }
    } catch(e){}
  }, 300);
  // â‘£ ãƒœã‚¿ãƒ³ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  const btn=document.getElementById('saveAllBtn');
  btn.textContent='âœ“ ä¿å­˜å®Œäº†'; btn.classList.add('done');
  showToast();
  setTimeout(()=>{ btn.textContent='ğŸ’¾ ä¸€æ‹¬ä¿å­˜'; btn.classList.remove('done'); }, 2500);
}
function _dlJson(jsonStr, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([jsonStr], { type: 'application/json' }));
  a.download = filename; a.click();
}
function load(){
  try{
    const d=JSON.parse(localStorage.getItem('craft_v2')||'{}');
    notes=d.notes?.length?d.notes:JSON.parse(JSON.stringify(INIT));
    geminiKey=d.geminiKey||'';claudeKey=d.claudeKey||'';aiProvider=d.aiProvider||'gemini';
    snippets=d.snippets?.length?d.snippets:[...DEF_SNIPPETS];
    dualMode=d.dualMode||false;
    dualSubMode=d.dualSubMode||'free';
  }catch{
    notes=JSON.parse(JSON.stringify(INIT));
    snippets=[...DEF_SNIPPETS];
    dualMode=false;
    dualSubMode='free';
  }
  notes.forEach(n=>{if(!n.childIds)n.childIds=[];if(n.parentId===undefined)n.parentId=null;});
  updateApiBadge();setAiProv(aiProvider);if(dualMode)enableDual();
}

// â”€â”€â”€ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æŒ¿å…¥ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§å‚ç…§ï¼‰
const INSERTS = [
  '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n',
  '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•\n',
  '\nãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»\n',
  'â–  ', 'â–¶ ', 'â—† ', 'ã€ã€‘', 'â€» ', 'â†’ ', 'â‡’ ',
  'ğŸ“Œ ', 'ğŸ’¡ ', 'âš ï¸ ', 'â“ ', 'âœ¨ ', 'ğŸ”– ', 'ğŸ“ ', 'ğŸ’¬ ', 'ğŸ¯ ', 'ğŸŒ¿ ', 'ğŸŒ™ ', 'ğŸ”¥ '
];

function buildToolbar(p){
  const tb = document.getElementById('toolbar'+p);
  if(!tb) return;
  const groups = [
    {label:'ç½«ç·š', btns:[
      {text:'â”€', idx:0},{text:'â•', idx:1},{text:'â€¦', idx:2}
    ]},
    null,
    {label:'è¨˜å·', btns:[
      {text:'â– ', idx:3},{text:'â–¶', idx:4},{text:'â—†', idx:5},
      {text:'ã€ã€‘', idx:6},{text:'â€»', idx:7},{text:'â†’', idx:8},{text:'â‡’', idx:9}
    ]},
    null,
    {label:'ç•ªå·', btns:[
      {text:'â‘ ', fn:'insertSeq'},{text:'ï¼ˆä¸€ï¼‰', fn:'insertSeqK'}
    ]},
    null,
    {label:'çµµæ–‡å­—', btns:[
      {text:'ğŸ“Œ',idx:10},{text:'ğŸ’¡',idx:11},{text:'âš ï¸',idx:12},{text:'â“',idx:13},
      {text:'âœ¨',idx:14},{text:'ğŸ”–',idx:15},{text:'ğŸ“',idx:16},{text:'ğŸ’¬',idx:17},
      {text:'ğŸ¯',idx:18},{text:'ğŸŒ¿',idx:19},{text:'ğŸŒ™',idx:20},{text:'ğŸ”¥',idx:21}
    ]},
    null,
    {snippet:true}
  ];
  let h = '';
  for(const g of groups){
    if(!g){ h += '<div class="tb-sep"></div>'; continue; }
    if(g.snippet){ h += `<button class="tb-btn wide" onclick="toggleSnippet('${p}',this)">ğŸ“‹ å®šå‹æ–‡</button>`; continue; }
    h += `<span class="tb-label">${g.label}</span>`;
    for(const b of g.btns){
      if(b.fn) h += `<button class="tb-btn" data-pane="${p}" data-fn="${b.fn}" onclick="tbClick(this)">${b.text}</button>`;
      else     h += `<button class="tb-btn" data-pane="${p}" data-idx="${b.idx}" onclick="tbClick(this)">${b.text}</button>`;
    }
  }
  tb.innerHTML = h;
}

function tbClick(btn){
  const p = btn.dataset.pane;
  if(btn.dataset.fn){
    if(btn.dataset.fn === 'insertSeq') insertSeq(p);
    else insertSeqK(p);
  } else {
    insertAt(p, INSERTS[parseInt(btn.dataset.idx)]);
  }
}



function insertAt(p,text){
  const ta=document.getElementById('body'+p);if(!ta)return;
  const s=ta.selectionStart,e=ta.selectionEnd;
  ta.value=ta.value.slice(0,s)+text+ta.value.slice(e);
  ta.selectionStart=ta.selectionEnd=s+text.length;ta.focus();markDirty(p);
}

const SEQ=['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨','â‘©'];
const SEQK=['ï¼ˆä¸€ï¼‰','ï¼ˆäºŒï¼‰','ï¼ˆä¸‰ï¼‰','ï¼ˆå››ï¼‰','ï¼ˆäº”ï¼‰','ï¼ˆå…­ï¼‰','ï¼ˆä¸ƒï¼‰','ï¼ˆå…«ï¼‰','ï¼ˆä¹ï¼‰','ï¼ˆåï¼‰'];
let si={A:0,B:0},ski={A:0,B:0};
function insertSeq(p){insertAt(p,SEQ[si[p]%10]+' ');si[p]++;}
function insertSeqK(p){insertAt(p,SEQK[ski[p]%10]+' ');ski[p]++;}

function toggleSnippet(p,btn){
  snippetTargetPane=p;
  const panel=document.getElementById('snippetPanel');
  // åŒã˜ãƒšã‚¤ãƒ³ã§æ—¢ã«é–‹ã„ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
  if(panel.classList.contains('show') && panel.dataset.pane===p){
    panel.classList.remove('show'); panel.dataset.pane=''; return;
  }
  panel.dataset.pane=p;
  // ä¸€æ—¦éè¡¨ç¤ºã§æç”»ã—ã¦ã‚µã‚¤ã‚ºå–å¾—
  panel.style.visibility='hidden';
  panel.classList.add('show');
  renderSnippetPanel();
  const r=btn.getBoundingClientRect();
  const pw=panel.offsetWidth, ph=panel.offsetHeight;
  let top=r.bottom+4, left=r.left;
  if(left+pw>window.innerWidth-8) left=window.innerWidth-pw-8;
  if(left<8) left=8;
  if(top+ph>window.innerHeight-8) top=r.top-ph-4;
  if(top<8) top=8;
  panel.style.top=top+'px'; panel.style.left=left+'px';
  panel.style.visibility='';
}
function renderSnippetPanel(){
  const g=document.getElementById('snippetGrid');
  g.innerHTML=snippets.map((s,i)=>
    `<button class="snippet-item" onclick="useSnippet(${i})">${escHtml(s.replace(/\n/g,'â†µ'))}<span class="snippet-del" onclick="event.stopPropagation();deleteSnippet(${i})">Ã—</span></button>`
  ).join('');
  // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
  const inp=document.getElementById('snippetNewInput');
  if(inp) inp.value='';
}
function useSnippet(i){insertAt(snippetTargetPane,snippets[i]);document.getElementById('snippetPanel').classList.remove('show');}
function addSnippet(){
  const v=document.getElementById('snippetNewInput').value.trim();if(!v)return;
  snippets.push(v);save();renderSnippetPanel();
}
function deleteSnippet(i){snippets.splice(i,1);save();renderSnippetPanel();}
document.addEventListener('click',e=>{if(!e.target.closest('#snippetPanel')&&!e.target.closest('[onclick*="toggleSnippet"]'))document.getElementById('snippetPanel').classList.remove('show');});

// â”€â”€â”€ ãƒªã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function typeCls(t){return t==='ãƒ«ãƒ¼ãƒ«'?'type-rule':t==='æ¦‚å¿µãƒ¡ãƒ¢'?'type-concept':t==='ã‚­ãƒ£ãƒ©èªéŒ²'?'type-quote':t==='ç·´ç¿’èª²é¡Œ'?'type-drill':'type-other';}
function getChildren(pid){return notes.filter(n=>n.parentId===pid);}

function renderList(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const cat=document.getElementById('catFilter').value;
  function match(n){
    const selfOk=(!cat||n.type===cat)&&(!activeTagFilter||(n.tags||[]).includes(activeTagFilter))&&(!search||[n.title,n.body,...(n.tags||[])].join(' ').toLowerCase().includes(search));
    return selfOk||getChildren(n.id).some(c=>match(c));
  }
  const roots=notes.filter(n=>!n.parentId&&match(n)).sort((a,b)=>(a.order??0)-(b.order??0));
  document.getElementById('noteList').innerHTML=roots.map(n=>renderItem(n,0)).join('');
  const allTags=[...new Set(notes.flatMap(n=>n.tags||[]))].sort();
  document.getElementById('tagBar').innerHTML=allTags.map(t=>`<span class="tag-chip ${activeTagFilter===t?'active':''}" onclick="toggleTag('${t}')">#${t}</span>`).join('');
  updatePaneSelects();
}

function renderItem(n,depth){
  const ch=getChildren(n.id).sort((a,b)=>(a.order??0)-(b.order??0));
  const isA=n.id===currentNoteId.A,isB=n.id===currentNoteId.B;
  let html=`<div class="note-item ${(isA||isB)?'active':''}" data-id="${n.id}" draggable="true"
    onclick="openNote(${n.id})"
    ondragstart="onDragStart(event,${n.id})" ondragover="onDragOver(event)"
    ondrop="onDrop(event,${n.id})" ondragleave="onDragLeave(event)" ondragend="onDragEnd(event)"
    style="padding-left:${6+depth*14}px;">
    <span class="note-item-drag" title="ãƒ‰ãƒ©ãƒƒã‚°ï¼šå·¦2/3ã«è½ã¨ã™â†’ä¸¦ã³æ›¿ãˆã€€å³1/3ã«è½ã¨ã™â†’å­ã«ã™ã‚‹&#10;ã‚¨ãƒ‡ã‚£ã‚¿æ¬„ã«è½ã¨ã™â†’ãã®æ¬„ã§é–‹ã">â ¿</span>
    <div class="note-item-body">
      <div class="note-item-title">
        ${ch.length?`<span class="note-item-expand" onclick="event.stopPropagation();toggleCh(${n.id},this)">â–¶</span>`:'<span style="width:12px;display:inline-block;"></span>'}
        ${escHtml(n.title)}
        ${isA?'<span style="font-size:8px;color:var(--accent2);margin-left:2px;">[å·¦]</span>':''}
        ${isB?'<span style="font-size:8px;color:#2a5a8a;margin-left:2px;">[å³]</span>':''}
      </div>
      <div class="note-item-meta">
        <span class="note-item-type ${typeCls(n.type)}">${n.type}</span>
        ${(n.tags||[]).slice(0,2).map(t=>`<span>#${t}</span>`).join('')}
        ${ch.length?`<span style="color:var(--accent2);">å­${ch.length}</span>`:''}
      </div>
    </div>
    <span class="note-item-del" onclick="event.stopPropagation();deleteNote(${n.id})">Ã—</span>
  </div>`;
  if(ch.length){
    html+=`<div class="children-list" id="ch-${n.id}" style="display:none;">`+
      ch.map(c=>renderItem(c,depth+1)).join('')+
      `<div style="padding:3px 10px 5px ${20+depth*14}px;"><button style="font-size:9px;background:none;border:1px dashed var(--border);color:var(--muted);padding:2px 7px;cursor:pointer;" onclick="event.stopPropagation();showAddModal(${n.id})">ï¼‹ å­ãƒãƒ¼ãƒˆã‚’è¿½åŠ </button></div>
    </div>`;
  }
  return html;
}

function toggleCh(id,el){
  const c=document.getElementById('ch-'+id);if(!c)return;
  const open=c.style.display!=='none';c.style.display=open?'none':'block';el.textContent=open?'â–¶':'â–¼';
}

// â”€â”€â”€ ãƒãƒ¼ãƒˆé–‹é–‰ãƒ»ç·¨é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNote(id,pane){
  if(!pane)pane='A';
  if(isDirty[pane]&&currentNoteId[pane])savePane(pane,true);
  currentNoteId[pane]=id;
  const n=notes.find(x=>x.id===id);if(!n)return;
  document.getElementById('title'+pane).value=n.title;
  document.getElementById('type'+pane).value=n.type;
  document.getElementById('tags'+pane).value=(n.tags||[]).join(' ');
  document.getElementById('body'+pane).value=n.body||'';
  document.getElementById('editorWrap'+pane).style.display='flex';
  document.getElementById('empty'+pane).style.display='none';
  isDirty[pane]=false;
  const btn=document.getElementById('saveBtn'+pane);btn.textContent='ä¿å­˜';btn.classList.remove('saved');
  si[pane]=0;ski[pane]=0;
  renderChildSection(pane,n);renderList();
  // è¦ªå­ãƒ¢ãƒ¼ãƒ‰: å·¦ãƒšã‚¤ãƒ³ãŒå¤‰ã‚ã£ãŸã‚‰å³ãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒœã‚¿ãƒ³æ›´æ–°
  if(dualMode && dualSubMode==='parent-child'){
    if(pane==='A'){
      // å³ãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
      if(isDirty.B && currentNoteId.B) savePane('B', true);
      currentNoteId.B = null;
      document.getElementById('editorWrapB').style.display = 'none';
      document.getElementById('emptyB').style.display = 'flex';
      renderChildPageBtns(id);
    } else if(pane==='B'){
      renderChildPageBtns(currentNoteId.A);
    }
  }
}
function loadNoteToPane(p,v){if(v)openNote(parseInt(v),p);}
function markDirty(p){isDirty[p]=true;const b=document.getElementById('saveBtn'+p);b.textContent='â— ä¿å­˜';b.classList.remove('saved');}
function autoSave(p){clearTimeout(autoSaveTimers[p]);autoSaveTimers[p]=setTimeout(()=>{if(isDirty[p])savePane(p,true);},2000);}
function savePane(p,silent=false){
  const id=currentNoteId[p];if(!id)return;
  const n=notes.find(x=>x.id===id);if(!n)return;
  n.title=document.getElementById('title'+p).value.trim()||'ï¼ˆç„¡é¡Œï¼‰';
  n.type=document.getElementById('type'+p).value;
  n.tags=document.getElementById('tags'+p).value.trim().split(/\s+/).filter(Boolean);
  n.body=document.getElementById('body'+p).value;
  n.date=new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'});
  isDirty[p]=false;save();renderList();
  if(!silent){const b=document.getElementById('saveBtn'+p);b.textContent='âœ“ ä¿å­˜æ¸ˆã¿';b.classList.add('saved');setTimeout(()=>{b.textContent='ä¿å­˜';b.classList.remove('saved');},2000);showToast();}
}

function renderChildSection(p,n){
  const sec=document.getElementById('childSection'+p);if(!sec)return;
  const ch=getChildren(n.id);
  sec.innerHTML=`<div class="child-notes-header"><span class="child-notes-title">ğŸ“ å­ãƒãƒ¼ãƒˆ</span><button class="child-add-btn" onclick="showAddModal(${n.id})">ï¼‹ è¿½åŠ </button></div>
  <div class="child-list">${ch.length===0?'<span style="font-size:11px;color:var(--muted);">ãªã—</span>':
    ch.map(c=>`<div class="child-chip" onclick="openNote(${c.id},'${p}')"><span class="note-item-type ${typeCls(c.type)}" style="font-size:8px;">${c.type}</span>${escHtml(c.title)}<span class="child-chip-del" onclick="event.stopPropagation();unlinkChild(${c.id},${n.id})">Ã—</span></div>`).join('')}
  </div>`;
}

function unlinkChild(cid,pid){
  const c=notes.find(n=>n.id===cid),p=notes.find(n=>n.id===pid);
  if(c)c.parentId=null;if(p)p.childIds=(p.childIds||[]).filter(x=>x!==cid);
  save();renderList();
  const pane=currentNoteId.A===pid?'A':currentNoteId.B===pid?'B':null;
  if(pane&&p)renderChildSection(pane,p);
}

// â”€â”€â”€ è¿½åŠ ãƒ»å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddModal(pid){
  addParentId=pid;
  document.getElementById('addModalTitle').textContent=pid?'å­ãƒãƒ¼ãƒˆã‚’è¿½åŠ ':'æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ ';
  ['addTitle','addBody','addTags'].forEach(id=>document.getElementById(id).value='');
  showModal('addModal');setTimeout(()=>document.getElementById('addTitle').focus(),50);
}
function setAddType(btn){document.querySelectorAll('#addTypeTrack .add-type-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentAddType=btn.dataset.type;}
function addNote(){
  const title=document.getElementById('addTitle').value.trim();
  const body=document.getElementById('addBody').value.trim();
  const tags=document.getElementById('addTags').value.trim().split(/\s+/).filter(Boolean);
  const n={id:Date.now(),type:currentAddType,title:title||'ï¼ˆç„¡é¡Œï¼‰',body,tags,parentId:addParentId||null,childIds:[],order:addParentId?999:-1,date:new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'})};
  if(!addParentId)notes.forEach(x=>{if(!x.parentId)x.order=(x.order??0)+1;});
  n.order=addParentId?999:0;notes.push(n);
  if(addParentId){const p=notes.find(x=>x.id===addParentId);if(p){if(!p.childIds)p.childIds=[];p.childIds.push(n.id);}}
  save();closeModal('addModal');renderList();openNote(n.id,addParentId?(currentNoteId.B?'B':'A'):'A');
}
function clearPane(p) {
  const titleEl = document.getElementById('title'+p);
  const tagsEl  = document.getElementById('tags'+p);
  const bodyEl  = document.getElementById('body'+p);
  if (!titleEl || !bodyEl) return;
  titleEl.value = '';
  tagsEl.value  = '';
  bodyEl.value  = '';
  markDirty(p);
  titleEl.focus();
}

function deleteNote(id){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  const n=notes.find(x=>x.id===id);
  if(n?.parentId){const p=notes.find(x=>x.id===n.parentId);if(p)p.childIds=(p.childIds||[]).filter(c=>c!==id);}
  notes.filter(x=>x.parentId===id).forEach(x=>x.parentId=null);
  notes=notes.filter(x=>x.id!==id);
  ['A','B'].forEach(p=>{if(currentNoteId[p]===id){currentNoteId[p]=null;document.getElementById('editorWrap'+p).style.display='none';document.getElementById('empty'+p).style.display='flex';}});
  save();renderList();
}

// â”€â”€â”€ è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// dualSubMode: 'free'=è‡ªç”±é…ç½®, 'parent-child'=è¦ªå­é€£å‹•
let dualSubMode = 'free';

function toggleDual(){
  if(!dualMode){ dualMode=true; enableDual(); }
  else if(dualSubMode==='free'){ dualSubMode='parent-child'; applyDualSubMode(); }
  else { dualMode=false; dualSubMode='free'; disableDual(); }
  save();
}

function enableDual(){
  document.getElementById('paneB').style.display='flex';
  document.getElementById('paneAHeader').style.display='flex';
  document.getElementById('dualToggle').classList.add('on');
  applyDualSubMode();
  updatePaneSelects();
}

function applyDualSubMode(){
  const isPC = dualSubMode==='parent-child';
  // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«
  const tog = document.getElementById('dualToggle');
  if(!dualMode){ tog.textContent='è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰'; tog.classList.remove('on'); return; }
  tog.textContent = isPC ? 'è¦ªå­ãƒ¢ãƒ¼ãƒ‰ â—' : 'è‡ªç”±ãƒ¢ãƒ¼ãƒ‰ â—';

  // å³ãƒ‘ãƒãƒ«ãƒ©ãƒ™ãƒ«
  const lbl = document.getElementById('paneBLabel');
  if(lbl) lbl.textContent = isPC ? 'å³ / å­' : 'å³';

  // è‡ªç”±ãƒ¢ãƒ¼ãƒ‰: selectã‚’è¡¨ç¤º
  const selB = document.getElementById('paneBSelect');
  const pageBtns = document.getElementById('paneBPageBtns');
  const addChildBtn = document.getElementById('addChildBtn');
  if(selB) selB.style.display = isPC ? 'none' : '';
  if(pageBtns) pageBtns.style.display = isPC ? 'flex' : 'none';
  if(addChildBtn) addChildBtn.style.display = isPC ? '' : 'none';

  // è¦ªå­ãƒ¢ãƒ¼ãƒ‰: å·¦ã«è¦ªãŒé–‹ã„ã¦ã„ã‚Œã°å³ã«å­ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  if(isPC && currentNoteId.A) renderChildPageBtns(currentNoteId.A);
}

function disableDual(){
  if(isDirty.B) savePane('B',true);
  document.getElementById('paneB').style.display='none';
  document.getElementById('paneAHeader').style.display='none';
  const tog = document.getElementById('dualToggle');
  tog.textContent='è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰'; tog.classList.remove('on');
}

function renderChildPageBtns(parentId){
  const wrap = document.getElementById('paneBPageBtns');
  if(!wrap) return;
  const children = getChildren(parentId);
  const cur = currentNoteId.B;
  wrap.innerHTML = children.map(ch =>
    `<button style="font-size:10px;padding:3px 8px;border:1px solid var(--border);background:${ch.id===cur?'var(--accent)':'var(--paper)'};color:${ch.id===cur?'#fff':'var(--muted)'};cursor:pointer;white-space:nowrap;border-radius:1px;" onclick="openNote(${ch.id},'B')">${escHtml(ch.title)}</button>`
  ).join('') + (children.length===0 ? '<span style="font-size:10px;color:var(--muted);">å­ãƒšãƒ¼ã‚¸ãªã—ã€€â†’ã€€ï¼‹å­ãƒšãƒ¼ã‚¸ã§è¿½åŠ </span>' : '');
  // å­ãªã—ã®ã¨ãå³ãƒšã‚¤ãƒ³ã«ã€Œç©ºã€è¡¨ç¤º
  if(children.length===0 && currentNoteId.B===null){
    document.getElementById('editorWrapB').style.display='none';
    document.getElementById('emptyB').style.display='flex';
  }
}

function createChildFromParent(){
  const parentId = currentNoteId.A;
  if(!parentId){ alert('å·¦ãƒšã‚¤ãƒ³ã«ãƒãƒ¼ãƒˆã‚’é–‹ã„ã¦ãã ã•ã„'); return; }
  const parent = notes.find(n=>n.id===parentId);
  if(!parent) return;
  const title = parent.title + ' - ' + (getChildren(parentId).length + 1);
  const n = {
    id: Date.now(), type: parent.type, title, body: '',
    tags: [...(parent.tags||[])],
    parentId, childIds: [], order: 999,
    date: new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'})
  };
  if(!parent.childIds) parent.childIds=[];
  parent.childIds.push(n.id);
  notes.push(n);
  save(); renderList(); renderChildPageBtns(parentId);
  openNote(n.id,'B');
}

function updatePaneSelects(){
  // è‡ªç”±ãƒ¢ãƒ¼ãƒ‰ã®ã¿selectæ›´æ–°
  const selA = document.getElementById('paneASelect');
  const selB = document.getElementById('paneBSelect');
  if(selA){ const c=currentNoteId.A; selA.innerHTML='<option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>'+notes.map(n=>`<option value="${n.id}" ${n.id===c?'selected':''}>${escHtml(n.title)}</option>`).join(''); }
  if(selB){ const c=currentNoteId.B; selB.innerHTML='<option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>'+notes.map(n=>`<option value="${n.id}" ${n.id===c?'selected':''}>${escHtml(n.title)}</option>`).join(''); }
}

// â”€â”€â”€ ãƒ‰ãƒ©ãƒƒã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e,id){dragId=id;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move';}

function _isChildZone(e){
  // ã‚¢ã‚¤ãƒ†ãƒ å³ç«¯1/3ã‚’ãƒ›ãƒãƒ¼ã—ãŸã‚‰ã€Œå­ã«ã™ã‚‹ã€ã‚¾ãƒ¼ãƒ³
  const r=e.currentTarget.getBoundingClientRect();
  return e.clientX > r.left + r.width*0.6;
}

function onDragOver(e){
  e.preventDefault();
  const el=e.currentTarget;
  if(_isChildZone(e)){
    el.classList.remove('drag-over');
    el.classList.add('drag-over-child');
  } else {
    el.classList.remove('drag-over-child');
    el.classList.add('drag-over');
  }
}

function onDragLeave(e){
  e.currentTarget.classList.remove('drag-over','drag-over-child');
}

function onDragEnd(e){
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over,.drag-over-child,.drag-over-pane').forEach(el=>el.classList.remove('drag-over','drag-over-child','drag-over-pane'));
}

function onDrop(e,tid){
  e.preventDefault();
  e.stopPropagation(); // ãƒšã‚¤ãƒ³ã®dropã«ä¼æ’­ã•ã›ãªã„
  const el=e.currentTarget;
  el.classList.remove('drag-over','drag-over-child');
  if(dragId===tid){dragId=null;return;}

  const src=notes.find(n=>n.id===dragId);
  const tgt=notes.find(n=>n.id===tid);
  if(!src||!tgt){dragId=null;return;}

  if(_isChildZone(e)){
    // â”€â”€ å­ã«ã™ã‚‹ â”€â”€
    // å¾ªç’°ãƒã‚§ãƒƒã‚¯ï¼ˆå­ã®å­ã‚’ãã®è¦ªã®è¦ªã«ã¯ã§ããªã„ï¼‰
    if(_isDescendant(tid, dragId)){dragId=null;return;}
    // æ—§è¦ªã‹ã‚‰å¤–ã™
    if(src.parentId){
      const oldP=notes.find(n=>n.id===src.parentId);
      if(oldP) oldP.childIds=(oldP.childIds||[]).filter(x=>x!==dragId);
    }
    src.parentId=tid;
    if(!tgt.childIds)tgt.childIds=[];
    if(!tgt.childIds.includes(dragId)) tgt.childIds.push(dragId);
    // ãƒ„ãƒªãƒ¼ã‚’å±•é–‹
    setTimeout(()=>{
      const ch=document.getElementById('ch-'+tid);
      const ex=document.querySelector(`[data-id="${tid}"] .note-item-expand`);
      if(ch&&ch.style.display==='none'){ch.style.display='block';if(ex)ex.textContent='â–¼';}
    },50);
  } else {
    // â”€â”€ ä¸¦ã³æ›¿ãˆï¼ˆãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®ã¿ã€ã¾ãŸã¯åŒã˜è¦ªåŒå£«ï¼‰â”€â”€
    // ãƒ«ãƒ¼ãƒˆã¸æ˜‡æ ¼ã™ã‚‹å ´åˆã¯ parentId ã‚’å¤–ã™
    if(src.parentId && !tgt.parentId){
      const oldP=notes.find(n=>n.id===src.parentId);
      if(oldP) oldP.childIds=(oldP.childIds||[]).filter(x=>x!==dragId);
      src.parentId=null;
    }
    const si=notes.findIndex(n=>n.id===dragId);
    const ti=notes.findIndex(n=>n.id===tid);
    if(si>=0&&ti>=0){const[m]=notes.splice(si,1);notes.splice(ti,0,m);}
    notes.forEach((n,i)=>n.order=i);
  }
  dragId=null;save();renderList();
}

function _isDescendant(potentialAncestor, nodeId){
  // nodeId ãŒ potentialAncestor ã®ç¥–å…ˆã‹ã©ã†ã‹
  let cur=notes.find(n=>n.id===potentialAncestor);
  while(cur&&cur.parentId){
    if(cur.parentId===nodeId) return true;
    cur=notes.find(n=>n.id===cur.parentId);
  }
  return false;
}

// ãƒšã‚¤ãƒ³ã¸ã®D&Dï¼ˆãƒãƒ¼ãƒˆã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ãï¼‰
function onDragOverPane(e,pane){
  // note-itemä¸Šã§ã¯ãªããƒšã‚¤ãƒ³èƒŒæ™¯ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸå ´åˆã®ã¿åå¿œ
  if(e.target.closest('.note-item')) return;
  e.preventDefault();
  document.getElementById('pane'+pane).classList.add('drag-over-pane');
}
function onDragLeavePane(e,pane){
  if(!e.currentTarget.contains(e.relatedTarget)){
    document.getElementById('pane'+pane).classList.remove('drag-over-pane');
  }
}
function onDropPane(e,pane){
  document.getElementById('pane'+pane).classList.remove('drag-over-pane');
  if(e.target.closest('.note-item')) return; // note-itemä¸Šã¯onDropã«ä»»ã›ã‚‹
  e.preventDefault();
  if(dragId==null) return;
  openNote(dragId,pane);
  dragId=null;
}
// â”€â”€â”€ ã‚¿ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTag(t){activeTagFilter=activeTagFilter===t?'':t;renderList();}

// â”€â”€â”€ AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let aiOpen=false;
function toggleAi(){aiOpen=!aiOpen;document.getElementById('aiPane').classList.toggle('open',aiOpen);}
function setAiProv(p){aiProvider=p;document.getElementById('provGemini').classList.toggle('active',p==='gemini');document.getElementById('provClaude').classList.toggle('active',p==='claude');document.getElementById('aiProvLabel').textContent=p==='gemini'?'Gemini Flash':'Claude Haiku';}
async function askAI(){
  const q=document.getElementById('aiQuestion').value.trim();if(!q)return;
  const key=aiProvider==='gemini'?geminiKey:claudeKey;if(!key){showModal('apiModal');return;}
  const btn=document.getElementById('askBtn');const el=document.getElementById('aiAnswer');
  btn.disabled=true;el.innerHTML='<span class="ai-spinner"></span> ç”Ÿæˆä¸­â€¦';document.getElementById('aiAnswerBtns').style.display='none';
  const n=currentNoteId.A?notes.find(x=>x.id===currentNoteId.A):null;
  const sys='å‰µä½œã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€‚æ—¥æœ¬èª200å­—ä»¥å†…ã§å®Ÿè·µçš„ã«ç­”ãˆã‚‹ã€‚'+(n?`\nå‚è€ƒ:ã€Œ${n.title}ã€${(n.body||'').slice(0,150)}`:'');
  try{
    let ans='';
    if(aiProvider==='gemini'){
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:sys+'\nè³ªå•ï¼š'+q}]}],generationConfig:{maxOutputTokens:512,temperature:0.7}})});
      const d=await r.json();if(!r.ok)throw new Error(d.error?.message||'Geminiã‚¨ãƒ©ãƒ¼');ans=d.candidates?.[0]?.content?.parts?.[0]?.text||'';
    }else{
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:512,system:sys,messages:[{role:'user',content:q}]})});
      const d=await r.json();if(!r.ok)throw new Error(d.error?.message||'Claudeã‚¨ãƒ©ãƒ¼');ans=d.content?.[0]?.text||'';
    }
    el.textContent=ans;document.getElementById('aiAnswerBtns').style.display='flex';
  }catch(e){el.innerHTML=`<span style="color:var(--accent)">ã‚¨ãƒ©ãƒ¼: ${e.message}</span>`;}
  finally{btn.disabled=false;}
}
function copyAiAnswer(){navigator.clipboard?.writeText(document.getElementById('aiAnswer').textContent);}
function saveAiAsNote(){
  const q=document.getElementById('aiQuestion').value.trim();const a=document.getElementById('aiAnswer').textContent;
  document.getElementById('addTitle').value=q.slice(0,30)||'AIè³ªå•ãƒ¡ãƒ¢';
  document.getElementById('addBody').value=`â–  è³ªå•\n${q}\n\nâ–  AIå›ç­”\n${a}`;
  document.getElementById('addTags').value='AIå›ç­”';
  document.querySelectorAll('#addTypeTrack .add-type-btn').forEach(b=>b.classList.toggle('active',b.dataset.type==='æ¦‚å¿µãƒ¡ãƒ¢'));
  currentAddType='æ¦‚å¿µãƒ¡ãƒ¢';addParentId=null;showModal('addModal');
}

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveApiKeys(){const gk=document.getElementById('geminiKeyInput').value.trim();const ck=document.getElementById('claudeKeyInput').value.trim();if(gk)geminiKey=gk;if(ck)claudeKey=ck;updateApiBadge();save();closeModal('apiModal');}
function updateApiBadge(){const b=document.getElementById('apiBadge');const ok=geminiKey||claudeKey;b.textContent=ok?'APIè¨­å®šæ¸ˆã¿':'APIæœªè¨­å®š';b.style.color=ok?'rgba(180,255,180,0.8)':'rgba(255,180,180,0.7)';}

// â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showToast(){const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);}
function scrollToTop(){document.getElementById('bodyA').scrollTo({top:0,behavior:'smooth'});}
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('show');}));
document.getElementById('bodyA').addEventListener('scroll',()=>{document.getElementById('scrollTopBtn').classList.toggle('visible',document.getElementById('bodyA').scrollTop>200);});
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();if(currentNoteId.A)savePane('A');if(dualMode&&currentNoteId.B)savePane('B');}});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ãƒ¡ãƒ¢ ã‚¿ãƒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let memos = [];
let memoActiveTag = '';
let memoEditId = null;
let memoSelColor = '#f5e6d0';
let memoSelEmoji = '';
let memoDragId = null;

// â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMainTab(tab) {
  ['note','memo'].forEach(t => {
    document.getElementById('mtb'+(t==='note'?'Note':'Memo')).classList.toggle('active', t===tab);
    document.getElementById('mtp'+(t==='note'?'Note':'Memo')).classList.toggle('active', t===tab);
  });
  const fab = document.getElementById('memoFab');
  const dtb = document.getElementById('dualToggle');
  const stb = document.getElementById('scrollTopBtn');
  const mtb = document.getElementById('memoScrollTopBtn');
  if (fab) fab.classList.toggle('show', tab==='memo');
  if (dtb) dtb.style.display = tab==='note' ? '' : 'none';
  if (stb) stb.style.display = tab==='note' ? '' : 'none';
  if (mtb) mtb.style.display = tab==='memo' ? '' : 'none';
  if (tab==='memo') {
    renderMemoBoard();
    // memoBoard scroll â†’ topBtnè¡¨ç¤º
    const board = document.getElementById('memoBoard');
    if (board && !board._scrollBound) {
      board._scrollBound = true;
      board.addEventListener('scroll', () => {
        const btn = document.getElementById('memoScrollTopBtn');
        if (btn) btn.classList.toggle('visible', board.scrollTop > 150);
      });
    }
  }
}
function memoScrollTop() {
  const board = document.getElementById('memoBoard');
  if (board) board.scrollTo({top:0, behavior:'smooth'});
}

// â”€â”€ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±åˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveMemos() {
  try {
    const raw = localStorage.getItem('craft_v2');
    const d = raw ? JSON.parse(raw) : {};
    d.memos = memos;
    localStorage.setItem('craft_v2', JSON.stringify(d));
  } catch(e) {}
}
function loadMemos() {
  try {
    const d = JSON.parse(localStorage.getItem('craft_v2') || '{}');
    memos = Array.isArray(d.memos) ? d.memos : [];
  } catch(e) { memos = []; }
}

// â”€â”€ ã‚«ãƒ©ãƒ¼ãƒ»çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickColor(el) {
  memoSelColor = el.dataset.color;
  document.querySelectorAll('#memoColorRow .color-dot').forEach(d => d.classList.remove('sel'));
  el.classList.add('sel');
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸¸ã‚‚æ›´æ–°
  const prev = document.getElementById('memoColorPreview');
  if (prev) prev.style.background = memoSelColor;
  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
  document.getElementById('colorPop').classList.remove('show');
}

function toggleMemoPopup(popId, anchor) {
  const pop = document.getElementById(popId);
  if (!pop) return;
  const isOpen = pop.classList.contains('show');
  // å…¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
  document.querySelectorAll('.memo-popup').forEach(p => p.classList.remove('show'));
  if (isOpen) return;
  pop.classList.add('show');
  // anchorä½ç½®ã«åˆã‚ã›ã¦é…ç½®
  const r = anchor.getBoundingClientRect();
  const pw = 260, ph = pop.scrollHeight || 160;
  let left = r.left, top = r.bottom + 4;
  if (left + pw > window.innerWidth - 8) left = window.innerWidth - pw - 8;
  if (top + ph > window.innerHeight - 8) top = r.top - ph - 4;
  pop.style.left = left + 'px';
  pop.style.top  = top  + 'px';
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
document.addEventListener('click', e => {
  if (!e.target.closest('.memo-popup') && !e.target.closest('[onclick*="toggleMemoPopup"]') &&
      !e.target.closest('#memoColorPreview') && !e.target.closest('#memoSelEmoji')) {
    document.querySelectorAll('.memo-popup').forEach(p => p.classList.remove('show'));
  }
});

// â”€â”€ çµµæ–‡å­—æŒ¿å…¥å…ˆç®¡ç† â”€â”€
// mousedownæ™‚ç‚¹ã§ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è¨˜æ†¶ï¼ˆblurã‚ˆã‚Šå…ˆã«å–å¾—ã§ãã‚‹ï¼‰
let memoFocusEl  = null;
let memoFocusSel = null;

function _bindEmojiTarget(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('mousedown', () => { memoFocusEl = el; });
  el.addEventListener('keyup',    () => {
    memoFocusEl  = el;
    memoFocusSel = { start: el.selectionStart, end: el.selectionEnd };
  });
  el.addEventListener('click',    () => {
    memoFocusEl  = el;
    memoFocusSel = { start: el.selectionStart, end: el.selectionEnd };
  });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã‹ã‚‰ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ï¼ˆDOMãŒå­˜åœ¨ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
function bindEmojiTargets() {
  ['memoTitle','memoFront','memoBack'].forEach(id => _bindEmojiTarget(id));
}

// çµµæ–‡å­—ãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼ˆmousedownã§å‘¼ã¶ â†’ blurã‚ˆã‚Šå…ˆï¼‰
function pickEmojiDown(btn, em) {
  // ã“ã®æ™‚ç‚¹ã§ã¾ã focusã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚ã‚‹ â†’ ä½ç½®ã‚’ç¢ºå®š
  const t = memoFocusEl;
  if (t && document.activeElement === t) {
    memoFocusSel = { start: t.selectionStart, end: t.selectionEnd };
  }
}

function pickEmoji(btn) {
  const em = btn.dataset.em;
  document.querySelectorAll('#memoEmojiRow .em-btn').forEach(b => b.classList.remove('sel'));
  btn.classList.add('sel');
  // ãƒãƒ¼ã‚¯æ¬„ã®ã¿æ›´æ–°ï¼ˆãƒ†ã‚­ã‚¹ãƒˆæ¬„ã¸ã®æŒ¿å…¥ã¯è¡Œã‚ãªã„ï¼‰
  memoSelEmoji = em;
  document.getElementById('memoSelEmoji').textContent = em;
}

// â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMemoModal(id) {
  memoEditId = id || null;
  const m = id ? memos.find(x => x.id === id) : null;
  document.getElementById('memoModalTitle').textContent = m ? 'âœï¸ ãƒ¡ãƒ¢ã‚’ç·¨é›†' : 'ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ãƒ¡ãƒ¢ã‚’è¿½åŠ ';
  document.getElementById('memoTitle').value   = m ? (m.title||'') : '';
  document.getElementById('memoFront').value   = m ? (m.front||'') : '';
  document.getElementById('memoBack').value    = m ? (m.back||'') : '';
  document.getElementById('memoTags').value    = m ? (m.tags||[]).join(' ') : '';

  memoSelColor = m ? (m.color||'#f5e6d0') : '#f5e6d0';
  memoSelEmoji = m ? (m.emoji||'') : '';
  document.getElementById('memoSelEmoji').textContent = memoSelEmoji || 'ã€€';
  const prev = document.getElementById('memoColorPreview');
  if (prev) prev.style.background = memoSelColor;

  document.querySelectorAll('#memoColorRow .color-dot').forEach(d =>
    d.classList.toggle('sel', d.dataset.color === memoSelColor));
  document.querySelectorAll('#memoEmojiRow .em-btn').forEach(b =>
    b.classList.toggle('sel', b.dataset.em === memoSelEmoji));

  memoFocusEl = null; memoFocusSel = null;
  showModal('memoModal');
  setTimeout(() => {
    bindEmojiTargets();
    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ§‹ç¯‰
    buildMemoToolbar('memoTbFront', 'memoFront');
    buildMemoToolbar('memoTbBack',  'memoBack');
    const el = document.getElementById('memoTitle');
    if (el) { el.focus(); }
  }, 60);
}

// â”€â”€ ä¿å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chekiScrollTop(elId) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.scrollTop = 0;
  // å¿µã®ãŸã‚å­è¦ç´ ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚ãƒªã‚»ãƒƒãƒˆ
  el.querySelectorAll('*').forEach(c => { if (c.scrollTop > 0) c.scrollTop = 0; });
}

function clearMemoModal() {
  // ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã®ã¿ã‚¯ãƒªã‚¢ï¼ˆã‚«ãƒ©ãƒ¼ãƒ»çµµæ–‡å­—ãƒ»ã‚¿ã‚°ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ã—ã¦ä¿æŒï¼‰
  document.getElementById('memoTitle').value = '';
  document.getElementById('memoFront').value = '';
  document.getElementById('memoBack').value  = '';
  document.getElementById('memoTitle').focus();
}

// è¡¨é¢æœ¬æ–‡ã®ã¿ã‚¯ãƒªã‚¢
function clearMemoFront() {
  document.getElementById('memoFront').value = '';
  document.getElementById('memoFront').focus();
}

// è£é¢æœ¬æ–‡ã®ã¿ã‚¯ãƒªã‚¢
function clearMemoBack() {
  document.getElementById('memoBack').value = '';
  document.getElementById('memoBack').focus();
}

// â”€â”€ ã‚°ãƒªãƒƒãƒ‰é…ç½®ï¼šå…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRID_PAD    = 20;
const GRID_CARD_W = 184;
const GRID_CARD_H = 298; // cheki-actions(22) + cheki-card(276)
const GRID_GAP    = 12;
const GRID_COLS   = 4;
const GRID_PITCH_X = GRID_CARD_W + GRID_GAP;
const GRID_PITCH_Y = GRID_CARD_H + GRID_GAP;

function nextGridPos() {
  // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ãŒå ã‚ã¦ã„ã‚‹ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã‚’åé›†
  const occupied = new Set();
  memos.forEach(m => {
    const col = Math.round((m.x - GRID_PAD) / GRID_PITCH_X);
    const row = Math.round((m.y - GRID_PAD) / GRID_PITCH_Y);
    if (col >= 0 && row >= 0) occupied.add(`${col},${row}`);
  });
  // ç©ºãã‚»ãƒ«ã‚’å…ˆé ­ã‹ã‚‰æ¢ã™
  for (let i = 0; i < 200; i++) {
    const col = i % GRID_COLS;
    const row = Math.floor(i / GRID_COLS);
    if (!occupied.has(`${col},${row}`)) {
      return { x: GRID_PAD + col * GRID_PITCH_X, y: GRID_PAD + row * GRID_PITCH_Y };
    }
  }
  return { x: GRID_PAD, y: GRID_PAD };
}

function saveMemo() {
  const title = document.getElementById('memoTitle').value.trim();
  const front = document.getElementById('memoFront').value.trim();
  const back  = document.getElementById('memoBack').value.trim();
  const tags  = document.getElementById('memoTags').value.trim().split(/\s+/).filter(Boolean);
  if (!title && !front) return;

  const now = new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'});
  if (memoEditId) {
    const m = memos.find(x => x.id === memoEditId);
    if (m) Object.assign(m, {title, front, back, tags, color:memoSelColor, emoji:memoSelEmoji, date:now});
  } else {
    const pos = nextGridPos();
    memos.push({id:Date.now(), title, front, back, tags, color:memoSelColor, emoji:memoSelEmoji, date:now, flip:false, x:pos.x, y:pos.y});
  }
  saveMemos();
  closeModal('memoModal');
  renderMemoBoard();
}

// â”€â”€ å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteMemo(id) {
  if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  memos = memos.filter(m => m.id !== id);
  saveMemos(); renderMemoBoard();
}

function copyMemo(id) {
  const src = memos.find(x => x.id === id);
  if (!src) return;
  const pos = nextGridPos();
  const copy = {
    ...src,
    id: Date.now(),
    title: src.title ? src.title + ' (ã‚³ãƒ”ãƒ¼)' : '(ã‚³ãƒ”ãƒ¼)',
    x: pos.x, y: pos.y,
    flip: false,
    date: new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit'})
  };
  memos.push(copy);
  saveMemos();
  renderMemoBoard();
}

// â”€â”€ è¡¨è£åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flipMemo(id) {
  const m = memos.find(x => x.id === id);
  if (!m) return;
  m.flip = !m.flip;
  const wrap = document.querySelector(`.cheki-wrap[data-mid="${id}"]`);
  if (!wrap) return;
  wrap.querySelector('.cheki-front').classList.toggle('show', !m.flip);
  wrap.querySelector('.cheki-back').classList.toggle('show', m.flip);
  wrap.querySelector('.cheki-flip-btn').textContent = m.flip ? 'â— è¡¨é¢' : 'è£é¢ â–·';
}

// â”€â”€ ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let memoTbTarget = 'memoFront'; // ç¾åœ¨ã®æŒ¿å…¥å¯¾è±¡('memoFront' or 'memoBack')

function buildMemoToolbar(containerId, targetId) {
  const tb = document.getElementById(containerId);
  if (!tb) return;
  const groups = [
    {label:'ç½«ç·š', btns:[{text:'â”€',idx:0},{text:'â•',idx:1},{text:'â€¦',idx:2}]},
    null,
    {label:'è¨˜å·', btns:[{text:'â– ',idx:3},{text:'â–¶',idx:4},{text:'â—†',idx:5},{text:'ã€ã€‘',idx:6},{text:'â€»',idx:7},{text:'â†’',idx:8},{text:'â‡’',idx:9}]},
    null,
    {label:'çµµæ–‡å­—', btns:[{text:'ğŸ“Œ',idx:10},{text:'ğŸ’¡',idx:11},{text:'âš ï¸',idx:12},{text:'â“',idx:13},{text:'âœ¨',idx:14},{text:'ğŸ”–',idx:15},{text:'ğŸ“',idx:16},{text:'ğŸ’¬',idx:17},{text:'ğŸ¯',idx:18},{text:'ğŸŒ¿',idx:19},{text:'ğŸŒ™',idx:20},{text:'ğŸ”¥',idx:21}]},
    null,
    {link:true, targetId}
  ];
  let h = '';
  for (const g of groups) {
    if (!g) { h += '<div class="tb-sep"></div>'; continue; }
    if (g.link) { h += `<button class="tb-btn wide" onclick="insertMemoLink('${g.targetId}')" title="URLã‚’å…¥åŠ›ã—ã¦ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥">ğŸ”— URLæŒ¿å…¥</button>`; continue; }
    h += `<span class="tb-label">${g.label}</span>`;
    for (const b of g.btns) {
      h += `<button class="tb-btn" data-target="${targetId}" data-idx="${b.idx}" onclick="memoTbClick(this)">${b.text}</button>`;
    }
  }
  tb.innerHTML = h;
}

function insertMemoLink(taId) {
  const url = prompt('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
  if (!url || url === 'https://') return;
  const ta = document.getElementById(taId);
  if (!ta) return;
  const s = ta.selectionStart, e = ta.selectionEnd;
  ta.value = ta.value.slice(0, s) + url + ta.value.slice(e);
  ta.selectionStart = ta.selectionEnd = s + url.length;
  ta.focus();
}

function memoTbClick(btn) {
  const taId = btn.dataset.target;
  const ta = document.getElementById(taId);
  if (!ta) return;
  const text = INSERTS[parseInt(btn.dataset.idx)];
  const s = ta.selectionStart, e = ta.selectionEnd;
  ta.value = ta.value.slice(0, s) + text + ta.value.slice(e);
  ta.selectionStart = ta.selectionEnd = s + text.length;
  ta.focus();
}


function toggleMemoTag(tag) {
  memoActiveTag = memoActiveTag === tag ? '' : tag;
  renderMemoBoard();
}

// â”€â”€ ãƒœãƒ¼ãƒ‰æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMemoBoard() {
  const board = document.getElementById('memoBoard');
  if (!board) return;
  const q = (document.getElementById('memoSearch')||{}).value?.toLowerCase()||'';

  let list = memos.filter(m => {
    if (memoActiveTag && !(m.tags||[]).includes(memoActiveTag)) return false;
    if (q) {
      const hay = [m.title,m.front,m.back,...(m.tags||[])].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  const cnt = document.getElementById('memoCount');
  if (cnt) cnt.textContent = list.length + ' ä»¶';

  if (list.length === 0) {
    board.innerHTML = `<div class="empty-board"><div class="eicon">ğŸ’¡</div><p>${memos.length===0?'ï¼‹ ãƒœã‚¿ãƒ³ã§ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã‚’è¿½åŠ ':'ãƒ¡ãƒ¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}</p></div>`;
  } else {
    board.innerHTML = list.map(m => cardHTML(m)).join('');
  }

  // ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰
  const allTags = [...new Set(memos.flatMap(m => m.tags||[]))].sort();
  const wrap = document.getElementById('memoTagWrap');
  if (wrap) wrap.innerHTML = allTags.map(t =>
    `<span class="memo-tag-chip ${memoActiveTag===t?'active':''}" onclick="toggleMemoTag('${escHtml(t)}')">#${escHtml(t)}</span>`
  ).join('');

  // ãƒœãƒ¼ãƒ‰ã®æœ€å°é«˜ã•ã‚’å…¨ã‚«ãƒ¼ãƒ‰ãŒåã¾ã‚‹ã‚ˆã†è¨­å®š
  setTimeout(() => {
    const b = document.getElementById('memoBoard');
    if (!b) return;
    const cards = b.querySelectorAll('.cheki-wrap');
    let maxBottom = 300;
    cards.forEach(card => {
      const bottom = parseInt(card.style.top||0) + card.offsetHeight;
      if (bottom > maxBottom) maxBottom = bottom;
    });
    b.style.minHeight = (maxBottom + 60) + 'px';
  }, 50);
}

// â”€â”€ URL ã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›ï¼ˆæœ¬æ–‡è¡¨ç¤ºç”¨ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function linkify(text) {
  if (!text) return '';
  // ã¾ãš escHtml ã—ã¦ã‹ã‚‰URLã‚’ <a> ã«å¤‰æ›
  const escaped = escHtml(text);
  return escaped.replace(
    /(https?:\/\/[^\s&lt;&gt;"'\u3000\u3001\u3002\uff01-\uffef]+)/g,
    '<a href="$1" target="_blank" rel="noopener noreferrer" class="cheki-link" onclick="event.stopPropagation()">$1</a>'
  );
}

function cardHTML(m) {
  const dark = ['#3a2010','#c4763a','#2c3e50','#4a5a3a','#6a3050','#5a4a2a','#1a3a4a','#3a1a1a'].includes(m.color);
  const tc  = dark ? '#fff'                : '#1a1208';
  const sc  = dark ? 'rgba(255,255,255,0.75)' : '#4a3a2a';
  const tgbg= dark ? 'rgba(255,255,255,0.18)' : '#f0ece4';
  const tgc = dark ? '#fff'               : '#5a4a3a';
  const tags = (m.tags||[]).map(t =>
    `<span class="cheki-tag" style="background:${tgbg};color:${tgc};">#${escHtml(t)}</span>`).join('');
  const hasBack = !!(m.back||'').trim();
  const flipLbl = m.flip ? 'â— è¡¨é¢' : 'è£é¢ â–·';

  const cx = m.x ?? 20;
  const cy = m.y ?? 20;
  return `<div class="cheki-wrap" data-mid="${m.id}"
    style="left:${cx}px;top:${cy}px;"
    onpointerdown="mPointerDown(event,${m.id})">
    <div class="cheki-card">
      <div class="cheki-actions" ondragstart="event.stopPropagation()" ondragover="event.stopPropagation()">
        <button class="cheki-act-btn" onclick="event.stopPropagation();showMemoModal(${m.id})" title="ç·¨é›†">âœ</button>
        <button class="cheki-act-btn" onclick="event.stopPropagation();copyMemo(${m.id})" title="ã‚³ãƒ”ãƒ¼">â§‰</button>
        <button class="cheki-act-btn" onclick="event.stopPropagation();deleteMemo(${m.id})" title="å‰Šé™¤" style="color:#c06060;">Ã—</button>
      </div>
      <div class="cheki-front ${m.flip?'':'show'}">
        <div class="cheki-photo" style="background:${m.color};" id="cheki-photo-${m.id}">
          ${m.emoji?`<div class="cheki-emoji">${m.emoji}</div>`:''}
          <div class="cheki-title" style="color:${tc};">${escHtml(m.title||'')}</div>
          ${m.front?`<div class="cheki-body-text" style="color:${sc};">${linkify(m.front)}</div>`:''}
        </div>
        <div class="cheki-bottom">
          ${tags?`<div class="cheki-tags">${tags}</div>`:''}
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="cheki-date">${m.date||''}</div>
            <button class="cheki-top-btn" onclick="event.stopPropagation();chekiScrollTop('cheki-photo-${m.id}')" title="å…ˆé ­ã«æˆ»ã‚‹">â†‘</button>
          </div>
        </div>
        ${hasBack?`<button class="cheki-flip-btn" onclick="event.stopPropagation();flipMemo(${m.id})">${flipLbl}</button>`:''}
      </div>
      <div class="cheki-back ${m.flip?'show':''}">
        <div class="cheki-back-inner" id="cheki-back-${m.id}">
          ${m.back
            ?`<div class="cheki-back-text">${linkify(m.back)}</div>`
            :`<div class="cheki-back-empty">ï¼ˆè£é¢ã«ãƒ¡ãƒ¢ãªã—ï¼‰</div>`}
        </div>
        <div class="cheki-back-foot" style="display:flex;justify-content:space-between;align-items:center;">
          <span>${escHtml(m.title||'')}</span>
          <button class="cheki-top-btn" onclick="event.stopPropagation();chekiScrollTop('cheki-back-${m.id}')" title="å…ˆé ­ã«æˆ»ã‚‹">â†‘</button>
        </div>
        <button class="cheki-flip-btn" onclick="event.stopPropagation();flipMemo(${m.id})">${m.flip?'â— è¡¨é¢':'è£é¢ â–·'}</button>
      </div>
    </div>
  </div>`;
}

// â”€â”€ ä»˜ç®‹ãƒœãƒ¼ãƒ‰ï¼šãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ‰ãƒ©ãƒƒã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragState = null;

function mPointerDown(e, id) {
  if (e.target.closest('.cheki-actions') || e.target.closest('.cheki-flip-btn') || e.target.closest('.cheki-top-btn')) return;
  const wrap = e.currentTarget;
  const board = document.getElementById('memoBoard');
  const boardRect = board.getBoundingClientRect();

  // ã‚«ãƒ¼ãƒ‰ã®ãƒœãƒ¼ãƒ‰å†…çµ¶å¯¾åº§æ¨™ã‚’è¨˜éŒ²
  const origX = parseInt(wrap.style.left) || 0;
  const origY = parseInt(wrap.style.top)  || 0;

  // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã®ãƒœãƒ¼ãƒ‰å†…åº§æ¨™ã‚’è¨ˆç®—ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¾¼ã¿ï¼‰
  const startBoardX = e.clientX - boardRect.left + board.scrollLeft;
  const startBoardY = e.clientY - boardRect.top  + board.scrollTop;

  _dragState = { id, wrap, board, origX, origY, startBoardX, startBoardY };
  wrap.classList.add('dragging');
  wrap.setPointerCapture(e.pointerId);
  e.preventDefault();
}

document.addEventListener('pointermove', e => {
  if (!_dragState) return;
  const { wrap, board, origX, origY, startBoardX, startBoardY } = _dragState;
  const boardRect = board.getBoundingClientRect();

  // ç¾åœ¨ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã®ãƒœãƒ¼ãƒ‰å†…åº§æ¨™
  const curBoardX = e.clientX - boardRect.left + board.scrollLeft;
  const curBoardY = e.clientY - boardRect.top  + board.scrollTop;

  const dx = curBoardX - startBoardX;
  const dy = curBoardY - startBoardY;

  const GRID = 20;
  const newX = Math.max(0, Math.round((origX + dx) / GRID) * GRID);
  const newY = Math.max(0, Math.round((origY + dy) / GRID) * GRID);
  wrap.style.left = newX + 'px';
  wrap.style.top  = newY + 'px';

  // ãƒœãƒ¼ãƒ‰ã®ä»®æƒ³é«˜ã•ã‚’æ‹¡å¼µ
  const needed = newY + wrap.offsetHeight + 60;
  if (parseInt(board.style.minHeight || 0) < needed) board.style.minHeight = needed + 'px';
});

document.addEventListener('pointerup', e => {
  if (!_dragState) return;
  const { id, wrap } = _dragState;
  const m = memos.find(x => x.id === id);
  if (m) {
    m.x = parseInt(wrap.style.left) || 0;
    m.y = parseInt(wrap.style.top)  || 0;
    saveMemos();
  }
  wrap.classList.remove('dragging');
  _dragState = null;
});

// â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();loadMemos();buildToolbar('A');buildToolbar('B');renderList();
const first=notes.filter(n=>!n.parentId).sort((a,b)=>(a.order??0)-(b.order??0))[0];
if(first)openNote(first.id,'A');
</script>

<!-- â”€â”€ ãƒ¡ãƒ¢å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ -->
<div class="modal-overlay" id="memoModal">
  <div class="memo-modal-box">
    <div class="memo-modal-hdr">
      <span class="memo-modal-hdr-title" id="memoModalTitle">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ãƒ¡ãƒ¢ã‚’è¿½åŠ </span>
      <div style="margin-left:auto;display:flex;gap:6px;">
        <button class="btn-primary" onclick="saveMemo()">ä¿å­˜ã™ã‚‹</button>
        <button class="btn-secondary" onclick="closeModal('memoModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <!-- ãƒ¡ã‚¿ãƒãƒ¼ï¼šã‚«ãƒ©ãƒ¼ãƒ»ãƒãƒ¼ã‚¯ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¿ã‚° ã‚’1è¡Œã« -->
    <div class="memo-meta-bar">
      <!-- ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ -->
      <div id="memoColorPreview" style="width:18px;height:18px;border-radius:50%;background:#f5e6d0;box-shadow:0 0 0 1px rgba(0,0,0,0.18);cursor:pointer;flex-shrink:0;" title="ã‚«ãƒ©ãƒ¼ã‚’é¸æŠ" onclick="toggleMemoPopup('colorPop',this)"></div>
      <!-- ãƒãƒ¼ã‚¯ï¼ˆçµµæ–‡å­—ï¼‰ãƒœã‚¿ãƒ³ -->
      <span class="memo-meta-emoji-preview" id="memoSelEmoji" title="ãƒãƒ¼ã‚¯ã‚’é¸æŠ" onclick="toggleMemoPopup('emojiPop',this)">ã€€</span>
      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <input class="memo-title-input" id="memoTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è¦‹å‡ºã—" />
      <!-- ã‚¿ã‚° -->
      <span style="font-size:9px;color:var(--muted);flex-shrink:0;">#ã‚¿ã‚°</span>
      <input class="memo-tag-input-sm" id="memoTags" placeholder="ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ ã‚­ãƒ£ãƒ©" />
      <!-- ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
      <button onclick="clearMemoModal()" title="å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢" style="flex-shrink:0;font-size:10px;padding:2px 8px;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;">âœ• ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="memo-popup" id="colorPop">
      <div class="memo-popup-title">ã‚«ãƒ©ãƒ¼</div>
      <div class="memo-color-row" id="memoColorRow" style="gap:6px;flex-wrap:wrap;display:flex;max-width:240px;">
        <!-- æ·¡ã„ãƒ‘ã‚¹ãƒ†ãƒ«ï¼ˆæš–è‰²ç³»ï¼‰ -->
        <div class="color-dot" style="background:#f5e6d0;" data-color="#f5e6d0" onclick="pickColor(this)" title="ã‚¯ãƒªãƒ¼ãƒ "></div>
        <div class="color-dot" style="background:#fde8e8;" data-color="#fde8e8" onclick="pickColor(this)" title="ãƒ™ãƒ“ãƒ¼ãƒ”ãƒ³ã‚¯"></div>
        <div class="color-dot" style="background:#fffde8;" data-color="#fffde8" onclick="pickColor(this)" title="ãƒ¬ãƒ¢ãƒ³"></div>
        <div class="color-dot" style="background:#fdebd0;" data-color="#fdebd0" onclick="pickColor(this)" title="ãƒ”ãƒ¼ãƒ"></div>
        <div class="color-dot" style="background:#fce4ec;" data-color="#fce4ec" onclick="pickColor(this)" title="ãƒ­ãƒ¼ã‚º"></div>
        <div class="color-dot" style="background:#fff3e0;" data-color="#fff3e0" onclick="pickColor(this)" title="ã‚ªãƒ¬ãƒ³ã‚¸ã‚¯ãƒªãƒ¼ãƒ "></div>
        <!-- æ·¡ã„ãƒ‘ã‚¹ãƒ†ãƒ«ï¼ˆå¯’è‰²ãƒ»ç·‘ç³»ï¼‰ -->
        <div class="color-dot" style="background:#e8f0e4;" data-color="#e8f0e4" onclick="pickColor(this)" title="ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³"></div>
        <div class="color-dot" style="background:#e0f4f8;" data-color="#e0f4f8" onclick="pickColor(this)" title="ã‚¹ã‚«ã‚¤"></div>
        <div class="color-dot" style="background:#e8eaf8;" data-color="#e8eaf8" onclick="pickColor(this)" title="ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼"></div>
        <div class="color-dot" style="background:#f3e8f8;" data-color="#f3e8f8" onclick="pickColor(this)" title="ãƒ©ã‚¤ãƒ©ãƒƒã‚¯"></div>
        <div class="color-dot" style="background:#e8f8f5;" data-color="#e8f8f5" onclick="pickColor(this)" title="ã‚¢ã‚¯ã‚¢"></div>
        <div class="color-dot" style="background:#eaf4fb;" data-color="#eaf4fb" onclick="pickColor(this)" title="ã‚¢ã‚¤ã‚¹ãƒ–ãƒ«ãƒ¼"></div>
        <!-- ãã™ã¿ã‚«ãƒ©ãƒ¼ï¼ˆä¸­é–“è‰²ï¼‰ -->
        <div class="color-dot" style="background:#d4b896;" data-color="#d4b896" onclick="pickColor(this)" title="ãã™ã¿ã‚µãƒ³ãƒ‰"></div>
        <div class="color-dot" style="background:#e8a598;" data-color="#e8a598" onclick="pickColor(this)" title="ãã™ã¿ã‚³ãƒ¼ãƒ©ãƒ«"></div>
        <div class="color-dot" style="background:#c5ddb0;" data-color="#c5ddb0" onclick="pickColor(this)" title="ãã™ã¿ã‚°ãƒªãƒ¼ãƒ³"></div>
        <div class="color-dot" style="background:#a8c8e8;" data-color="#a8c8e8" onclick="pickColor(this)" title="ãã™ã¿ãƒ–ãƒ«ãƒ¼"></div>
        <div class="color-dot" style="background:#c8b0d8;" data-color="#c8b0d8" onclick="pickColor(this)" title="ãã™ã¿ãƒ‘ãƒ¼ãƒ—ãƒ«"></div>
        <div class="color-dot" style="background:#e8c88a;" data-color="#e8c88a" onclick="pickColor(this)" title="ãã™ã¿ã‚¤ã‚¨ãƒ­ãƒ¼"></div>
        <div class="color-dot" style="background:#b8d4c8;" data-color="#b8d4c8" onclick="pickColor(this)" title="ãã™ã¿ã‚»ãƒ¼ã‚¸"></div>
        <div class="color-dot" style="background:#d8b0a8;" data-color="#d8b0a8" onclick="pickColor(this)" title="ãã™ã¿ãƒ†ãƒ©ã‚³ãƒƒã‚¿"></div>
        <!-- ãƒ€ãƒ¼ã‚¯ç³» -->
        <div class="color-dot" style="background:#3a2010;" data-color="#3a2010" onclick="pickColor(this)" title="ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ©ã‚¦ãƒ³"></div>
        <div class="color-dot" style="background:#c4763a;" data-color="#c4763a" onclick="pickColor(this)" title="ãƒãƒ¼ãƒ³ãƒˆã‚ªãƒ¬ãƒ³ã‚¸"></div>
        <div class="color-dot" style="background:#2c3e50;" data-color="#2c3e50" onclick="pickColor(this)" title="ãƒ€ãƒ¼ã‚¯ãƒã‚¤ãƒ“ãƒ¼"></div>
        <div class="color-dot" style="background:#4a5a3a;" data-color="#4a5a3a" onclick="pickColor(this)" title="ãƒ€ãƒ¼ã‚¯ã‚°ãƒªãƒ¼ãƒ³"></div>
        <div class="color-dot" style="background:#6a3050;" data-color="#6a3050" onclick="pickColor(this)" title="ãƒ€ãƒ¼ã‚¯ãƒ—ãƒ©ãƒ "></div>
        <div class="color-dot" style="background:#5a4a2a;" data-color="#5a4a2a" onclick="pickColor(this)" title="ãƒ€ãƒ¼ã‚¯ã‚ªãƒªãƒ¼ãƒ–"></div>
        <div class="color-dot" style="background:#1a3a4a;" data-color="#1a3a4a" onclick="pickColor(this)" title="ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ†ã‚£ãƒ¼ãƒ«"></div>
        <div class="color-dot" style="background:#3a1a1a;" data-color="#3a1a1a" onclick="pickColor(this)" title="ãƒ€ãƒ¼ã‚¯ãƒ­ãƒ¼ã‚ºã‚¦ãƒƒãƒ‰"></div>
      </div>
    </div>

    <!-- çµµæ–‡å­—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="memo-popup" id="emojiPop">
      <div class="memo-popup-title">ãƒãƒ¼ã‚¯ï¼ˆä»˜ç®‹å·¦ä¸Šã«è¡¨ç¤ºï¼‰</div>
      <div class="memo-emoji-row" id="memoEmojiRow" style="max-height:120px;overflow-y:auto;">
        <button class="em-btn" data-em="" onclick="pickEmoji(this)" title="ãªã—" style="font-size:13px;">âœ•</button><button class="em-btn" data-em="ğŸ’¡" onclick="pickEmoji(this)">ğŸ’¡</button><button class="em-btn" data-em="ğŸ“Œ" onclick="pickEmoji(this)">ğŸ“Œ</button><button class="em-btn" data-em="âœ¨" onclick="pickEmoji(this)">âœ¨</button><button class="em-btn" data-em="ğŸ”¥" onclick="pickEmoji(this)">ğŸ”¥</button><button class="em-btn" data-em="â“" onclick="pickEmoji(this)">â“</button><button class="em-btn" data-em="ğŸ’¬" onclick="pickEmoji(this)">ğŸ’¬</button><button class="em-btn" data-em="ğŸ¯" onclick="pickEmoji(this)">ğŸ¯</button><button class="em-btn" data-em="ğŸ“–" onclick="pickEmoji(this)">ğŸ“–</button><button class="em-btn" data-em="ğŸ”®" onclick="pickEmoji(this)">ğŸ”®</button><button class="em-btn" data-em="ğŸ’" onclick="pickEmoji(this)">ğŸ’</button><button class="em-btn" data-em="ğŸ—ï¸" onclick="pickEmoji(this)">ğŸ—ï¸</button><button class="em-btn" data-em="ğŸª„" onclick="pickEmoji(this)">ğŸª„</button><button class="em-btn" data-em="ğŸ’«" onclick="pickEmoji(this)">ğŸ’«</button><button class="em-btn" data-em="â­" onclick="pickEmoji(this)">â­</button><button class="em-btn" data-em="ğŸŒŸ" onclick="pickEmoji(this)">ğŸŒŸ</button><button class="em-btn" data-em="ğŸŒ¿" onclick="pickEmoji(this)">ğŸŒ¿</button><button class="em-btn" data-em="ğŸŒ™" onclick="pickEmoji(this)">ğŸŒ™</button><button class="em-btn" data-em="ğŸŒŠ" onclick="pickEmoji(this)">ğŸŒŠ</button><button class="em-btn" data-em="ğŸƒ" onclick="pickEmoji(this)">ğŸƒ</button><button class="em-btn" data-em="ğŸŒ¸" onclick="pickEmoji(this)">ğŸŒ¸</button><button class="em-btn" data-em="ğŸŒº" onclick="pickEmoji(this)">ğŸŒº</button><button class="em-btn" data-em="ğŸŒ»" onclick="pickEmoji(this)">ğŸŒ»</button><button class="em-btn" data-em="ğŸŒ¼" onclick="pickEmoji(this)">ğŸŒ¼</button><button class="em-btn" data-em="ğŸ€" onclick="pickEmoji(this)">ğŸ€</button><button class="em-btn" data-em="ğŸŒˆ" onclick="pickEmoji(this)">ğŸŒˆ</button><button class="em-btn" data-em="â„ï¸" onclick="pickEmoji(this)">â„ï¸</button><button class="em-btn" data-em="ğŸ¦‹" onclick="pickEmoji(this)">ğŸ¦‹</button><button class="em-btn" data-em="ğŸ¾" onclick="pickEmoji(this)">ğŸ¾</button><button class="em-btn" data-em="ğŸ¦Š" onclick="pickEmoji(this)">ğŸ¦Š</button><button class="em-btn" data-em="ğŸ±" onclick="pickEmoji(this)">ğŸ±</button><button class="em-btn" data-em="ğŸ°" onclick="pickEmoji(this)">ğŸ°</button><button class="em-btn" data-em="ğŸ’–" onclick="pickEmoji(this)">ğŸ’–</button><button class="em-btn" data-em="ğŸ’™" onclick="pickEmoji(this)">ğŸ’™</button><button class="em-btn" data-em="ğŸ’š" onclick="pickEmoji(this)">ğŸ’š</button><button class="em-btn" data-em="âš¡" onclick="pickEmoji(this)">âš¡</button><button class="em-btn" data-em="â˜•" onclick="pickEmoji(this)">â˜•</button><button class="em-btn" data-em="ğŸµ" onclick="pickEmoji(this)">ğŸµ</button><button class="em-btn" data-em="ğŸ¨" onclick="pickEmoji(this)">ğŸ¨</button><button class="em-btn" data-em="ğŸ­" onclick="pickEmoji(this)">ğŸ­</button><button class="em-btn" data-em="ğŸ¬" onclick="pickEmoji(this)">ğŸ¬</button><button class="em-btn" data-em="ğŸµ" onclick="pickEmoji(this)">ğŸµ</button><button class="em-btn" data-em="ğŸ®" onclick="pickEmoji(this)">ğŸ®</button><button class="em-btn" data-em="âš ï¸" onclick="pickEmoji(this)">âš ï¸</button><button class="em-btn" data-em="ğŸ”–" onclick="pickEmoji(this)">ğŸ”–</button><button class="em-btn" data-em="ğŸ“" onclick="pickEmoji(this)">ğŸ“</button>
      </div>
    </div>

    <div class="memo-modal-body">
      <!-- å·¦ï¼šè¡¨é¢ -->
      <div class="memo-side">
        <div class="memo-side-lbl" style="display:flex;align-items:center;">
          <span>ğŸ“· è¡¨é¢</span>
          <button onclick="clearMemoFront()" title="è¡¨é¢ã®æœ¬æ–‡ã‚’ã‚¯ãƒªã‚¢" style="margin-left:auto;font-size:9px;padding:1px 7px;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;border-radius:1px;">âœ• æœ¬æ–‡ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="memo-tb" id="memoTbFront"></div>
        <textarea class="memo-body-ta" id="memoFront" placeholder="è¡¨é¢ãƒ¡ãƒ¢ï¼ˆçŸ­ãã€ã²ã¨ç›®ã§ã‚ã‹ã‚‹ã‚ˆã†ã«ï¼‰&#10;&#10;ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰ç½«ç·šãƒ»è¨˜å·ãƒ»çµµæ–‡å­—ã‚’æŒ¿å…¥ã§ãã¾ã™"></textarea>
      </div>
      <!-- å³ï¼šè£é¢ -->
      <div class="memo-side">
        <div class="memo-side-lbl" style="display:flex;align-items:center;">
          <span>ğŸ“ è£é¢ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</span>
          <button onclick="clearMemoBack()" title="è£é¢ã®æœ¬æ–‡ã‚’ã‚¯ãƒªã‚¢" style="margin-left:auto;font-size:9px;padding:1px 7px;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;border-radius:1px;">âœ• æœ¬æ–‡ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="memo-tb" id="memoTbBack"></div>
        <textarea class="memo-body-ta" id="memoBack" placeholder="è©³ç´°ãƒ»å±•é–‹æ¡ˆãƒ»å‚è€ƒãƒ¡ãƒ¢ãªã©è‡ªç”±ã«â€¦&#10;&#10;ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰ç½«ç·šãƒ»è¨˜å·ãƒ»çµµæ–‡å­—ã‚’æŒ¿å…¥ã§ãã¾ã™"></textarea>
      </div>
    </div>
  </div>
</div>

<button class="memo-fab" id="memoFab" onclick="showMemoModal()" title="ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã‚’è¿½åŠ ">ï¼‹</button>

<button id="memoScrollTopBtn" onclick="memoScrollTop()" title="æœ€ä¸Šéƒ¨ã¸">â†‘</button>
</body>
</html>