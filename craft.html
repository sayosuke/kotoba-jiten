<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‰µä½œãƒãƒ¼ãƒˆ</title>
<style>
:root {
  --ink: #0f0a04; --paper: #f5f0e8; --paper2: #ede7d9; --paper3: #e5dece;
  --accent: #7a2008; --accent2: #c4763a; --muted: #5a4a3a;
  --border: #d4c9b0; --hover: #e8e2d4; --active-bg: #ddd5c0;
  --sidebar-w: 260px; --header-h: 48px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Serif JP', serif; background: var(--paper); color: var(--ink); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
.header { height: var(--header-h); background: var(--ink); color: var(--paper); display: flex; align-items: center; padding: 0 16px; gap: 12px; flex-shrink: 0; }
.header-logo { font-size: 13px; letter-spacing: 0.2em; white-space: nowrap; }
.header-search { flex: 1; max-width: 280px; display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 2px; padding: 4px 10px; }
.header-search input { background: none; border: none; outline: none; color: var(--paper); font-size: 12px; flex: 1; font-family: sans-serif; }
.header-search input::placeholder { color: rgba(255,255,255,0.35); }
.header-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; }
.api-badge { font-size: 9px; letter-spacing: 0.1em; padding: 3px 8px; border: 1px solid rgba(255,255,255,0.25); color: rgba(255,255,255,0.6); cursor: pointer; }
.api-badge:hover { background: rgba(255,255,255,0.1); }
.hdr-link { color: rgba(255,255,255,0.5); font-size: 10px; text-decoration: none; letter-spacing: 0.1em; }
.hdr-link:hover { color: rgba(255,255,255,0.8); }
.dual-toggle { font-size: 10px; padding: 3px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); cursor: pointer; }
.dual-toggle.on { background: var(--accent2); border-color: var(--accent2); color: #fff; }
.save-all-btn { font-size: 10px; padding: 3px 10px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.85); cursor: pointer; transition: all 0.15s; }
.save-all-btn:hover { background: rgba(255,255,255,0.22); color: #fff; }
.save-all-btn.done { background: #3a6a2a; border-color: #4a8a3a; color: #fff; }
.app-body { flex: 1; display: flex; overflow: hidden; min-height: 0; }
.sidebar { width: var(--sidebar-w); background: var(--paper2); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; min-height: 0; }
.sidebar-toolbar { padding: 0 10px; border-bottom: 1px solid var(--border); display: flex; gap: 6px; align-items: center; flex-shrink: 0; height: 42px; }
.cat-filter { flex: 1; font-size: 11px; padding: 4px 6px; border: 1px solid var(--border); background: var(--paper); color: var(--ink); }
.sidebar-add-btn { background: var(--accent); color: #fff; border: none; width: 26px; height: 26px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.sidebar-add-btn:hover { background: var(--accent2); }
.tag-bar { padding: 4px 10px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: nowrap; gap: 3px; height: 28px; flex-shrink: 0; overflow-x: auto; overflow-y: hidden; align-items: center; }
.tag-bar::-webkit-scrollbar { height: 0; }
.tag-chip { font-size: 9px; padding: 1px 6px; border-radius: 10px; background: var(--paper); border: 1px solid var(--border); cursor: pointer; color: var(--muted); }
.tag-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.note-list { flex: 1; overflow-y: auto; }
.note-item { padding: 8px 10px 8px 6px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: flex-start; gap: 4px; transition: background 0.1s; }
.note-item:hover { background: var(--hover); }
.note-item.active { background: var(--active-bg); border-left: 3px solid var(--accent); padding-left: 3px; }
.note-item-drag { color: var(--border); font-size: 11px; padding-top: 2px; cursor: grab; flex-shrink: 0; }
.note-item-body { flex: 1; min-width: 0; }
.note-item-title { font-size: 12px; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px; }
.note-item-expand { font-size: 9px; color: var(--muted); cursor: pointer; width: 12px; text-align: center; flex-shrink: 0; }
.note-item-meta { font-size: 9px; color: var(--muted); margin-top: 2px; display: flex; gap: 4px; flex-wrap: wrap; }
.note-item-type { font-size: 8px; padding: 1px 4px; }
.note-item-del { opacity: 0; font-size: 10px; color: var(--muted); cursor: pointer; padding: 2px; flex-shrink: 0; align-self: center; }
.note-item:hover .note-item-del { opacity: 0.5; }
.note-item.drag-over { border-top: 2px solid var(--accent2); }
.children-list { background: rgba(0,0,0,0.02); }
.main-pane { flex: 1; display: flex; overflow: hidden; min-width: 0; min-height: 0; align-items: stretch; }
.editor-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid var(--border); min-width: 0; min-height: 0; }
.editor-pane:last-child { border-right: none; }
.editor-pane-header { padding: 0 10px; background: var(--paper2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-shrink: 0; height: 42px; }
.editor-pane-label { font-size: 10px; color: var(--muted); letter-spacing: 0.1em; flex-shrink: 0; }
.pane-note-select { flex: 1; font-size: 11px; padding: 3px 6px; border: 1px solid var(--border); background: var(--paper); color: var(--ink); min-width: 0; }
.editor-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
.editor-meta-bar { padding: 5px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-shrink: 0; background: var(--paper); }
.editor-title-input { flex: 1; background: none; border: none; outline: none; font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 600; color: var(--ink); }
.editor-title-input::placeholder { color: var(--border); }
.type-select { font-size: 10px; padding: 3px 5px; border: 1px solid var(--border); background: var(--paper2); color: var(--ink); }
.editor-tag-input { font-size: 10px; padding: 3px 8px; border: 1px solid var(--border); background: var(--paper2); color: var(--ink); font-family: sans-serif; width: 120px; }
.editor-tag-input::placeholder { color: var(--border); }
.editor-save-btn { background: var(--accent2); color: #fff; border: none; padding: 4px 10px; font-size: 10px; cursor: pointer; }
.editor-save-btn:hover { background: var(--accent); }
.editor-save-btn.saved { background: #4a7a40; }
.toolbar { display: flex; align-items: center; gap: 2px; padding: 3px 8px; border-bottom: 1px solid var(--border); background: var(--paper2); flex-wrap: wrap; flex-shrink: 0; }
.tb-sep { width: 1px; background: var(--border); height: 16px; margin: 0 3px; flex-shrink: 0; }
.tb-label { font-size: 9px; color: var(--muted); letter-spacing: 0.05em; margin-right: 1px; }
.tb-btn { background: none; border: 1px solid transparent; border-radius: 2px; padding: 2px 5px; font-size: 12px; cursor: pointer; color: var(--ink); line-height: 1.2; white-space: nowrap; transition: all 0.1s; font-family: serif; }
.tb-btn:hover { background: var(--hover); border-color: var(--border); }
.tb-btn.wide { font-size: 10px; padding: 2px 7px; letter-spacing: 0.03em; }
.snippet-panel { display: none; position: fixed; background: var(--paper); border: 1px solid var(--border); border-radius: 2px; padding: 10px 12px 8px; z-index: 500; box-shadow: 0 4px 16px rgba(0,0,0,0.12); min-width: 260px; max-width: 340px; max-height: 70vh; overflow: hidden; flex-direction: column; }
.snippet-panel.show { display: flex; }
.snippet-panel h4 { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px; flex-shrink: 0; }
.snippet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; overflow-y: auto; flex: 1; min-height: 0; }
.snippet-item { font-size: 11px; padding: 4px 8px; background: var(--paper2); border: 1px solid var(--border); cursor: pointer; text-align: left; font-family: serif; color: var(--ink); line-height: 1.4; display: flex; justify-content: space-between; align-items: flex-start; }
.snippet-item:hover { background: var(--hover); }
.snippet-del { font-size: 9px; color: var(--muted); cursor: pointer; flex-shrink: 0; margin-left: 4px; }
.snippet-del:hover { color: var(--accent); }
.snippet-add { margin-top: 6px; border-top: 1px solid var(--border); padding-top: 7px; display: flex; gap: 4px; flex-shrink: 0; }
.snippet-add input { flex: 1; font-size: 11px; padding: 4px 6px; border: 1px solid var(--border); background: var(--paper); font-family: serif; }
.snippet-add-btn { font-size: 11px; padding: 4px 10px; background: var(--accent); color: #fff; border: none; cursor: pointer; }
.editor-body { flex: 1; padding: 20px 24px; resize: none; border: none; outline: none; font-family: 'Noto Serif JP', serif; font-size: 13px; line-height: 2.1; color: var(--ink); background: var(--paper); overflow-y: auto; min-height: 0; }
.editor-body::placeholder { color: #c8bfb0; }
.child-notes-section { border-top: 2px dashed var(--border); padding: 8px 20px 8px; background: var(--paper2); flex-shrink: 0; max-height: 120px; overflow-y: auto; min-height: 44px; }
.child-notes-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.child-notes-title { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); }
.child-add-btn { font-size: 9px; padding: 2px 7px; background: none; border: 1px solid var(--border); color: var(--muted); cursor: pointer; }
.child-add-btn:hover { border-color: var(--accent2); color: var(--accent2); }
.child-list { display: flex; flex-wrap: wrap; gap: 4px; }
.child-chip { font-size: 11px; padding: 3px 8px; background: var(--paper); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--ink); }
.child-chip:hover { background: var(--hover); border-color: var(--accent2); }
.child-chip-del { font-size: 9px; color: var(--muted); cursor: pointer; }
.child-chip-del:hover { color: var(--accent); }
.empty-pane { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); gap: 10px; }
.empty-pane .icon { font-size: 34px; opacity: 0.3; }
.empty-pane p { font-size: 12px; text-align: center; opacity: 0.5; line-height: 1.8; }
.ai-pane { border-top: 1px solid var(--border); background: var(--paper2); flex-shrink: 0; }
.ai-toggle { padding: 6px 16px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 11px; color: var(--muted); letter-spacing: 0.1em; user-select: none; }
.ai-toggle:hover { background: var(--hover); }
.ai-arrow { font-size: 8px; transition: transform 0.2s; }
.ai-pane.open .ai-arrow { transform: rotate(180deg); }
.ai-body { display: none; height: 165px; }
.ai-pane.open .ai-body { display: flex; }
.ai-input-wrap { flex: 1; display: flex; flex-direction: column; padding: 7px 12px; gap: 5px; }
.ai-question { flex: 1; resize: none; border: 1px solid var(--border); background: var(--paper); padding: 6px 10px; font-family: serif; font-size: 12px; line-height: 1.8; color: var(--ink); outline: none; }
.ai-question::placeholder { color: #c8bfb0; }
.ai-actions-row { display: flex; gap: 6px; align-items: center; }
.ai-prov-btn { font-size: 10px; padding: 3px 8px; border: 1px solid var(--border); background: var(--paper); cursor: pointer; color: var(--muted); }
.ai-prov-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.ai-ask-btn { background: var(--accent2); color: #fff; border: none; padding: 4px 12px; font-size: 11px; cursor: pointer; margin-left: auto; }
.ai-ask-btn:hover { background: var(--accent); }
.ai-ask-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.ai-answer-wrap { width: 43%; border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.ai-answer { flex: 1; padding: 7px 12px; font-size: 11px; line-height: 1.9; color: var(--ink); overflow-y: auto; white-space: pre-wrap; font-family: sans-serif; }
.ai-answer-btns { padding: 4px 8px; border-top: 1px solid var(--border); display: flex; gap: 5px; justify-content: flex-end; }
.ai-ans-btn { font-size: 10px; padding: 2px 8px; cursor: pointer; }
.ai-ans-btn.primary { background: var(--accent); color: #fff; border: none; }
.ai-ans-btn.secondary { background: none; color: var(--muted); border: 1px solid var(--border); }
.ai-spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid var(--border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 900; align-items: center; justify-content: center; }
.modal-overlay.show { display: flex; }
.modal { background: var(--paper); border: 1px solid var(--border); padding: 24px 28px; width: 500px; max-width: 96vw; max-height: 90vh; overflow-y: auto; }
.modal h2 { font-size: 13px; letter-spacing: 0.15em; margin-bottom: 16px; }
.modal-field { margin-bottom: 12px; }
.modal-field label { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); display: block; margin-bottom: 4px; }
.modal-field input, .modal-field textarea { width: 100%; padding: 6px 10px; border: 1px solid var(--border); background: var(--paper2); font-family: serif; font-size: 12px; color: var(--ink); }
.modal-field textarea { resize: vertical; min-height: 120px; line-height: 1.9; }
.modal-actions { display: flex; gap: 8px; margin-top: 16px; }
.btn-primary { background: var(--accent); color: #fff; border: none; padding: 7px 20px; cursor: pointer; font-family: serif; font-size: 12px; }
.btn-primary:hover { background: var(--accent2); }
.btn-secondary { background: none; color: var(--muted); border: 1px solid var(--border); padding: 7px 14px; cursor: pointer; font-size: 12px; }
.add-type-track { display: flex; border: 1px solid var(--border); overflow: hidden; margin-bottom: 12px; }
.add-type-btn { flex: 1; padding: 6px 2px; font-size: 11px; background: var(--paper); border: none; border-right: 1px solid var(--border); cursor: pointer; font-family: serif; color: var(--muted); }
.add-type-btn:last-child { border-right: none; }
.add-type-btn.active { background: var(--accent); color: #fff; }
#scrollTopBtn { position: fixed; bottom: 24px; right: 24px; z-index: 800; background: var(--paper2); color: var(--muted); border: 1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center; }
#scrollTopBtn.visible { display: flex; }
.type-rule { background: #e8f0e4; color: #2a4a1a; }
.type-concept { background: #e8eaf8; color: #1a2a5a; }
.type-quote { background: #f5ede0; color: #5a3010; }
.type-drill { background: #f8eae8; color: #5a1a1a; }
.type-other { background: #ede7d9; color: #5a4a3a; }
.toast { position: fixed; bottom: 66px; right: 24px; background: #1a2a1a; color: #e0f0d8; padding: 6px 14px; font-size: 11px; z-index: 900; display: none; }
.toast.show { display: block; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border); }
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">ğŸ““ å‰µä½œãƒãƒ¼ãƒˆ</div>
  <div class="header-search">
    <span style="opacity:0.4;font-size:11px;">ğŸ”</span>
    <input type="text" id="searchInput" placeholder="æ¤œç´¢â€¦" oninput="renderList()" />
  </div>
  <div class="header-actions">
    <button class="dual-toggle" id="dualToggle" onclick="toggleDual()">è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰</button>
    <button class="save-all-btn" id="saveAllBtn" onclick="saveAll()" title="å‰µä½œãƒãƒ¼ãƒˆã¨ã“ã¨ã°è¾å…¸ã‚’ä¸¡æ–¹ä¿å­˜">ğŸ’¾ ä¸€æ‹¬ä¿å­˜</button>
    <span class="api-badge" onclick="showModal('apiModal')" id="apiBadge">APIæœªè¨­å®š</span>
    <a href="index.html" class="hdr-link">â† ã“ã¨ã°è¾å…¸</a>
  </div>
</div>

<div class="app-body">
  <div class="sidebar">
    <div class="sidebar-toolbar">
      <select class="cat-filter" id="catFilter" onchange="renderList()">
        <option value="">ã™ã¹ã¦</option>
        <option value="ãƒ«ãƒ¼ãƒ«">ãƒ«ãƒ¼ãƒ«</option>
        <option value="æ¦‚å¿µãƒ¡ãƒ¢">æ¦‚å¿µãƒ¡ãƒ¢</option>
        <option value="ã‚­ãƒ£ãƒ©èªéŒ²">ã‚­ãƒ£ãƒ©èªéŒ²</option>
        <option value="ç·´ç¿’èª²é¡Œ">ç·´ç¿’èª²é¡Œ</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <button class="sidebar-add-btn" onclick="showAddModal(null)">ï¼‹</button>
    </div>
    <div class="tag-bar" id="tagBar"></div>
    <div class="note-list" id="noteList"></div>
  </div>

  <div class="main-pane" id="mainPane">
    <div class="editor-pane" id="paneA">
      <div class="editor-pane-header" id="paneAHeader" style="display:none;">
        <span class="editor-pane-label" style="color:var(--accent2);">å·¦ / è¦ª</span>
        <select class="pane-note-select" id="paneASelect" onchange="loadNoteToPane('A',this.value)">
          <option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>
        </select>
        <button class="tb-btn wide" onclick="createChildFromParent()" id="addChildBtn" title="ã“ã®ãƒšãƒ¼ã‚¸ã®å­ãƒãƒ¼ãƒˆã‚’ä½œã‚‹" style="display:none;white-space:nowrap;font-size:10px;padding:3px 8px;background:var(--accent);color:#fff;border-color:var(--accent);">ï¼‹ å­ãƒšãƒ¼ã‚¸</button>
      </div>
      <div class="editor-wrap" id="editorWrapA" style="display:none;">
        <div class="editor-meta-bar">
          <input class="editor-title-input" id="titleA" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" oninput="markDirty('A')" />
          <select class="type-select" id="typeA" onchange="markDirty('A')">
            <option>ãƒ«ãƒ¼ãƒ«</option><option>æ¦‚å¿µãƒ¡ãƒ¢</option><option>ã‚­ãƒ£ãƒ©èªéŒ²</option><option>ç·´ç¿’èª²é¡Œ</option><option>ãã®ä»–</option>
          </select>
          <input class="editor-tag-input" id="tagsA" placeholder="ã‚¿ã‚°" oninput="markDirty('A')" />
          <button class="editor-save-btn" id="saveBtnA" onclick="savePane('A')">ä¿å­˜</button>
        </div>
        <div class="toolbar" id="toolbarA"></div>
        <textarea class="editor-body" id="bodyA" placeholder="ã“ã“ã«æ›¸ãâ€¦&#10;&#10;ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰ç½«ç·šãƒ»çµµæ–‡å­—ãƒ»å®šå‹æ–‡ã‚’æŒ¿å…¥ã§ãã¾ã™" oninput="markDirty('A');autoSave('A')"></textarea>
        <div class="child-notes-section" id="childSectionA"></div>
      </div>
      <div class="empty-pane" id="emptyA">
        <div class="icon">ğŸ“„</div>
        <p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ¼ãƒˆã‚’é¸ã¶<br>ã¾ãŸã¯ ï¼‹ ã§è¿½åŠ </p>
      </div>
    </div>
    <div class="editor-pane" id="paneB" style="display:none;">
      <div class="editor-pane-header" id="paneBHeader">
        <span class="editor-pane-label" id="paneBLabel">å³</span>
        <div id="paneBPageBtns" style="display:flex;gap:3px;flex-wrap:wrap;flex:1;overflow-x:auto;"></div>
        <select class="pane-note-select" id="paneBSelect" onchange="loadNoteToPane('B',this.value)" style="display:none;">
          <option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>
        </select>
      </div>
      <div class="editor-wrap" id="editorWrapB" style="display:none;">
        <div class="editor-meta-bar">
          <input class="editor-title-input" id="titleB" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" oninput="markDirty('B')" />
          <select class="type-select" id="typeB" onchange="markDirty('B')">
            <option>ãƒ«ãƒ¼ãƒ«</option><option>æ¦‚å¿µãƒ¡ãƒ¢</option><option>ã‚­ãƒ£ãƒ©èªéŒ²</option><option>ç·´ç¿’èª²é¡Œ</option><option>ãã®ä»–</option>
          </select>
          <input class="editor-tag-input" id="tagsB" placeholder="ã‚¿ã‚°" oninput="markDirty('B')" />
          <button class="editor-save-btn" id="saveBtnB" onclick="savePane('B')">ä¿å­˜</button>
        </div>
        <div class="toolbar" id="toolbarB"></div>
        <textarea class="editor-body" id="bodyB" placeholder="ã“ã“ã«æ›¸ãâ€¦" oninput="markDirty('B');autoSave('B')"></textarea>
        <div class="child-notes-section" id="childSectionB"></div>
      </div>
      <div class="empty-pane" id="emptyB">
        <div class="icon">ğŸ“„</div>
        <p>å³ãƒšã‚¤ãƒ³ã®ãƒãƒ¼ãƒˆã‚’é¸æŠ</p>
      </div>
    </div>
  </div>
</div>

<div class="ai-pane" id="aiPane">
  <div class="ai-toggle" onclick="toggleAi()">
    <span>ğŸ¤– AIã«è³ªå•ã™ã‚‹</span>
    <span class="ai-arrow" id="aiArrow">â–¼</span>
    <span style="font-size:9px;margin-left:auto;" id="aiProvLabel"></span>
  </div>
  <div class="ai-body">
    <div class="ai-input-wrap">
      <textarea class="ai-question" id="aiQuestion" placeholder="ç–‘å•ãƒ»æ‚©ã¿ã‚’æ›¸ãâ€¦ ä¾‹ï¼šä¸‰äººç§°ã§å†…é¢ã‚’æ›¸ãã¨ãè¦–ç‚¹ãƒ–ãƒ¬ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ"></textarea>
      <div class="ai-actions-row">
        <button class="ai-prov-btn active" id="provGemini" onclick="setAiProv('gemini')">Gemini</button>
        <button class="ai-prov-btn" id="provClaude" onclick="setAiProv('claude')">Claude</button>
        <button class="ai-ask-btn" id="askBtn" onclick="askAI()">è³ªå•ã™ã‚‹ â†’</button>
      </div>
    </div>
    <div class="ai-answer-wrap">
      <div class="ai-answer" id="aiAnswer"><span style="color:#c8bfb0;font-size:11px;">å›ç­”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</span></div>
      <div class="ai-answer-btns" id="aiAnswerBtns" style="display:none;">
        <button class="ai-ans-btn secondary" onclick="copyAiAnswer()">ã‚³ãƒ”ãƒ¼</button>
        <button class="ai-ans-btn primary" onclick="saveAiAsNote()">ãƒãƒ¼ãƒˆã«ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h2>API ã‚­ãƒ¼è¨­å®š</h2>
    <div class="modal-field"><label>Gemini API Key</label><input type="password" id="geminiKeyInput" placeholder="AIzaSy..." /></div>
    <div class="modal-field"><label>Claude API Key</label><input type="password" id="claudeKeyInput" placeholder="sk-ant-..." /></div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="saveApiKeys()">ä¿å­˜</button>
      <button class="btn-secondary" onclick="closeModal('apiModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h2 id="addModalTitle">æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ </h2>
    <div class="add-type-track" id="addTypeTrack">
      <button class="add-type-btn active" data-type="ãƒ«ãƒ¼ãƒ«" onclick="setAddType(this)">ãƒ«ãƒ¼ãƒ«</button>
      <button class="add-type-btn" data-type="æ¦‚å¿µãƒ¡ãƒ¢" onclick="setAddType(this)">æ¦‚å¿µãƒ¡ãƒ¢</button>
      <button class="add-type-btn" data-type="ã‚­ãƒ£ãƒ©èªéŒ²" onclick="setAddType(this)">ã‚­ãƒ£ãƒ©èªéŒ²</button>
      <button class="add-type-btn" data-type="ç·´ç¿’èª²é¡Œ" onclick="setAddType(this)">ç·´ç¿’èª²é¡Œ</button>
      <button class="add-type-btn" data-type="ãã®ä»–" onclick="setAddType(this)">ãã®ä»–</button>
    </div>
    <div class="modal-field"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="addTitle" /></div>
    <div class="modal-field"><label>å†…å®¹</label><textarea id="addBody"></textarea></div>
    <div class="modal-field"><label>ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label><input type="text" id="addTags" placeholder="è¦–ç‚¹ ä¸‰äººç§° åŸºæœ¬" /></div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="addNote()">è¿½åŠ ã™ã‚‹</button>
      <button class="btn-secondary" onclick="closeModal('addModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div class="snippet-panel" id="snippetPanel">
  <h4>ğŸ“‹ å®šå‹æ–‡ãƒ»ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</h4>
  <div class="snippet-grid" id="snippetGrid"></div>
  <div class="snippet-add">
    <input type="text" id="snippetNewInput" placeholder="æ–°ã—ã„å®šå‹æ–‡ã‚’è¿½åŠ â€¦" />
    <button class="snippet-add-btn" onclick="addSnippet()">ï¼‹</button>
  </div>
</div>

<button id="scrollTopBtn" onclick="scrollToTop()" title="æœ€ä¸Šéƒ¨ã¸">â†‘</button>
<div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
// â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notes=[], currentNoteId={A:null,B:null}, dualMode=false;
let isDirty={A:false,B:false}, autoSaveTimers={A:null,B:null};
let geminiKey='', claudeKey='', aiProvider='gemini';
let currentAddType='ãƒ«ãƒ¼ãƒ«', addParentId=null, activeTagFilter='';
let snippets=[], snippetTargetPane='A', dragId=null;

const INIT = [
  {id:1,type:'ãƒ«ãƒ¼ãƒ«',title:'å°èª¬ç”¨ãƒ»è¶…ç°¡ç•¥ãƒ«ãƒ¼ãƒ«',body:'â‘  ã¾ãšæ±ºã‚ã‚‹ã®ã¯ã“ã‚Œã ã‘\nã“ã®ç« ã¯èª°ã®è¦–ç‚¹ã‹ï¼Ÿ\nâ†’ åå‰ã‚’æ›¸ã„ã¦ã‹ã‚‰æ›¸ãã€‚\n\nâ‘¡ ãã®ç« ã§ã‚„ã£ã¦ã„ã„ã“ã¨\nâœ” ãã®äººã®å†…é¢ã‚’æ›¸ã\nâœ” ãã®äººã®æ„Ÿæƒ…ã‚’æ›¸ã\nâœ” ãã®äººã®è§£é‡ˆã‚’æ›¸ã\n\nâ‘¢ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨\nâœ˜ ä»–äººã®æœ¬å¿ƒã‚’æ–­å®šã™ã‚‹\nâœ˜ æœªæ¥ã‚’èª¬æ˜ã™ã‚‹\nâœ˜ ç¥ã®ã‚ˆã†ã«å…¨ä½“ã‚’èªã‚‹\n\nâ‘£ ä¸‰äººç§°ã§è¿·ã£ãŸã‚‰\næ„Ÿæƒ…ã‚’ã€Œèº«ä½“ã€ã§æ›¸ãã€‚\nÃ— æ‚²ã—ã‹ã£ãŸã€€â—‹ å–‰ãŒè©°ã¾ã£ãŸ\nÃ— æ‹’çµ¶ã•ã‚ŒãŸã¨æ€ã£ãŸã€€â—‹ æ‰‹ãŒå®™ã«æ®‹ã£ãŸ\n\nâ‘¤ æœ€çŸ­ç·´ç¿’\n1ã¤ã®æ„Ÿæƒ…ã‚’3é€šã‚Šã§æ›¸ãã€‚\nä¾‹ï¼šæ‹’çµ¶\nãƒ»è¡€ã®æ°—ãŒå¼•ã ãƒ»è¶³å…ƒãŒæºã‚Œã‚‹ ãƒ»è¨€è‘‰ãŒå‡ºãªã„\n\nâ‘¥ æœ€é‡è¦ãƒ«ãƒ¼ãƒ«\nç« ï¼1äººã€€å†…é¢ï¼ãã®äººã ã‘',tags:['è¦–ç‚¹','ä¸‰äººç§°','åŸºæœ¬'],parentId:null,childIds:[3],order:0,date:'2026-02-22'},
  {id:2,type:'æ¦‚å¿µãƒ¡ãƒ¢',title:'äººç§°ã¨è¦–ç‚¹ã®é•ã„',body:'â–  çµè«–\näººç§°ï¼èª°ã®è¨€è‘‰ã§æ›¸ã„ã¦ã„ã‚‹ã‹ï¼ˆæ–‡æ³•ï¼‰\nè¦–ç‚¹ï¼èª°ã®é ­ã®ä¸­ã¾ã§å…¥ã£ã¦ã„ã‚‹ã‹ï¼ˆæƒ…å ±ã®ç¯„å›²ï¼‰\nåˆ¥ç‰©ã€‚\n\nâ–  äººç§°ã¨ã¯\nä¸€äººç§°ï¼šä¿ºã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚\nä¸‰äººç§°ï¼šå½¼ã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚\n\nâ–  è¦–ç‚¹ã¨ã¯ï¼ˆã‚«ãƒ¡ãƒ©ã®ä½ç½®ï¼‰\nä¸‰äººç§°ãƒ»ä¸»äººå…¬è¦–ç‚¹ï¼šå½¼ã®é ­ã ã‘ã«å…¥ã‚‹ã€‚\nä¸‰äººç§°ãƒ»ç¥è¦–ç‚¹ï¼šå…¨å“¡ã®å†…é¢ã«å…¥ã‚Œã‚‹ã€‚\n\nâ–  è¦šãˆæ–¹\näººç§°ï¼ãƒ©ãƒ™ãƒ«ã€€è¦–ç‚¹ï¼ã‚«ãƒ¡ãƒ©ä½ç½®\nãƒ©ãƒ™ãƒ«ã¨ã‚«ãƒ¡ãƒ©ã¯åˆ¥ã€‚',tags:['è¦–ç‚¹','äººç§°','æ¦‚å¿µæ•´ç†'],parentId:null,childIds:[],order:1,date:'2026-02-22'},
  {id:3,type:'ã‚­ãƒ£ãƒ©èªéŒ²',title:'ä¸‡ãƒ»è‘‰ã®è¨€è‘‰',body:'ä¸‡ã€Œè¤‡é›‘ã«è€ƒãˆã‚‹ãªã€‚ç®¡ç†ã™ã‚‹ã®ã¯è¦–ç‚¹äººç‰©ã ã‘ã ã€‚ã€\n\nè‘‰ã€Œè¾æ›¸ã£ã¦ã•ã€è¿·ã£ãŸã¨ãæˆ»ã‚‹å ´æ‰€ã§ã„ã„ã‚“ã ã‚ˆã€‚ã€\n\nè‘‰ã€Œä¸‰äººç§°ã£ã¦ã­ã€å¤–ã‹ã‚‰å‘¼ã‚“ã§ã‚‹ã‘ã©ã€ä¸­ã«ã¯å…¥ã£ã¦ã‚‹çŠ¶æ…‹ãªã‚“ã ã€‚ã€\n\nä¸‡ã€Œå®šç¾©ã‚’åˆ†è§£ã™ã‚‹ã€‚æ„Ÿè¦šã§ã¯ãªãæ§‹é€ ã§ç†è§£ã—ã‚ã€‚ã€',tags:['ä¸‡','è‘‰','èªéŒ²'],parentId:1,childIds:[],order:2,date:'2026-02-22'},
  {id:4,type:'ç·´ç¿’èª²é¡Œ',title:'1æ„Ÿæƒ…ã‚’3é€šã‚Šã§æ›¸ã',body:'ãƒ«ãƒ¼ãƒ«ï¼šæ„Ÿæƒ…èªã‚’ä½¿ã‚ãšã€èº«ä½“ãƒ»è¡Œå‹•ãƒ»æƒ…æ™¯ã§æ›¸ãã€‚\n\nä¾‹ï¼šæ‹’çµ¶\nãƒ»è¡€ã®æ°—ãŒå¼•ã\nãƒ»è¶³å…ƒãŒæºã‚Œã‚‹\nãƒ»è¨€è‘‰ãŒå‡ºãªã„\n\nç·´ç¿’ï¼šã€Œæ‚²ã—ã¿ã€ã€Œæ€’ã‚Šã€ã€Œææ€–ã€ã€Œå–œã³ã€ã€Œå­¤ç‹¬ã€',tags:['ç·´ç¿’','è¡¨ç¾','èº«ä½“æå†™'],parentId:null,childIds:[],order:3,date:'2026-02-22'}
];
const DEF_SNIPPETS=['â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»','ã€ã€€ã€‘','â–  ','â–¶ ','â—† ','â€» ','ğŸ“Œ ','ğŸ’¡ ','âš ï¸ ','â“ ','âœ¨ ','ğŸ”– ','ğŸ“ ','ğŸ’¬ ','ğŸ¯ ','ğŸŒ¿ ','ğŸŒ™ ','ğŸ”¥ ','â†’ ','â‡’ '];

// â”€â”€â”€ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save(){localStorage.setItem('craft_v2',JSON.stringify({notes,geminiKey,claudeKey,aiProvider,snippets,dualMode,dualSubMode}));}

function saveAll(){
  save(); // å‰µä½œãƒãƒ¼ãƒˆã‚’localStorageã«æ›¸ãè¾¼ã‚€
  // ã“ã¨ã°è¾å…¸ã®localStorageã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€åŒã˜å€¤ã§ç¢ºå®šæ›¸ãè¾¼ã¿ï¼ˆã‚¿ãƒ–é–“å…±æœ‰ï¼‰
  try { const d=localStorage.getItem('kotoba_jiten_v2'); if(d) localStorage.setItem('kotoba_jiten_v2',d); } catch(e){}
  const btn=document.getElementById('saveAllBtn');
  btn.textContent='âœ“ ä¿å­˜å®Œäº†'; btn.classList.add('done');
  showToast();
  setTimeout(()=>{ btn.textContent='ğŸ’¾ ä¸€æ‹¬ä¿å­˜'; btn.classList.remove('done'); }, 2000);
}
function load(){
  try{
    const d=JSON.parse(localStorage.getItem('craft_v2')||'{}');
    notes=d.notes?.length?d.notes:JSON.parse(JSON.stringify(INIT));
    geminiKey=d.geminiKey||'';claudeKey=d.claudeKey||'';aiProvider=d.aiProvider||'gemini';
    snippets=d.snippets?.length?d.snippets:[...DEF_SNIPPETS];
    dualMode=d.dualMode||false;
    dualSubMode=d.dualSubMode||'free';
  }catch{
    notes=JSON.parse(JSON.stringify(INIT));
    snippets=[...DEF_SNIPPETS];
    dualMode=false;
    dualSubMode='free';
  }
  notes.forEach(n=>{if(!n.childIds)n.childIds=[];if(n.parentId===undefined)n.parentId=null;});
  updateApiBadge();setAiProv(aiProvider);if(dualMode)enableDual();
}

// â”€â”€â”€ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æŒ¿å…¥ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§å‚ç…§ï¼‰
const INSERTS = [
  '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n',
  '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•\n',
  '\nãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»\n',
  'â–  ', 'â–¶ ', 'â—† ', 'ã€ã€‘', 'â€» ', 'â†’ ', 'â‡’ ',
  'ğŸ“Œ ', 'ğŸ’¡ ', 'âš ï¸ ', 'â“ ', 'âœ¨ ', 'ğŸ”– ', 'ğŸ“ ', 'ğŸ’¬ ', 'ğŸ¯ ', 'ğŸŒ¿ ', 'ğŸŒ™ ', 'ğŸ”¥ '
];

function buildToolbar(p){
  const tb = document.getElementById('toolbar'+p);
  if(!tb) return;
  const groups = [
    {label:'ç½«ç·š', btns:[
      {text:'â”€', idx:0},{text:'â•', idx:1},{text:'â€¦', idx:2}
    ]},
    null,
    {label:'è¨˜å·', btns:[
      {text:'â– ', idx:3},{text:'â–¶', idx:4},{text:'â—†', idx:5},
      {text:'ã€ã€‘', idx:6},{text:'â€»', idx:7},{text:'â†’', idx:8},{text:'â‡’', idx:9}
    ]},
    null,
    {label:'ç•ªå·', btns:[
      {text:'â‘ ', fn:'insertSeq'},{text:'ï¼ˆä¸€ï¼‰', fn:'insertSeqK'}
    ]},
    null,
    {label:'çµµæ–‡å­—', btns:[
      {text:'ğŸ“Œ',idx:10},{text:'ğŸ’¡',idx:11},{text:'âš ï¸',idx:12},{text:'â“',idx:13},
      {text:'âœ¨',idx:14},{text:'ğŸ”–',idx:15},{text:'ğŸ“',idx:16},{text:'ğŸ’¬',idx:17},
      {text:'ğŸ¯',idx:18},{text:'ğŸŒ¿',idx:19},{text:'ğŸŒ™',idx:20},{text:'ğŸ”¥',idx:21}
    ]},
    null,
    {snippet:true}
  ];
  let h = '';
  for(const g of groups){
    if(!g){ h += '<div class="tb-sep"></div>'; continue; }
    if(g.snippet){ h += `<button class="tb-btn wide" onclick="toggleSnippet('${p}',this)">ğŸ“‹ å®šå‹æ–‡</button>`; continue; }
    h += `<span class="tb-label">${g.label}</span>`;
    for(const b of g.btns){
      if(b.fn) h += `<button class="tb-btn" data-pane="${p}" data-fn="${b.fn}" onclick="tbClick(this)">${b.text}</button>`;
      else     h += `<button class="tb-btn" data-pane="${p}" data-idx="${b.idx}" onclick="tbClick(this)">${b.text}</button>`;
    }
  }
  tb.innerHTML = h;
}

function tbClick(btn){
  const p = btn.dataset.pane;
  if(btn.dataset.fn){
    if(btn.dataset.fn === 'insertSeq') insertSeq(p);
    else insertSeqK(p);
  } else {
    insertAt(p, INSERTS[parseInt(btn.dataset.idx)]);
  }
}



function insertAt(p,text){
  const ta=document.getElementById('body'+p);if(!ta)return;
  const s=ta.selectionStart,e=ta.selectionEnd;
  ta.value=ta.value.slice(0,s)+text+ta.value.slice(e);
  ta.selectionStart=ta.selectionEnd=s+text.length;ta.focus();markDirty(p);
}

const SEQ=['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨','â‘©'];
const SEQK=['ï¼ˆä¸€ï¼‰','ï¼ˆäºŒï¼‰','ï¼ˆä¸‰ï¼‰','ï¼ˆå››ï¼‰','ï¼ˆäº”ï¼‰','ï¼ˆå…­ï¼‰','ï¼ˆä¸ƒï¼‰','ï¼ˆå…«ï¼‰','ï¼ˆä¹ï¼‰','ï¼ˆåï¼‰'];
let si={A:0,B:0},ski={A:0,B:0};
function insertSeq(p){insertAt(p,SEQ[si[p]%10]+' ');si[p]++;}
function insertSeqK(p){insertAt(p,SEQK[ski[p]%10]+' ');ski[p]++;}

function toggleSnippet(p,btn){
  snippetTargetPane=p;
  const panel=document.getElementById('snippetPanel');
  // åŒã˜ãƒšã‚¤ãƒ³ã§æ—¢ã«é–‹ã„ã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
  if(panel.classList.contains('show') && panel.dataset.pane===p){
    panel.classList.remove('show'); panel.dataset.pane=''; return;
  }
  panel.dataset.pane=p;
  // ä¸€æ—¦éè¡¨ç¤ºã§æç”»ã—ã¦ã‚µã‚¤ã‚ºå–å¾—
  panel.style.visibility='hidden';
  panel.classList.add('show');
  renderSnippetPanel();
  const r=btn.getBoundingClientRect();
  const pw=panel.offsetWidth, ph=panel.offsetHeight;
  let top=r.bottom+4, left=r.left;
  if(left+pw>window.innerWidth-8) left=window.innerWidth-pw-8;
  if(left<8) left=8;
  if(top+ph>window.innerHeight-8) top=r.top-ph-4;
  if(top<8) top=8;
  panel.style.top=top+'px'; panel.style.left=left+'px';
  panel.style.visibility='';
}
function renderSnippetPanel(){
  const g=document.getElementById('snippetGrid');
  g.innerHTML=snippets.map((s,i)=>
    `<button class="snippet-item" onclick="useSnippet(${i})">${escHtml(s.replace(/\n/g,'â†µ'))}<span class="snippet-del" onclick="event.stopPropagation();deleteSnippet(${i})">Ã—</span></button>`
  ).join('');
  // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
  const inp=document.getElementById('snippetNewInput');
  if(inp) inp.value='';
}
function useSnippet(i){insertAt(snippetTargetPane,snippets[i]);document.getElementById('snippetPanel').classList.remove('show');}
function addSnippet(){
  const v=document.getElementById('snippetNewInput').value.trim();if(!v)return;
  snippets.push(v);save();renderSnippetPanel();
}
function deleteSnippet(i){snippets.splice(i,1);save();renderSnippetPanel();}
document.addEventListener('click',e=>{if(!e.target.closest('#snippetPanel')&&!e.target.closest('[onclick*="toggleSnippet"]'))document.getElementById('snippetPanel').classList.remove('show');});

// â”€â”€â”€ ãƒªã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function typeCls(t){return t==='ãƒ«ãƒ¼ãƒ«'?'type-rule':t==='æ¦‚å¿µãƒ¡ãƒ¢'?'type-concept':t==='ã‚­ãƒ£ãƒ©èªéŒ²'?'type-quote':t==='ç·´ç¿’èª²é¡Œ'?'type-drill':'type-other';}
function getChildren(pid){return notes.filter(n=>n.parentId===pid);}

function renderList(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const cat=document.getElementById('catFilter').value;
  function match(n){
    const selfOk=(!cat||n.type===cat)&&(!activeTagFilter||(n.tags||[]).includes(activeTagFilter))&&(!search||[n.title,n.body,...(n.tags||[])].join(' ').toLowerCase().includes(search));
    return selfOk||getChildren(n.id).some(c=>match(c));
  }
  const roots=notes.filter(n=>!n.parentId&&match(n)).sort((a,b)=>(a.order??0)-(b.order??0));
  document.getElementById('noteList').innerHTML=roots.map(n=>renderItem(n,0)).join('');
  const allTags=[...new Set(notes.flatMap(n=>n.tags||[]))].sort();
  document.getElementById('tagBar').innerHTML=allTags.map(t=>`<span class="tag-chip ${activeTagFilter===t?'active':''}" onclick="toggleTag('${t}')">#${t}</span>`).join('');
  updatePaneSelects();
}

function renderItem(n,depth){
  const ch=getChildren(n.id).sort((a,b)=>(a.order??0)-(b.order??0));
  const isA=n.id===currentNoteId.A,isB=n.id===currentNoteId.B;
  let html=`<div class="note-item ${(isA||isB)?'active':''}" data-id="${n.id}" draggable="true"
    onclick="openNote(${n.id})"
    ondragstart="onDragStart(event,${n.id})" ondragover="onDragOver(event)"
    ondrop="onDrop(event,${n.id})" ondragleave="onDragLeave(event)" ondragend="onDragEnd(event)"
    style="padding-left:${6+depth*14}px;">
    <span class="note-item-drag">â ¿</span>
    <div class="note-item-body">
      <div class="note-item-title">
        ${ch.length?`<span class="note-item-expand" onclick="event.stopPropagation();toggleCh(${n.id},this)">â–¶</span>`:'<span style="width:12px;display:inline-block;"></span>'}
        ${escHtml(n.title)}
        ${isA?'<span style="font-size:8px;color:var(--accent2);margin-left:2px;">[å·¦]</span>':''}
        ${isB?'<span style="font-size:8px;color:#2a5a8a;margin-left:2px;">[å³]</span>':''}
      </div>
      <div class="note-item-meta">
        <span class="note-item-type ${typeCls(n.type)}">${n.type}</span>
        ${(n.tags||[]).slice(0,2).map(t=>`<span>#${t}</span>`).join('')}
        ${ch.length?`<span style="color:var(--accent2);">å­${ch.length}</span>`:''}
      </div>
    </div>
    <span class="note-item-del" onclick="event.stopPropagation();deleteNote(${n.id})">Ã—</span>
  </div>`;
  if(ch.length){
    html+=`<div class="children-list" id="ch-${n.id}" style="display:none;">`+
      ch.map(c=>renderItem(c,depth+1)).join('')+
      `<div style="padding:3px 10px 5px ${20+depth*14}px;"><button style="font-size:9px;background:none;border:1px dashed var(--border);color:var(--muted);padding:2px 7px;cursor:pointer;" onclick="event.stopPropagation();showAddModal(${n.id})">ï¼‹ å­ãƒãƒ¼ãƒˆã‚’è¿½åŠ </button></div>
    </div>`;
  }
  return html;
}

function toggleCh(id,el){
  const c=document.getElementById('ch-'+id);if(!c)return;
  const open=c.style.display!=='none';c.style.display=open?'none':'block';el.textContent=open?'â–¶':'â–¼';
}

// â”€â”€â”€ ãƒãƒ¼ãƒˆé–‹é–‰ãƒ»ç·¨é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNote(id,pane){
  if(!pane)pane='A';
  if(isDirty[pane]&&currentNoteId[pane])savePane(pane,true);
  currentNoteId[pane]=id;
  const n=notes.find(x=>x.id===id);if(!n)return;
  document.getElementById('title'+pane).value=n.title;
  document.getElementById('type'+pane).value=n.type;
  document.getElementById('tags'+pane).value=(n.tags||[]).join(' ');
  document.getElementById('body'+pane).value=n.body||'';
  document.getElementById('editorWrap'+pane).style.display='flex';
  document.getElementById('empty'+pane).style.display='none';
  isDirty[pane]=false;
  const btn=document.getElementById('saveBtn'+pane);btn.textContent='ä¿å­˜';btn.classList.remove('saved');
  si[pane]=0;ski[pane]=0;
  renderChildSection(pane,n);renderList();
  // è¦ªå­ãƒ¢ãƒ¼ãƒ‰: å·¦ãƒšã‚¤ãƒ³ãŒå¤‰ã‚ã£ãŸã‚‰å³ãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒœã‚¿ãƒ³æ›´æ–°
  if(dualMode && dualSubMode==='parent-child'){
    if(pane==='A'){
      // å³ãƒšã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢
      if(isDirty.B && currentNoteId.B) savePane('B', true);
      currentNoteId.B = null;
      document.getElementById('editorWrapB').style.display = 'none';
      document.getElementById('emptyB').style.display = 'flex';
      renderChildPageBtns(id);
    } else if(pane==='B'){
      renderChildPageBtns(currentNoteId.A);
    }
  }
}
function loadNoteToPane(p,v){if(v)openNote(parseInt(v),p);}
function markDirty(p){isDirty[p]=true;const b=document.getElementById('saveBtn'+p);b.textContent='â— ä¿å­˜';b.classList.remove('saved');}
function autoSave(p){clearTimeout(autoSaveTimers[p]);autoSaveTimers[p]=setTimeout(()=>{if(isDirty[p])savePane(p,true);},2000);}
function savePane(p,silent=false){
  const id=currentNoteId[p];if(!id)return;
  const n=notes.find(x=>x.id===id);if(!n)return;
  n.title=document.getElementById('title'+p).value.trim()||'ï¼ˆç„¡é¡Œï¼‰';
  n.type=document.getElementById('type'+p).value;
  n.tags=document.getElementById('tags'+p).value.trim().split(/\s+/).filter(Boolean);
  n.body=document.getElementById('body'+p).value;
  n.date=new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'});
  isDirty[p]=false;save();renderList();
  if(!silent){const b=document.getElementById('saveBtn'+p);b.textContent='âœ“ ä¿å­˜æ¸ˆã¿';b.classList.add('saved');setTimeout(()=>{b.textContent='ä¿å­˜';b.classList.remove('saved');},2000);showToast();}
}

function renderChildSection(p,n){
  const sec=document.getElementById('childSection'+p);if(!sec)return;
  const ch=getChildren(n.id);
  sec.innerHTML=`<div class="child-notes-header"><span class="child-notes-title">ğŸ“ å­ãƒãƒ¼ãƒˆ</span><button class="child-add-btn" onclick="showAddModal(${n.id})">ï¼‹ è¿½åŠ </button></div>
  <div class="child-list">${ch.length===0?'<span style="font-size:11px;color:var(--muted);">ãªã—</span>':
    ch.map(c=>`<div class="child-chip" onclick="openNote(${c.id},'${p}')"><span class="note-item-type ${typeCls(c.type)}" style="font-size:8px;">${c.type}</span>${escHtml(c.title)}<span class="child-chip-del" onclick="event.stopPropagation();unlinkChild(${c.id},${n.id})">Ã—</span></div>`).join('')}
  </div>`;
}

function unlinkChild(cid,pid){
  const c=notes.find(n=>n.id===cid),p=notes.find(n=>n.id===pid);
  if(c)c.parentId=null;if(p)p.childIds=(p.childIds||[]).filter(x=>x!==cid);
  save();renderList();
  const pane=currentNoteId.A===pid?'A':currentNoteId.B===pid?'B':null;
  if(pane&&p)renderChildSection(pane,p);
}

// â”€â”€â”€ è¿½åŠ ãƒ»å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddModal(pid){
  addParentId=pid;
  document.getElementById('addModalTitle').textContent=pid?'å­ãƒãƒ¼ãƒˆã‚’è¿½åŠ ':'æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ ';
  ['addTitle','addBody','addTags'].forEach(id=>document.getElementById(id).value='');
  showModal('addModal');setTimeout(()=>document.getElementById('addTitle').focus(),50);
}
function setAddType(btn){document.querySelectorAll('#addTypeTrack .add-type-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentAddType=btn.dataset.type;}
function addNote(){
  const title=document.getElementById('addTitle').value.trim();
  const body=document.getElementById('addBody').value.trim();
  const tags=document.getElementById('addTags').value.trim().split(/\s+/).filter(Boolean);
  const n={id:Date.now(),type:currentAddType,title:title||'ï¼ˆç„¡é¡Œï¼‰',body,tags,parentId:addParentId||null,childIds:[],order:addParentId?999:-1,date:new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'})};
  if(!addParentId)notes.forEach(x=>{if(!x.parentId)x.order=(x.order??0)+1;});
  n.order=addParentId?999:0;notes.push(n);
  if(addParentId){const p=notes.find(x=>x.id===addParentId);if(p){if(!p.childIds)p.childIds=[];p.childIds.push(n.id);}}
  save();closeModal('addModal');renderList();openNote(n.id,addParentId?(currentNoteId.B?'B':'A'):'A');
}
function deleteNote(id){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  const n=notes.find(x=>x.id===id);
  if(n?.parentId){const p=notes.find(x=>x.id===n.parentId);if(p)p.childIds=(p.childIds||[]).filter(c=>c!==id);}
  notes.filter(x=>x.parentId===id).forEach(x=>x.parentId=null);
  notes=notes.filter(x=>x.id!==id);
  ['A','B'].forEach(p=>{if(currentNoteId[p]===id){currentNoteId[p]=null;document.getElementById('editorWrap'+p).style.display='none';document.getElementById('empty'+p).style.display='flex';}});
  save();renderList();
}

// â”€â”€â”€ è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// dualSubMode: 'free'=è‡ªç”±é…ç½®, 'parent-child'=è¦ªå­é€£å‹•
let dualSubMode = 'free';

function toggleDual(){
  if(!dualMode){ dualMode=true; enableDual(); }
  else if(dualSubMode==='free'){ dualSubMode='parent-child'; applyDualSubMode(); }
  else { dualMode=false; dualSubMode='free'; disableDual(); }
  save();
}

function enableDual(){
  document.getElementById('paneB').style.display='flex';
  document.getElementById('paneAHeader').style.display='flex';
  document.getElementById('dualToggle').classList.add('on');
  applyDualSubMode();
  updatePaneSelects();
}

function applyDualSubMode(){
  const isPC = dualSubMode==='parent-child';
  // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«
  const tog = document.getElementById('dualToggle');
  if(!dualMode){ tog.textContent='è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰'; tog.classList.remove('on'); return; }
  tog.textContent = isPC ? 'è¦ªå­ãƒ¢ãƒ¼ãƒ‰ â—' : 'è‡ªç”±ãƒ¢ãƒ¼ãƒ‰ â—';

  // å³ãƒ‘ãƒãƒ«ãƒ©ãƒ™ãƒ«
  const lbl = document.getElementById('paneBLabel');
  if(lbl) lbl.textContent = isPC ? 'å³ / å­' : 'å³';

  // è‡ªç”±ãƒ¢ãƒ¼ãƒ‰: selectã‚’è¡¨ç¤º
  const selB = document.getElementById('paneBSelect');
  const pageBtns = document.getElementById('paneBPageBtns');
  const addChildBtn = document.getElementById('addChildBtn');
  if(selB) selB.style.display = isPC ? 'none' : '';
  if(pageBtns) pageBtns.style.display = isPC ? 'flex' : 'none';
  if(addChildBtn) addChildBtn.style.display = isPC ? '' : 'none';

  // è¦ªå­ãƒ¢ãƒ¼ãƒ‰: å·¦ã«è¦ªãŒé–‹ã„ã¦ã„ã‚Œã°å³ã«å­ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  if(isPC && currentNoteId.A) renderChildPageBtns(currentNoteId.A);
}

function disableDual(){
  if(isDirty.B) savePane('B',true);
  document.getElementById('paneB').style.display='none';
  document.getElementById('paneAHeader').style.display='none';
  const tog = document.getElementById('dualToggle');
  tog.textContent='è¦‹é–‹ããƒ¢ãƒ¼ãƒ‰'; tog.classList.remove('on');
}

function renderChildPageBtns(parentId){
  const wrap = document.getElementById('paneBPageBtns');
  if(!wrap) return;
  const children = getChildren(parentId);
  const cur = currentNoteId.B;
  wrap.innerHTML = children.map(ch =>
    `<button style="font-size:10px;padding:3px 8px;border:1px solid var(--border);background:${ch.id===cur?'var(--accent)':'var(--paper)'};color:${ch.id===cur?'#fff':'var(--muted)'};cursor:pointer;white-space:nowrap;border-radius:1px;" onclick="openNote(${ch.id},'B')">${escHtml(ch.title)}</button>`
  ).join('') + (children.length===0 ? '<span style="font-size:10px;color:var(--muted);">å­ãƒšãƒ¼ã‚¸ãªã—ã€€â†’ã€€ï¼‹å­ãƒšãƒ¼ã‚¸ã§è¿½åŠ </span>' : '');
  // å­ãªã—ã®ã¨ãå³ãƒšã‚¤ãƒ³ã«ã€Œç©ºã€è¡¨ç¤º
  if(children.length===0 && currentNoteId.B===null){
    document.getElementById('editorWrapB').style.display='none';
    document.getElementById('emptyB').style.display='flex';
  }
}

function createChildFromParent(){
  const parentId = currentNoteId.A;
  if(!parentId){ alert('å·¦ãƒšã‚¤ãƒ³ã«ãƒãƒ¼ãƒˆã‚’é–‹ã„ã¦ãã ã•ã„'); return; }
  const parent = notes.find(n=>n.id===parentId);
  if(!parent) return;
  const title = parent.title + ' - ' + (getChildren(parentId).length + 1);
  const n = {
    id: Date.now(), type: parent.type, title, body: '',
    tags: [...(parent.tags||[])],
    parentId, childIds: [], order: 999,
    date: new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'})
  };
  if(!parent.childIds) parent.childIds=[];
  parent.childIds.push(n.id);
  notes.push(n);
  save(); renderList(); renderChildPageBtns(parentId);
  openNote(n.id,'B');
}

function updatePaneSelects(){
  // è‡ªç”±ãƒ¢ãƒ¼ãƒ‰ã®ã¿selectæ›´æ–°
  const selA = document.getElementById('paneASelect');
  const selB = document.getElementById('paneBSelect');
  if(selA){ const c=currentNoteId.A; selA.innerHTML='<option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>'+notes.map(n=>`<option value="${n.id}" ${n.id===c?'selected':''}>${escHtml(n.title)}</option>`).join(''); }
  if(selB){ const c=currentNoteId.B; selB.innerHTML='<option value="">ãƒãƒ¼ãƒˆã‚’é¸æŠâ€¦</option>'+notes.map(n=>`<option value="${n.id}" ${n.id===c?'selected':''}>${escHtml(n.title)}</option>`).join(''); }
}

// â”€â”€â”€ ãƒ‰ãƒ©ãƒƒã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e,id){dragId=id;e.target.classList.add('dragging');}
function onDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function onDragLeave(e){e.currentTarget.classList.remove('drag-over');}
function onDragEnd(e){e.target.classList.remove('dragging');document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));}
function onDrop(e,tid){e.preventDefault();e.currentTarget.classList.remove('drag-over');if(dragId===tid)return;const si=notes.findIndex(n=>n.id===dragId),ti=notes.findIndex(n=>n.id===tid);if(si<0||ti<0)return;const[m]=notes.splice(si,1);notes.splice(ti,0,m);notes.forEach((n,i)=>n.order=i);dragId=null;save();renderList();}

// â”€â”€â”€ ã‚¿ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTag(t){activeTagFilter=activeTagFilter===t?'':t;renderList();}

// â”€â”€â”€ AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let aiOpen=false;
function toggleAi(){aiOpen=!aiOpen;document.getElementById('aiPane').classList.toggle('open',aiOpen);}
function setAiProv(p){aiProvider=p;document.getElementById('provGemini').classList.toggle('active',p==='gemini');document.getElementById('provClaude').classList.toggle('active',p==='claude');document.getElementById('aiProvLabel').textContent=p==='gemini'?'Gemini Flash':'Claude Haiku';}
async function askAI(){
  const q=document.getElementById('aiQuestion').value.trim();if(!q)return;
  const key=aiProvider==='gemini'?geminiKey:claudeKey;if(!key){showModal('apiModal');return;}
  const btn=document.getElementById('askBtn');const el=document.getElementById('aiAnswer');
  btn.disabled=true;el.innerHTML='<span class="ai-spinner"></span> ç”Ÿæˆä¸­â€¦';document.getElementById('aiAnswerBtns').style.display='none';
  const n=currentNoteId.A?notes.find(x=>x.id===currentNoteId.A):null;
  const sys='å‰µä½œã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€‚æ—¥æœ¬èª200å­—ä»¥å†…ã§å®Ÿè·µçš„ã«ç­”ãˆã‚‹ã€‚'+(n?`\nå‚è€ƒ:ã€Œ${n.title}ã€${(n.body||'').slice(0,150)}`:'');
  try{
    let ans='';
    if(aiProvider==='gemini'){
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:sys+'\nè³ªå•ï¼š'+q}]}],generationConfig:{maxOutputTokens:512,temperature:0.7}})});
      const d=await r.json();if(!r.ok)throw new Error(d.error?.message||'Geminiã‚¨ãƒ©ãƒ¼');ans=d.candidates?.[0]?.content?.parts?.[0]?.text||'';
    }else{
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:512,system:sys,messages:[{role:'user',content:q}]})});
      const d=await r.json();if(!r.ok)throw new Error(d.error?.message||'Claudeã‚¨ãƒ©ãƒ¼');ans=d.content?.[0]?.text||'';
    }
    el.textContent=ans;document.getElementById('aiAnswerBtns').style.display='flex';
  }catch(e){el.innerHTML=`<span style="color:var(--accent)">ã‚¨ãƒ©ãƒ¼: ${e.message}</span>`;}
  finally{btn.disabled=false;}
}
function copyAiAnswer(){navigator.clipboard?.writeText(document.getElementById('aiAnswer').textContent);}
function saveAiAsNote(){
  const q=document.getElementById('aiQuestion').value.trim();const a=document.getElementById('aiAnswer').textContent;
  document.getElementById('addTitle').value=q.slice(0,30)||'AIè³ªå•ãƒ¡ãƒ¢';
  document.getElementById('addBody').value=`â–  è³ªå•\n${q}\n\nâ–  AIå›ç­”\n${a}`;
  document.getElementById('addTags').value='AIå›ç­”';
  document.querySelectorAll('#addTypeTrack .add-type-btn').forEach(b=>b.classList.toggle('active',b.dataset.type==='æ¦‚å¿µãƒ¡ãƒ¢'));
  currentAddType='æ¦‚å¿µãƒ¡ãƒ¢';addParentId=null;showModal('addModal');
}

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveApiKeys(){const gk=document.getElementById('geminiKeyInput').value.trim();const ck=document.getElementById('claudeKeyInput').value.trim();if(gk)geminiKey=gk;if(ck)claudeKey=ck;updateApiBadge();save();closeModal('apiModal');}
function updateApiBadge(){const b=document.getElementById('apiBadge');const ok=geminiKey||claudeKey;b.textContent=ok?'APIè¨­å®šæ¸ˆã¿':'APIæœªè¨­å®š';b.style.color=ok?'rgba(180,255,180,0.8)':'rgba(255,180,180,0.7)';}

// â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showToast(){const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);}
function scrollToTop(){document.getElementById('bodyA').scrollTo({top:0,behavior:'smooth'});}
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('show');}));
document.getElementById('bodyA').addEventListener('scroll',()=>{document.getElementById('scrollTopBtn').classList.toggle('visible',document.getElementById('bodyA').scrollTop>200);});
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();if(currentNoteId.A)savePane('A');if(dualMode&&currentNoteId.B)savePane('B');}});

// â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();buildToolbar('A');buildToolbar('B');renderList();
const first=notes.filter(n=>!n.parentId).sort((a,b)=>(a.order??0)-(b.order??0))[0];
if(first)openNote(first.id,'A');
</script>
</body>
</html>