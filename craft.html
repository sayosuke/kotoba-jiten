<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‰µä½œãƒãƒ¼ãƒˆ</title>
<style>
/* â”€â”€ å¤‰æ•° â”€â”€ */
:root {
  --ink: #0f0a04; --paper: #f5f0e8; --paper2: #ede7d9;
  --accent: #7a2008; --accent2: #c4763a; --muted: #5a4a3a;
  --border: #d4c9b0; --hover: #e8e2d4; --active-bg: #e0d8c8;
  --sidebar-w: 280px;
  --header-h: 52px;
  --ai-h: 200px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Noto Serif JP', 'Hiragino Mincho ProN', serif;
  background: var(--paper); color: var(--ink);
  height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=Noto+Serif+JP:wght@300;400;600&display=swap');

/* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
.header {
  height: var(--header-h); background: var(--ink); color: var(--paper);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; flex-shrink: 0; gap: 12px;
}
.header-logo { font-size: 14px; letter-spacing: 0.2em; opacity: 0.9; white-space: nowrap; }
.header-search {
  flex: 1; max-width: 320px;
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
  border-radius: 2px; padding: 5px 10px;
}
.header-search input {
  background: none; border: none; outline: none; color: var(--paper);
  font-family: 'Noto Sans JP', sans-serif; font-size: 12px; flex: 1;
}
.header-search input::placeholder { color: rgba(255,255,255,0.4); }
.header-right { display: flex; align-items: center; gap: 8px; }
.api-badge {
  font-size: 9px; letter-spacing: 0.1em; padding: 3px 8px;
  border: 1px solid rgba(255,255,255,0.3); border-radius: 1px;
  color: rgba(255,255,255,0.7); cursor: pointer; white-space: nowrap;
}
.api-badge:hover { background: rgba(255,255,255,0.1); }
.header-btn {
  background: var(--accent2); color: #fff; border: none; border-radius: 1px;
  padding: 5px 14px; font-size: 11px; letter-spacing: 0.1em; cursor: pointer;
  font-family: 'Noto Serif JP', serif; white-space: nowrap;
}
.header-btn:hover { background: var(--accent); }

/* â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€ */
.app-body { flex: 1; display: flex; overflow: hidden; }

/* â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼ â”€â”€ */
.sidebar {
  width: var(--sidebar-w); background: var(--paper2);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  flex-shrink: 0; overflow: hidden;
}
.sidebar-toolbar {
  padding: 10px 12px; border-bottom: 1px solid var(--border);
  display: flex; gap: 6px; align-items: center; flex-shrink: 0;
}
.cat-filter {
  flex: 1; font-size: 11px; padding: 4px 6px; border: 1px solid var(--border);
  background: var(--paper); color: var(--ink); font-family: 'Noto Serif JP', serif;
}
.sidebar-add-btn {
  background: var(--accent); color: #fff; border: none; border-radius: 1px;
  width: 26px; height: 26px; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.sidebar-add-btn:hover { background: var(--accent2); }

/* é …ç›®ãƒªã‚¹ãƒˆ */
.note-list { flex: 1; overflow-y: auto; }
.note-item {
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.12s; user-select: none;
  display: flex; align-items: flex-start; gap: 8px;
}
.note-item:hover { background: var(--hover); }
.note-item.active { background: var(--active-bg); border-left: 3px solid var(--accent); padding-left: 11px; }
.note-item-drag { cursor: grab; opacity: 0.4; font-size: 12px; padding-top: 2px; flex-shrink: 0; }
.note-item.dragging { opacity: 0.4; background: var(--hover); }
.note-item-body { flex: 1; min-width: 0; }
.note-item-title { font-size: 12px; line-height: 1.5; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note-item-meta { font-size: 9px; color: var(--muted); margin-top: 3px; display: flex; gap: 6px; flex-wrap: wrap; }
.note-item-type {
  font-size: 8px; padding: 1px 5px; border-radius: 1px; white-space: nowrap;
}
.note-item-del { opacity: 0; font-size: 11px; color: var(--muted); cursor: pointer; padding: 2px; flex-shrink: 0; align-self: center; }
.note-item:hover .note-item-del { opacity: 0.5; }
.note-item-del:hover { opacity: 1 !important; color: var(--accent); }

/* ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
.tag-bar { padding: 6px 12px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 4px; flex-shrink: 0; min-height: 32px; }
.tag-chip { font-size: 9px; padding: 2px 7px; border-radius: 10px; background: var(--paper); border: 1px solid var(--border); cursor: pointer; color: var(--muted); }
.tag-chip:hover { border-color: var(--accent2); color: var(--accent2); }
.tag-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* â”€â”€ å³ãƒšã‚¤ãƒ³ â”€â”€ */
.main-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* ãƒãƒ¼ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ */
.note-editor { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.editor-toolbar {
  padding: 8px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px; flex-shrink: 0;
  background: var(--paper2);
}
.editor-title-input {
  flex: 1; background: none; border: none; outline: none;
  font-family: 'Noto Serif JP', serif; font-size: 16px; color: var(--ink);
  font-weight: 600;
}
.editor-title-input::placeholder { color: var(--border); }
.type-select {
  font-size: 10px; padding: 3px 6px; border: 1px solid var(--border);
  background: var(--paper); color: var(--ink); font-family: 'Noto Serif JP', serif;
}
.editor-tag-input {
  font-size: 10px; padding: 3px 8px; border: 1px solid var(--border);
  background: var(--paper); color: var(--ink); font-family: 'Noto Sans JP', sans-serif;
  min-width: 120px;
}
.editor-tag-input::placeholder { color: var(--border); }
.editor-save-btn {
  background: var(--accent2); color: #fff; border: none; border-radius: 1px;
  padding: 4px 12px; font-size: 11px; cursor: pointer; font-family: 'Noto Serif JP', serif;
  white-space: nowrap; flex-shrink: 0;
}
.editor-save-btn:hover { background: var(--accent); }
.editor-save-btn.saved { background: #5a8a50; }

/* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ï¼‰ */
.editor-body {
  flex: 1; padding: 24px 28px; resize: none; border: none; outline: none;
  font-family: 'Noto Serif JP', serif; font-size: 13px; line-height: 2;
  color: var(--ink); background: var(--paper); overflow-y: auto;
  white-space: pre-wrap;
}
.editor-body::placeholder { color: var(--border); }

/* ç©ºçŠ¶æ…‹ */
.empty-pane {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; color: var(--muted); gap: 12px;
}
.empty-pane .icon { font-size: 40px; opacity: 0.3; }
.empty-pane p { font-size: 12px; line-height: 2; text-align: center; opacity: 0.6; }

/* â”€â”€ AIè³ªå•ãƒœãƒƒã‚¯ã‚¹ â”€â”€ */
.ai-pane {
  border-top: 1px solid var(--border); background: var(--paper2);
  flex-shrink: 0; display: flex; flex-direction: column;
  max-height: var(--ai-h); transition: max-height 0.2s;
}
.ai-pane.collapsed { max-height: 36px; }
.ai-toggle {
  padding: 8px 20px; display: flex; align-items: center; gap: 8px;
  cursor: pointer; border-bottom: 1px solid var(--border); flex-shrink: 0;
  font-size: 11px; color: var(--muted); letter-spacing: 0.1em; user-select: none;
}
.ai-toggle:hover { background: var(--hover); }
.ai-toggle .arrow { font-size: 9px; transition: transform 0.2s; }
.ai-pane.collapsed .arrow { transform: rotate(180deg); }
.ai-body { flex: 1; display: flex; gap: 0; overflow: hidden; }
.ai-input-wrap { flex: 1; display: flex; flex-direction: column; padding: 8px 12px; gap: 6px; }
.ai-question {
  flex: 1; resize: none; border: 1px solid var(--border); background: var(--paper);
  padding: 8px 10px; font-family: 'Noto Serif JP', serif; font-size: 12px;
  line-height: 1.8; color: var(--ink); outline: none; border-radius: 1px;
}
.ai-question::placeholder { color: var(--border); }
.ai-question-actions { display: flex; gap: 6px; align-items: center; }
.ai-provider { display: flex; gap: 4px; }
.ai-prov-btn {
  font-size: 10px; padding: 3px 8px; border: 1px solid var(--border);
  background: var(--paper); cursor: pointer; border-radius: 1px; color: var(--muted);
}
.ai-prov-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.ai-ask-btn {
  background: var(--accent2); color: #fff; border: none; border-radius: 1px;
  padding: 4px 14px; font-size: 11px; cursor: pointer; font-family: 'Noto Serif JP', serif;
}
.ai-ask-btn:hover { background: var(--accent); }
.ai-ask-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.ai-answer-wrap { width: 45%; border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.ai-answer {
  flex: 1; padding: 8px 12px; font-size: 11px; line-height: 1.9;
  color: var(--ink); overflow-y: auto; white-space: pre-wrap; font-family: 'Noto Sans JP', sans-serif;
}
.ai-answer-actions { padding: 4px 8px; border-top: 1px solid var(--border); display: flex; gap: 6px; justify-content: flex-end; flex-shrink: 0; }
.ai-save-note-btn {
  font-size: 10px; padding: 3px 10px; background: var(--accent); color: #fff;
  border: none; cursor: pointer; border-radius: 1px;
}
.ai-save-note-btn:hover { background: var(--accent2); }
.ai-copy-btn {
  font-size: 10px; padding: 3px 10px; background: none; color: var(--muted);
  border: 1px solid var(--border); cursor: pointer; border-radius: 1px;
}
.ai-copy-btn:hover { color: var(--ink); }
.ai-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ APIè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 900; align-items: center; justify-content: center; }
.modal-overlay.show { display: flex; }
.modal { background: var(--paper); border: 1px solid var(--border); padding: 28px 32px; width: 420px; max-width: 90vw; }
.modal h2 { font-size: 14px; letter-spacing: 0.15em; margin-bottom: 20px; }
.modal-field { margin-bottom: 14px; }
.modal-field label { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); display: block; margin-bottom: 5px; }
.modal-field input { width: 100%; padding: 7px 10px; border: 1px solid var(--border); background: var(--paper2); font-family: 'Noto Sans JP', sans-serif; font-size: 12px; }
.modal-actions { display: flex; gap: 8px; margin-top: 20px; }
.btn-primary { background: var(--accent); color: #fff; border: none; padding: 7px 20px; cursor: pointer; font-family: 'Noto Serif JP', serif; font-size: 12px; }
.btn-primary:hover { background: var(--accent2); }
.btn-secondary { background: none; color: var(--muted); border: 1px solid var(--border); padding: 7px 16px; cursor: pointer; font-size: 12px; }

/* â”€â”€ è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
.add-modal { background: var(--paper); border: 1px solid var(--border); padding: 28px 32px; width: 560px; max-width: 95vw; }
.add-modal h2 { font-size: 13px; letter-spacing: 0.15em; margin-bottom: 18px; }
.add-type-track { display: flex; border: 1px solid var(--border); border-radius: 1px; overflow: hidden; margin-bottom: 12px; }
.add-type-btn { flex: 1; padding: 6px 2px; font-size: 11px; background: var(--paper); border: none; border-right: 1px solid var(--border); cursor: pointer; font-family: 'Noto Serif JP', serif; color: var(--muted); }
.add-type-btn:last-child { border-right: none; }
.add-type-btn.active { background: var(--accent); color: #fff; }
.add-title-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); background: var(--paper2); font-family: 'Noto Serif JP', serif; font-size: 13px; margin-bottom: 8px; }
.add-body-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); background: var(--paper2); font-family: 'Noto Serif JP', serif; font-size: 12px; line-height: 1.9; resize: vertical; min-height: 180px; }
.add-tag-input { width: 100%; padding: 6px 12px; border: 1px solid var(--border); background: var(--paper2); font-family: 'Noto Sans JP', sans-serif; font-size: 11px; margin-top: 8px; }

/* â”€â”€ ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚° â”€â”€ */
#scrollTopBtn {
  position: fixed; bottom: 24px; right: 24px; z-index: 800;
  background: var(--paper2); color: var(--muted); border: 1px solid var(--border);
  border-radius: 50%; width: 38px; height: 38px; font-size: 15px;
  cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transition: opacity 0.2s; pointer-events: none;
}
#scrollTopBtn.visible { opacity: 1; pointer-events: auto; }

/* â”€â”€ ç¨®åˆ¥ãƒãƒƒã‚¸è‰² â”€â”€ */
.type-rule    { background: #e8f0e4; color: #2a4a1a; }
.type-concept { background: #e8eaf8; color: #1a2a5a; }
.type-quote   { background: #f5ede0; color: #5a3010; }
.type-drill   { background: #f8eae8; color: #5a1a1a; }
.type-other   { background: #ede7d9; color: #5a4a3a; }

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ */
.note-item.drag-over { border-top: 2px solid var(--accent2); }

/* ä¿å­˜ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
.saved-toast { position: fixed; bottom: 70px; right: 24px; background: #2a4a1a; color: #fff; padding: 6px 14px; font-size: 11px; border-radius: 1px; z-index: 900; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
.saved-toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="header">
  <div class="header-logo">ğŸ““ å‰µä½œãƒãƒ¼ãƒˆ</div>
  <div class="header-search">
    <span style="opacity:0.5;font-size:12px;">ğŸ”</span>
    <input type="text" id="searchInput" placeholder="ãƒãƒ¼ãƒˆã‚’æ¤œç´¢â€¦" oninput="renderList()" />
  </div>
  <div class="header-right">
    <span class="api-badge" onclick="showApiModal()" id="apiBadge">APIæœªè¨­å®š</span>
    <a href="index.html" style="color:rgba(255,255,255,0.6);font-size:10px;text-decoration:none;letter-spacing:0.1em;">â† ã“ã¨ã°è¾å…¸</a>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ -->
<div class="app-body">

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <div class="sidebar">
    <div class="sidebar-toolbar">
      <select class="cat-filter" id="catFilter" onchange="renderList()">
        <option value="">ã™ã¹ã¦ã®ç¨®åˆ¥</option>
        <option value="ãƒ«ãƒ¼ãƒ«">ãƒ«ãƒ¼ãƒ«</option>
        <option value="æ¦‚å¿µãƒ¡ãƒ¢">æ¦‚å¿µãƒ¡ãƒ¢</option>
        <option value="ã‚­ãƒ£ãƒ©èªéŒ²">ã‚­ãƒ£ãƒ©èªéŒ²</option>
        <option value="ç·´ç¿’èª²é¡Œ">ç·´ç¿’èª²é¡Œ</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <button class="sidebar-add-btn" onclick="showAddModal()" title="æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ ">ï¼‹</button>
    </div>
    <div class="tag-bar" id="tagBar"></div>
    <div class="note-list" id="noteList"></div>
  </div>

  <!-- å³ãƒšã‚¤ãƒ³ -->
  <div class="main-pane">
    <div class="note-editor" id="noteEditor" style="display:none;">
      <div class="editor-toolbar">
        <input type="text" class="editor-title-input" id="editorTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" oninput="markDirty()" />
        <select class="type-select" id="editorType" onchange="markDirty()">
          <option value="ãƒ«ãƒ¼ãƒ«">ãƒ«ãƒ¼ãƒ«</option>
          <option value="æ¦‚å¿µãƒ¡ãƒ¢">æ¦‚å¿µãƒ¡ãƒ¢</option>
          <option value="ã‚­ãƒ£ãƒ©èªéŒ²">ã‚­ãƒ£ãƒ©èªéŒ²</option>
          <option value="ç·´ç¿’èª²é¡Œ">ç·´ç¿’èª²é¡Œ</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
        <input type="text" class="editor-tag-input" id="editorTags" placeholder="ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰" oninput="markDirty()" />
        <button class="editor-save-btn" id="saveBtn" onclick="saveCurrentNote()">ä¿å­˜</button>
      </div>
      <textarea class="editor-body" id="editorBody" placeholder="ã“ã“ã«å†…å®¹ã‚’æ›¸ãâ€¦&#10;&#10;Markdownãƒ©ã‚¤ã‚¯ã«æ›¸ã‘ã¾ã™ï¼š&#10;â–  è¦‹å‡ºã—&#10;â‘  â‘¡ç•ªå·ãƒªã‚¹ãƒˆ&#10;âœ” ãƒã‚§ãƒƒã‚¯" oninput="markDirty(); autoSave()"></textarea>
    </div>
    <div class="empty-pane" id="emptyPane">
      <div class="icon">ğŸ““</div>
      <p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ¼ãƒˆã‚’é¸ã¶<br>ã¾ãŸã¯ ï¼‹ ã§æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ </p>
    </div>
  </div>
</div>

<!-- AIè³ªå•ãƒœãƒƒã‚¯ã‚¹ -->
<div class="ai-pane" id="aiPane">
  <div class="ai-toggle" onclick="toggleAi()">
    <span>ğŸ¤– AIã«è³ªå•ã™ã‚‹</span>
    <span class="arrow" id="aiArrow">â–²</span>
    <span style="font-size:9px;color:var(--muted);margin-left:auto;" id="aiProvLabel"></span>
  </div>
  <div class="ai-body" id="aiBody">
    <div class="ai-input-wrap">
      <textarea class="ai-question" id="aiQuestion" placeholder="ç–‘å•ãƒ»æ‚©ã¿ã‚’æ›¸ãâ€¦&#10;ä¾‹ï¼šä¸‰äººç§°ã§å†…é¢ã‚’æ›¸ãã¨ãã€ã©ã“ã¾ã§ãŒè¦–ç‚¹ãƒ–ãƒ¬ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ" rows="3"></textarea>
      <div class="ai-question-actions">
        <div class="ai-provider">
          <button class="ai-prov-btn active" id="provGemini" onclick="setAiProv('gemini')">Gemini</button>
          <button class="ai-prov-btn" id="provClaude" onclick="setAiProv('claude')">Claude</button>
        </div>
        <button class="ai-ask-btn" id="askBtn" onclick="askAI()">è³ªå•ã™ã‚‹ â†’</button>
      </div>
    </div>
    <div class="ai-answer-wrap">
      <div class="ai-answer" id="aiAnswer"><span style="color:var(--muted);font-size:11px;">å›ç­”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</span></div>
      <div class="ai-answer-actions" id="aiAnswerActions" style="display:none;">
        <button class="ai-copy-btn" onclick="copyAiAnswer()">ã‚³ãƒ”ãƒ¼</button>
        <button class="ai-save-note-btn" onclick="saveAiAsNote()">ãƒãƒ¼ãƒˆã«ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- APIè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h2>API ã‚­ãƒ¼è¨­å®š</h2>
    <div class="modal-field">
      <label>Gemini API Keyï¼ˆAIzaã€œï¼‰</label>
      <input type="password" id="geminiKeyInput" placeholder="AIzaSy..." />
      <div id="geminiStatus" style="font-size:10px;color:var(--muted);margin-top:3px;"></div>
    </div>
    <div class="modal-field">
      <label>Claude API Keyï¼ˆsk-ant-ã€œï¼‰</label>
      <input type="password" id="claudeKeyInput" placeholder="sk-ant-..." />
      <div id="claudeStatus" style="font-size:10px;color:var(--muted);margin-top:3px;"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="saveApiKeys()">ä¿å­˜</button>
      <button class="btn-secondary" onclick="closeApiModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒãƒ¼ãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="addModal">
  <div class="add-modal">
    <h2>æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’è¿½åŠ </h2>
    <div class="add-type-track" id="addTypeTrack">
      <button class="add-type-btn active" data-type="ãƒ«ãƒ¼ãƒ«" onclick="setAddType(this)">ãƒ«ãƒ¼ãƒ«</button>
      <button class="add-type-btn" data-type="æ¦‚å¿µãƒ¡ãƒ¢" onclick="setAddType(this)">æ¦‚å¿µãƒ¡ãƒ¢</button>
      <button class="add-type-btn" data-type="ã‚­ãƒ£ãƒ©èªéŒ²" onclick="setAddType(this)">ã‚­ãƒ£ãƒ©èªéŒ²</button>
      <button class="add-type-btn" data-type="ç·´ç¿’èª²é¡Œ" onclick="setAddType(this)">ç·´ç¿’èª²é¡Œ</button>
      <button class="add-type-btn" data-type="ãã®ä»–" onclick="setAddType(this)">ãã®ä»–</button>
    </div>
    <input type="text" class="add-title-input" id="addTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
    <textarea class="add-body-input" id="addBody" placeholder="å†…å®¹ã‚’æ›¸ãâ€¦"></textarea>
    <input type="text" class="add-tag-input" id="addTags" placeholder="ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰ ä¾‹ï¼šè¦–ç‚¹ ä¸‰äººç§° åŸºæœ¬" />
    <div class="modal-actions" style="margin-top:14px;">
      <button class="btn-primary" onclick="addNote()">è¿½åŠ ã™ã‚‹</button>
      <button class="btn-secondary" onclick="closeAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
<button id="scrollTopBtn" onclick="scrollTop()" title="æœ€ä¸Šéƒ¨ã¸">â†‘</button>
<div class="saved-toast" id="savedToast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
// â”€â”€ çŠ¶æ…‹ â”€â”€
let notes = [];
let currentNoteId = null;
let geminiKey = '';
let claudeKey = '';
let aiProvider = 'gemini';
let currentAddType = 'ãƒ«ãƒ¼ãƒ«';
let activeTagFilter = '';
let isDirty = false;
let autoSaveTimer = null;

// â”€â”€ åˆæœŸãƒ‡ãƒ¼ã‚¿ â”€â”€
const INITIAL_NOTES = [
  {
    id: 1,
    type: 'ãƒ«ãƒ¼ãƒ«',
    title: 'å°èª¬ç”¨ãƒ»è¶…ç°¡ç•¥ãƒ«ãƒ¼ãƒ«',
    body: 'â‘  ã¾ãšæ±ºã‚ã‚‹ã®ã¯ã“ã‚Œã ã‘\nã“ã®ç« ã¯èª°ã®è¦–ç‚¹ã‹ï¼Ÿ\nâ†’ åå‰ã‚’æ›¸ã„ã¦ã‹ã‚‰æ›¸ãã€‚\n\nâ‘¡ ãã®ç« ã§ã‚„ã£ã¦ã„ã„ã“ã¨\nâœ” ãã®äººã®å†…é¢ã‚’æ›¸ã\nâœ” ãã®äººã®æ„Ÿæƒ…ã‚’æ›¸ã\nâœ” ãã®äººã®è§£é‡ˆã‚’æ›¸ã\n\nâ‘¢ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨\nâœ˜ ä»–äººã®æœ¬å¿ƒã‚’æ–­å®šã™ã‚‹\nâœ˜ æœªæ¥ã‚’èª¬æ˜ã™ã‚‹\nâœ˜ ç¥ã®ã‚ˆã†ã«å…¨ä½“ã‚’èªã‚‹ï¼ˆç¥è¦–ç‚¹ã§ãªã„é™ã‚Šï¼‰\n\nâ‘£ ä¸‰äººç§°ã§è¿·ã£ãŸã‚‰\næ„Ÿæƒ…ã‚’ã€Œèº«ä½“ã€ã§æ›¸ãã€‚\nÃ— æ‚²ã—ã‹ã£ãŸã€€â—‹ å–‰ãŒè©°ã¾ã£ãŸ\nÃ— æ‹’çµ¶ã•ã‚ŒãŸã¨æ€ã£ãŸã€€â—‹ æ‰‹ãŒå®™ã«æ®‹ã£ãŸ\n\nâ‘¤ æœ€çŸ­ç·´ç¿’\n1ã¤ã®æ„Ÿæƒ…ã‚’3é€šã‚Šã§æ›¸ãã€‚\nä¾‹ï¼šæ‹’çµ¶\nãƒ»è¡€ã®æ°—ãŒå¼•ã\nãƒ»è¶³å…ƒãŒæºã‚Œã‚‹\nãƒ»è¨€è‘‰ãŒå‡ºãªã„\n\nâ‘¥ æœ€é‡è¦ãƒ«ãƒ¼ãƒ«\nç« ï¼1äººã€€å†…é¢ï¼ãã®äººã ã‘\nã“ã‚Œã ã‘å®ˆã‚Œã°å´©ã‚Œãªã„ã€‚',
    tags: ['è¦–ç‚¹', 'ä¸‰äººç§°', 'åŸºæœ¬ãƒ«ãƒ¼ãƒ«'],
    date: '2026-02-22',
    order: 0
  },
  {
    id: 2,
    type: 'æ¦‚å¿µãƒ¡ãƒ¢',
    title: 'äººç§°ã¨è¦–ç‚¹ã®é•ã„',
    body: 'â–  çµè«–ï¼ˆã¾ãšã“ã‚Œã ã‘ï¼‰\näººç§°ï¼èª°ã®è¨€è‘‰ã§æ›¸ã„ã¦ã„ã‚‹ã‹ï¼ˆæ–‡æ³•ï¼‰\nè¦–ç‚¹ï¼èª°ã®é ­ã®ä¸­ã¾ã§å…¥ã£ã¦ã„ã‚‹ã‹ï¼ˆæƒ…å ±ã®ç¯„å›²ï¼‰\nåˆ¥ç‰©ã€‚\n\nâ–  äººç§°ã¨ã¯ï¼ˆæ–‡æ³•ã®è©±ï¼‰\nä¸€äººç§°ï¼šä¿ºã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚èªã‚Šæ‰‹ï¼ç™»å ´äººç‰©ã€‚\nä¸‰äººç§°ï¼šå½¼ã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚èªã‚Šæ‰‹ï¼ç‰©èªã®å¤–ã€‚\nã“ã“ã¾ã§ã¯ã€Œä¸»èªã®å•é¡Œã€ã€‚\n\nâ–  è¦–ç‚¹ã¨ã¯ï¼ˆã‚«ãƒ¡ãƒ©ã®ä½ç½®ï¼‰\nåŒã˜ä¸‰äººç§°ã§ã‚‚é•ã„ãŒå‡ºã‚‹ã€‚\n\nâ‘  ä¸‰äººç§°ãƒ»ä¸»äººå…¬è¦–ç‚¹\nå½¼ã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚ä¸­ã«ã„ã‚‹ã¨ã¯æ€ã£ã¦ã„ãªã‹ã£ãŸã€‚\nâ†’ å…¥ã£ã¦ã„ã‚‹ã®ã¯ã€Œå½¼ã€ã®é ­ã ã‘ã€‚\n\nâ‘¡ ä¸‰äººç§°ãƒ»ç¥è¦–ç‚¹\nå½¼ã¯æ‰‰ã‚’é–‹ã‘ãŸã€‚å½¼å¥³ã¯éœ‡ãˆã¦ã„ãŸã€‚\nâ†’ äºŒäººã®å†…é¢ã«å…¥ã£ã¦ã„ã‚‹ã€‚\n\nâ–  è¶…å˜ç´”ãƒ†ã‚¹ãƒˆ\nã€Œç§ã¯ã€œã€ã«å¤‰ãˆã¦ã‚‚è‡ªç„¶ï¼Ÿ\nâ†’ YESãªã‚‰è¦–ç‚¹ã¯å†…å´å¯„ã‚Š\nâ†’ ã§ã‚‚ä¸»èªãŒã€Œå½¼ã€ãªã‚‰äººç§°ã¯ä¸‰äººç§°\n\nâ–  è¦šãˆæ–¹\näººç§°ï¼ãƒ©ãƒ™ãƒ«ã€€è¦–ç‚¹ï¼ã‚«ãƒ¡ãƒ©ä½ç½®\nãƒ©ãƒ™ãƒ«ã¨ã‚«ãƒ¡ãƒ©ã¯åˆ¥ã€‚',
    tags: ['è¦–ç‚¹', 'äººç§°', 'ä¸‰äººç§°', 'æ¦‚å¿µæ•´ç†'],
    date: '2026-02-22',
    order: 1
  },
  {
    id: 3,
    type: 'ã‚­ãƒ£ãƒ©èªéŒ²',
    title: 'ä¸‡ãƒ»è‘‰ã®è¨€è‘‰',
    body: 'ä¸‡ã€Œè¤‡é›‘ã«è€ƒãˆã‚‹ãªã€‚ç®¡ç†ã™ã‚‹ã®ã¯ã€è¦–ç‚¹äººç‰©ã€Ÿã ã‘ã ã€‚ã€\n\nè‘‰ã€Œè¾æ›¸ã£ã¦ã•ã€ã€å…¨éƒ¨ã¾ã¨ã‚ã‚‹ã€Ÿå ´æ‰€ã˜ã‚ƒãªãã¦ã€ã€è¿·ã£ãŸã¨ãæˆ»ã‚‹å ´æ‰€ã€Ÿã§ã„ã„ã‚“ã ã‚ˆã€‚ã€\n\nè‘‰ã€Œä¸‰äººç§°ã£ã¦ã­ã€ã€å¤–ã‹ã‚‰å‘¼ã‚“ã§ã‚‹ã‘ã©ã€ä¸­ã«ã¯å…¥ã£ã¦ã‚‹ã€ŸçŠ¶æ…‹ãªã‚“ã ã€‚ã€\n\nä¸‡ã€Œå®šç¾©ã‚’åˆ†è§£ã™ã‚‹ã€‚æ„Ÿè¦šã§ã¯ãªãæ§‹é€ ã§ç†è§£ã—ã‚ã€‚ã€\n\nè‘‰ã€Œã”ã¡ã‚ƒã‚‹åŸå› ã¯ã€ã€äººç§°ã€Ÿã¨ã€è¦–ç‚¹ã€Ÿã‚’åŒã˜ç®±ã«å…¥ã‚Œã¦ã‚‹ã‹ã‚‰ã ã‚ˆã€‚ã€',
    tags: ['ä¸‡', 'è‘‰', 'èªéŒ²'],
    date: '2026-02-22',
    order: 2
  },
  {
    id: 4,
    type: 'ç·´ç¿’èª²é¡Œ',
    title: '1æ„Ÿæƒ…ã‚’3é€šã‚Šã§æ›¸ãç·´ç¿’',
    body: 'ãƒ«ãƒ¼ãƒ«ï¼šæ„Ÿæƒ…èªã‚’ä½¿ã‚ãšã€èº«ä½“ãƒ»è¡Œå‹•ãƒ»æƒ…æ™¯ã§æ›¸ãã€‚\n\nä¾‹ï¼šæ‹’çµ¶\nãƒ»è¡€ã®æ°—ãŒå¼•ã\nãƒ»è¶³å…ƒãŒæºã‚Œã‚‹\nãƒ»è¨€è‘‰ãŒå‡ºãªã„\n\nç·´ç¿’ã—ã¦ã¿ã‚ˆã†ï¼š\nã€Œæ‚²ã—ã¿ã€ã€Œæ€’ã‚Šã€ã€Œææ€–ã€ã€Œå–œã³ã€ã€Œå­¤ç‹¬ã€\nãã‚Œãã‚Œ3é€šã‚Šã§æ›¸ã„ã¦ã¿ã‚‹ã€‚',
    tags: ['ç·´ç¿’', 'è¡¨ç¾', 'èº«ä½“æå†™'],
    date: '2026-02-22',
    order: 3
  }
];

// â”€â”€ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â”€â”€
function save() {
  localStorage.setItem('craft_notes_v1', JSON.stringify({ notes, geminiKey, claudeKey, aiProvider }));
}
function load() {
  try {
    const d = JSON.parse(localStorage.getItem('craft_notes_v1') || '{}');
    notes = d.notes && d.notes.length > 0 ? d.notes : JSON.parse(JSON.stringify(INITIAL_NOTES));
    geminiKey = d.geminiKey || '';
    claudeKey = d.claudeKey || '';
    aiProvider = d.aiProvider || 'gemini';
  } catch(e) {
    notes = JSON.parse(JSON.stringify(INITIAL_NOTES));
  }
  updateApiBadge();
  setAiProv(aiProvider);
}

// â”€â”€ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â”€â”€
function typeCls(type) {
  return type === 'ãƒ«ãƒ¼ãƒ«' ? 'type-rule'
    : type === 'æ¦‚å¿µãƒ¡ãƒ¢' ? 'type-concept'
    : type === 'ã‚­ãƒ£ãƒ©èªéŒ²' ? 'type-quote'
    : type === 'ç·´ç¿’èª²é¡Œ' ? 'type-drill'
    : 'type-other';
}

function renderList() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('catFilter').value;
  let filtered = notes
    .slice()
    .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))
    .filter(n => {
      if (cat && n.type !== cat) return false;
      if (activeTagFilter && !(n.tags||[]).includes(activeTagFilter)) return false;
      if (search) {
        const hay = [n.title, n.body, ...(n.tags||[])].join(' ').toLowerCase();
        if (!hay.includes(search)) return false;
      }
      return true;
    });

  const list = document.getElementById('noteList');
  list.innerHTML = filtered.map(n => `
    <div class="note-item ${n.id === currentNoteId ? 'active' : ''}"
      data-id="${n.id}"
      draggable="true"
      onclick="openNote(${n.id})"
      ondragstart="onDragStart(event, ${n.id})"
      ondragover="onDragOver(event)"
      ondrop="onDrop(event, ${n.id})"
      ondragleave="onDragLeave(event)"
      ondragend="onDragEnd(event)">
      <span class="note-item-drag">â ¿</span>
      <div class="note-item-body">
        <div class="note-item-title">${escHtml(n.title)}</div>
        <div class="note-item-meta">
          <span class="note-item-type ${typeCls(n.type)}">${n.type}</span>
          ${(n.tags||[]).slice(0,2).map(t => `<span>#${t}</span>`).join('')}
        </div>
      </div>
      <span class="note-item-del" onclick="event.stopPropagation(); deleteNote(${n.id})">Ã—</span>
    </div>
  `).join('');

  // ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰
  const allTags = [...new Set(notes.flatMap(n => n.tags||[]))].sort();
  const tagBar = document.getElementById('tagBar');
  tagBar.innerHTML = allTags.length === 0 ? '' :
    allTags.map(t =>
      `<span class="tag-chip ${activeTagFilter===t?'active':''}" onclick="toggleTag('${t}')">#${t}</span>`
    ).join('');
}

function openNote(id) {
  if (isDirty && currentNoteId) saveCurrentNote(true);
  currentNoteId = id;
  const n = notes.find(n => n.id === id);
  if (!n) return;
  document.getElementById('editorTitle').value = n.title;
  document.getElementById('editorType').value = n.type;
  document.getElementById('editorTags').value = (n.tags||[]).join(' ');
  document.getElementById('editorBody').value = n.body || '';
  document.getElementById('noteEditor').style.display = 'flex';
  document.getElementById('emptyPane').style.display = 'none';
  isDirty = false;
  document.getElementById('saveBtn').textContent = 'ä¿å­˜';
  document.getElementById('saveBtn').classList.remove('saved');
  renderList();
}

function markDirty() {
  isDirty = true;
  document.getElementById('saveBtn').textContent = 'â— ä¿å­˜';
  document.getElementById('saveBtn').classList.remove('saved');
}

function autoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => { if (isDirty) saveCurrentNote(true); }, 2000);
}

function saveCurrentNote(silent = false) {
  if (!currentNoteId) return;
  const n = notes.find(n => n.id === currentNoteId);
  if (!n) return;
  n.title = document.getElementById('editorTitle').value.trim() || 'ï¼ˆç„¡é¡Œï¼‰';
  n.type = document.getElementById('editorType').value;
  n.tags = document.getElementById('editorTags').value.trim().split(/\s+/).filter(Boolean);
  n.body = document.getElementById('editorBody').value;
  n.date = new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'});
  isDirty = false;
  save();
  renderList();
  if (!silent) {
    const btn = document.getElementById('saveBtn');
    btn.textContent = 'âœ“ ä¿å­˜æ¸ˆã¿';
    btn.classList.add('saved');
    setTimeout(() => { btn.textContent = 'ä¿å­˜'; btn.classList.remove('saved'); }, 2000);
    showToast();
  }
}

// â”€â”€ è¿½åŠ ãƒ»å‰Šé™¤ â”€â”€
function showAddModal() {
  document.getElementById('addTitle').value = '';
  document.getElementById('addBody').value = '';
  document.getElementById('addTags').value = '';
  document.getElementById('addModal').classList.add('show');
  setTimeout(() => document.getElementById('addTitle').focus(), 50);
}
function closeAddModal() { document.getElementById('addModal').classList.remove('show'); }

function setAddType(btn) {
  document.querySelectorAll('#addTypeTrack .add-type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentAddType = btn.dataset.type;
}

function addNote() {
  const title = document.getElementById('addTitle').value.trim();
  const body = document.getElementById('addBody').value.trim();
  if (!title && !body) return;
  const tags = document.getElementById('addTags').value.trim().split(/\s+/).filter(Boolean);
  const n = {
    id: Date.now(),
    type: currentAddType,
    title: title || 'ï¼ˆç„¡é¡Œï¼‰',
    body,
    tags,
    date: new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'}),
    order: -1
  };
  // orderã‚’å†å‰²ã‚Šå½“ã¦
  notes.forEach(x => x.order = (x.order ?? 0) + 1);
  n.order = 0;
  notes.unshift(n);
  save();
  closeAddModal();
  renderList();
  openNote(n.id);
}

function deleteNote(id) {
  if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  notes = notes.filter(n => n.id !== id);
  if (currentNoteId === id) {
    currentNoteId = null;
    document.getElementById('noteEditor').style.display = 'none';
    document.getElementById('emptyPane').style.display = 'flex';
  }
  save();
  renderList();
}

// â”€â”€ ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆ â”€â”€
let dragId = null;
function onDragStart(e, id) { dragId = id; e.target.classList.add('dragging'); }
function onDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function onDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); }
function onDrop(e, targetId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (dragId === targetId) return;
  const srcIdx = notes.findIndex(n => n.id === dragId);
  const tgtIdx = notes.findIndex(n => n.id === targetId);
  if (srcIdx < 0 || tgtIdx < 0) return;
  const [moved] = notes.splice(srcIdx, 1);
  notes.splice(tgtIdx, 0, moved);
  notes.forEach((n, i) => n.order = i);
  dragId = null;
  save();
  renderList();
}

// â”€â”€ ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ â”€â”€
function toggleTag(tag) {
  activeTagFilter = activeTagFilter === tag ? '' : tag;
  renderList();
}

// â”€â”€ AIè³ªå• â”€â”€
let aiCollapsed = false;
function toggleAi() {
  aiCollapsed = !aiCollapsed;
  document.getElementById('aiPane').classList.toggle('collapsed', aiCollapsed);
}

function setAiProv(prov) {
  aiProvider = prov;
  document.getElementById('provGemini').classList.toggle('active', prov === 'gemini');
  document.getElementById('provClaude').classList.toggle('active', prov === 'claude');
  document.getElementById('aiProvLabel').textContent = prov === 'gemini' ? 'Gemini Flash' : 'Claude Sonnet';
  save();
}

async function askAI() {
  const q = document.getElementById('aiQuestion').value.trim();
  if (!q) return;
  const key = aiProvider === 'gemini' ? geminiKey : claudeKey;
  if (!key) { showApiModal(); return; }

  const btn = document.getElementById('askBtn');
  const answerEl = document.getElementById('aiAnswer');
  btn.disabled = true;
  answerEl.innerHTML = '<span class="ai-spinner"></span> å›ç­”ã‚’ç”Ÿæˆä¸­â€¦';
  document.getElementById('aiAnswerActions').style.display = 'none';

  // ãƒãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸¡ã™ï¼ˆç¾åœ¨ã®ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°ï¼‰
  const ctx = currentNoteId
    ? (() => { const n = notes.find(x => x.id === currentNoteId); return n ? `\n\nå‚è€ƒãƒãƒ¼ãƒˆã€Œ${n.title}ã€:\n${(n.body||'').slice(0,300)}` : ''; })()
    : '';

  const systemPrompt = 'å‰µä½œã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã€‚æ—¥æœ¬èª200å­—ä»¥å†…ã§å®Ÿè·µçš„ã«ç­”ãˆã‚‹ã€‚' + (ctx ? ctx.slice(0, 150) : '');

  try {
    let answer = '';
    if (aiProvider === 'gemini') {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: systemPrompt + '\nè³ªå•ï¼š' + q }] }],
          generationConfig: { maxOutputTokens: 512, temperature: 0.7 }
        })
      });
      const d = await res.json();
      if (!res.ok) throw new Error(d.error?.message || 'Gemini APIã‚¨ãƒ©ãƒ¼');
      answer = d.candidates?.[0]?.content?.parts?.[0]?.text || '';
    } else {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': key,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 512,
          system: systemPrompt,
          messages: [{ role: 'user', content: q }]
        })
      });
      const d = await res.json();
      if (!res.ok) throw new Error(d.error?.message || 'Claude APIã‚¨ãƒ©ãƒ¼');
      answer = d.content?.[0]?.text || '';
    }
    answerEl.textContent = answer;
    document.getElementById('aiAnswerActions').style.display = 'flex';
  } catch(e) {
    answerEl.innerHTML = `<span style="color:var(--accent)">ã‚¨ãƒ©ãƒ¼: ${e.message}</span>`;
  } finally {
    btn.disabled = false;
  }
}

function copyAiAnswer() {
  const text = document.getElementById('aiAnswer').textContent;
  if (navigator.clipboard) navigator.clipboard.writeText(text);
}

function saveAiAsNote() {
  const q = document.getElementById('aiQuestion').value.trim();
  const a = document.getElementById('aiAnswer').textContent;
  if (!a) return;
  const body = `â–  è³ªå•\n${q}\n\nâ–  AIå›ç­”\n${a}`;
  // è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
  document.getElementById('addTitle').value = q.slice(0, 30) || 'AIã¨ã®è³ªå•ãƒ¡ãƒ¢';
  document.getElementById('addBody').value = body;
  document.getElementById('addTags').value = 'AIå›ç­”';
  // ç¨®åˆ¥ã‚’æ¦‚å¿µãƒ¡ãƒ¢ã«
  document.querySelectorAll('#addTypeTrack .add-type-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.type === 'æ¦‚å¿µãƒ¡ãƒ¢');
  });
  currentAddType = 'æ¦‚å¿µãƒ¡ãƒ¢';
  document.getElementById('addModal').classList.add('show');
}

// â”€â”€ APIè¨­å®š â”€â”€
function showApiModal() {
  if (geminiKey) document.getElementById('geminiKeyInput').value = geminiKey;
  if (claudeKey) document.getElementById('claudeKeyInput').value = claudeKey;
  document.getElementById('apiModal').classList.add('show');
}
function closeApiModal() { document.getElementById('apiModal').classList.remove('show'); }

function saveApiKeys() {
  const gk = document.getElementById('geminiKeyInput').value.trim();
  const ck = document.getElementById('claudeKeyInput').value.trim();
  if (gk) { geminiKey = gk; document.getElementById('geminiStatus').textContent = 'âœ“ ä¿å­˜'; }
  if (ck) { claudeKey = ck; document.getElementById('claudeStatus').textContent = 'âœ“ ä¿å­˜'; }
  updateApiBadge();
  save();
  setTimeout(closeApiModal, 600);
}

function updateApiBadge() {
  const badge = document.getElementById('apiBadge');
  const hasKey = geminiKey || claudeKey;
  badge.textContent = hasKey ? (geminiKey && claudeKey ? 'APIè¨­å®šæ¸ˆã¿ Ã—2' : 'APIè¨­å®šæ¸ˆã¿') : 'APIæœªè¨­å®š';
  badge.style.color = hasKey ? 'rgba(200,255,200,0.8)' : 'rgba(255,200,200,0.7)';
}

// â”€â”€ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« â”€â”€
function scrollTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
const editorBody = document.getElementById('editorBody');
editorBody.addEventListener('scroll', () => {
  const btn = document.getElementById('scrollTopBtn');
  btn.classList.toggle('visible', editorBody.scrollTop > 200);
});
document.getElementById('scrollTopBtn').addEventListener('click', () => {
  editorBody.scrollTo({ top: 0, behavior: 'smooth' });
});

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€
function escHtml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function showToast() {
  const t = document.getElementById('savedToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1500);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('apiModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeApiModal(); });
document.getElementById('addModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddModal(); });

// Ctrl+Sã§ä¿å­˜
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveCurrentNote(); }
});

// â”€â”€ åˆæœŸåŒ– â”€â”€
load();
renderList();
// æœ€åˆã®ãƒãƒ¼ãƒˆã‚’é–‹ã
if (notes.length > 0) {
  const sorted = notes.slice().sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
  openNote(sorted[0].id);
}
</script>
</body>
</html>
